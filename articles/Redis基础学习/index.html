<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="sBEHKTtAGOsW8CzuLFLKzJIeSgj5S3G_6Jhlltsm76k">
  <meta name="baidu-site-verification" content="code-2EuuuTEL7g">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"heavytiger.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":18,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Redis是一个开源，高级的键值存储和一个适用的解决方案，用于构建高性能，可扩展的Web应用程序。 Redis有三个主要特点，使它优越于其它键值数据存储系统：  Redis将其数据库完全保存在内存中，仅使用磁盘进行持久化。 与其它键值数据存储相比，Redis有一组相对丰富的数据类型。 Redis可以将数据复制到任意数量的从机中。">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis基础学习">
<meta property="og:url" content="https://heavytiger.github.io/articles/Redis%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/index.html">
<meta property="og:site_name" content="HeavyTiger&#39;s Blogs">
<meta property="og:description" content="Redis是一个开源，高级的键值存储和一个适用的解决方案，用于构建高性能，可扩展的Web应用程序。 Redis有三个主要特点，使它优越于其它键值数据存储系统：  Redis将其数据库完全保存在内存中，仅使用磁盘进行持久化。 与其它键值数据存储相比，Redis有一组相对丰富的数据类型。 Redis可以将数据复制到任意数量的从机中。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://heavytiger.github.io/articles/Redis%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/1920px-Skip_list.svg.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/Redis%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/image-20220126151622002.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/Redis%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/SLELOGN.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/Redis%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/7V1X.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/Redis%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/image-20220127164809897.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/Redis%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/image-20220127165228796.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/Redis%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/image-20220127165321307.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/Redis%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/image-20220127212236873.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/Redis%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/image-20220127212311020.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/Redis%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/image-20220129164417936.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/Redis%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/image-20220130111620706.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/Redis%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/image-20220201214014677.png">
<meta property="article:published_time" content="2022-01-20T06:58:48.000Z">
<meta property="article:modified_time" content="2022-02-11T08:01:23.000Z">
<meta property="article:author" content="喵式重战">
<meta property="article:tag" content="Redis">
<meta property="article:tag" content="NoSQL">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://heavytiger.github.io/articles/Redis%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/1920px-Skip_list.svg.png">

<link rel="canonical" href="https://heavytiger.github.io/articles/Redis%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Redis基础学习 | HeavyTiger's Blogs</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
   <!--动态线条背景-->
    <script type="text/javascript"color="220,220,220" opacity='0.7' zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
   
   <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">HeavyTiger's Blogs</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">逆水行舟</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/HeavyTiger" class="github-corner" title="喵喵喵~~~" aria-label="喵喵喵~~~" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

    
    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://heavytiger.github.io/articles/Redis%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="喵式重战">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HeavyTiger's Blogs">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Redis基础学习
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-01-20 14:58:48" itemprop="dateCreated datePublished" datetime="2022-01-20T14:58:48+08:00">2022-01-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-02-11 16:01:23" itemprop="dateModified" datetime="2022-02-11T16:01:23+08:00">2022-02-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index"><span itemprop="name">数据库学习</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>74k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:07</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <!--此处为希望博客在首页显示的内容-->

<p>Redis是一个开源，高级的键值存储和一个适用的解决方案，用于构建高性能，可扩展的Web应用程序。</p>
<p>Redis有三个主要特点，使它优越于其它键值数据存储系统：</p>
<ul>
<li>Redis将其数据库完全保存在内存中，仅使用磁盘进行持久化。</li>
<li>与其它键值数据存储相比，Redis有一组相对丰富的数据类型。</li>
<li>Redis可以将数据复制到任意数量的从机中。</li>
</ul>
<span id="more"></span>
<!-- markdownlint-disable MD041 MD002-->

<h2 id="Redis的简介"><a href="#Redis的简介" class="headerlink" title="Redis的简介"></a>Redis的简介</h2><h3 id="Redis的优点"><a href="#Redis的优点" class="headerlink" title="Redis的优点"></a>Redis的优点</h3><ul>
<li><p><strong>异常快</strong> - Redis非常快，每秒可执行大约<code>81000</code>次的写/设置(<code>SET</code>)操作，每秒大约可执行<code>110000</code>次的读取/获取(<code>GET</code>)操作。</p>
</li>
<li><p><strong>支持丰富的数据类型</strong> - Redis支持开发人员常用的大多数数据类型，例如列表，集合，排序集和散列等等。这使得Redis很容易被用来解决各种问题，因为我们知道哪些问题可以更好使用地哪些数据类型来处理解决。</p>
</li>
<li><p><strong>操作具有原子性</strong> - 所有Redis操作都是原子操作，这确保如果两个客户端并发访问，Redis服务器能接收更新的值。</p>
</li>
<li><p><strong>多实用工具</strong> - Redis是一个多实用工具，可用于多种用例，如：缓存，消息队列(Redis本地支持发布/订阅)，应用程序中的任何短期数据，例如，web应用程序中的会话，网页命中计数等。</p>
</li>
</ul>
<h3 id="Redis与其他的键值数据库"><a href="#Redis与其他的键值数据库" class="headerlink" title="Redis与其他的键值数据库"></a>Redis与其他的键值数据库</h3><ul>
<li><p>Redis是键值数据库系统的不同进化路线，它的值可以包含更复杂的数据类型，可在这些数据类型上定义原子操作。</p>
</li>
<li><p>Redis是一个内存数据库，但在磁盘数据库上是持久的，因此它代表了一个不同的权衡，在这种情况下，在不能大于存储器(内存)的数据集的限制下实现非常高的写和读速度。</p>
</li>
<li><p>内存数据库的另一个优点是，它与磁盘上的相同数据结构相比，复杂数据结构在内存中存储表示更容易操作。 因此，Redis可以做很少的内部复杂性。</p>
</li>
</ul>
<h2 id="Redis的安装"><a href="#Redis的安装" class="headerlink" title="Redis的安装"></a>Redis的安装</h2><ol>
<li><p>在<code>linux</code>的<code>/usr/local/</code>路径下，使用如下命令下载<code>tar</code>包至当前目录下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://download.redis.io/releases/redis-6.2.6.tar.gz</span><br></pre></td></tr></table></figure></li>
<li><p>使用如下命令对当前<code>tar</code>包进行解压</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar -zvxf ./redis-6.2.6.tar.gz</span><br></pre></td></tr></table></figure></li>
<li><p>进入解压后的文件夹中，输入<code>make</code>命令进行编译</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ./redis-6.2.6/</span><br><span class="line">make</span><br></pre></td></tr></table></figure></li>
<li><p>等待大概1min后编译完成，输入命令<code>make install</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make install</span><br></pre></td></tr></table></figure></li>
<li><p>默认会在<code>/usr/local/bin/</code>目录下安装好</p>
</li>
<li><p>前台启动（不推荐）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 输入redis-server简单启动</span></span><br><span class="line">redis-server</span><br><span class="line"><span class="meta">#</span><span class="bash"> 当前对CentOS的连接关闭后，服务自动结束，按下ctrl + c手动关闭</span></span><br></pre></td></tr></table></figure></li>
<li><p>后台启动（推荐，需要配置守护进程）</p>
<ol>
<li><p>使用<code>cp</code>命令备份一份<code>/usr/local/redis-6.2.6/redis.conf</code>至<code>/etc/redis.conf</code>路径下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/redis-6.2.6/redis.conf /etc/redis.conf</span><br></pre></td></tr></table></figure></li>
<li><p>修改<code>/etc/redis.conf</code>中的<code>daemonize no</code>为<code>daemonize yes</code>输入<code>/daemonize</code>可以进行查找</p>
</li>
<li><p>使用如下命令启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-server /etc/redis.conf</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li><p>连接到Redis，输入如下命令，端口默认为6379</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 连接到后台的Redis进程</span></span><br><span class="line">redis-cli</span><br><span class="line"><span class="meta">#</span><span class="bash"> 输入ping后若已连接会输出PONG</span></span><br><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br></pre></td></tr></table></figure></li>
<li><p>停止Redis服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 方法1：输入shutdown后，连接断开；输入<span class="built_in">exit</span>后退出连接程序</span></span><br><span class="line">127.0.0.1:6379&gt; shutdown</span><br><span class="line">not connected&gt; exit</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 方法2：</span></span><br><span class="line">127.0.0.1:6379&gt; exit</span><br><span class="line"></span><br><span class="line">[root@CentOS local]# ps -ef | grep redis</span><br><span class="line">root      492087       1  0 14:41 ?        00:00:00 redis-server 127.0.0.1:6379</span><br><span class="line">root      492095  482950  0 14:42 pts/0    00:00:00 grep --color=auto redis</span><br><span class="line"></span><br><span class="line">[root@CentOS local]# ps -ef | grep redis</span><br><span class="line">root      492087       1  0 14:41 ?        00:00:00 redis-server 127.0.0.1:6379</span><br><span class="line">root      492095  482950  0 14:42 pts/0    00:00:00 grep --color=auto redis</span><br><span class="line"></span><br><span class="line">[root@CentOS local]# redis-cli</span><br><span class="line">Could not connect to Redis at 127.0.0.1:6379: Connection refused</span><br><span class="line">not connected&gt; exit</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="相关知识点说明"><a href="#相关知识点说明" class="headerlink" title="相关知识点说明"></a>相关知识点说明</h3><ol>
<li> 默认使用<code>6379</code>端口，原因如下：</li>
</ol>
<blockquote>
<p><code>6379</code>在是9键输入手机按键上<code>MERZ</code>对应的号码，而MERZ取自意大利歌女Alessia Merz的名字。MERZ长期以来被Redis作者antirez及其朋友当作愚蠢的代名词。后来Redis作者在开发Redis时就选用了这个端口。</p>
</blockquote>
<ol start="2">
<li><p>Redis默认有16个数据库，类似数组下标从0开始，默认使用0号库</p>
<p>使用命令<code>select &lt;dbid&gt;</code>来切换数据库，例如使用9号数据库: <code>select 8</code></p>
</li>
<li><p>密码统一管理，所有库的密码相同</p>
</li>
<li><p>Redis使用<strong>单线程 + 多路IO复用</strong>技术，可以体现出多线程的效果，且效效率最好</p>
<p>类似于很多人找黄牛买火车票，很多人同时在发起请求，即<strong>多路IO复用</strong>，但是黄牛买票是<strong>单线程</strong>操作，若能处理即提供票，则直接响应请求，若不能也不会阻塞，会继续处理其他人的请求，保证CPU一直在工作</p>
</li>
</ol>
<h2 id="Redis的五大基本数据类型"><a href="#Redis的五大基本数据类型" class="headerlink" title="Redis的五大基本数据类型"></a>Redis的五大基本数据类型</h2><h3 id="键的基本操作"><a href="#键的基本操作" class="headerlink" title="键的基本操作"></a>键的基本操作</h3><h4 id="查看当前库中的所有的Key"><a href="#查看当前库中的所有的Key" class="headerlink" title="查看当前库中的所有的Key"></a>查看当前库中的所有的Key</h4><p><strong>使用语句：</strong><code>KEYS *</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">(empty array)</span><br><span class="line">127.0.0.1:6379&gt; SET k1 Tom</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; SET k2 Jerry</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; SET k3 Lily</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">1) &quot;k2&quot;</span><br><span class="line">2) &quot;k1&quot;</span><br><span class="line">3) &quot;k3&quot;</span><br></pre></td></tr></table></figure>

<h4 id="判断某个Key是否存在"><a href="#判断某个Key是否存在" class="headerlink" title="判断某个Key是否存在"></a>判断某个Key是否存在</h4><p><strong>使用语句：</strong><code>EXISTS &lt;key&gt;</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; EXISTS k1</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; EXISTS k2</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; EXISTS k4</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure>

<h4 id="查看Key是什么类型"><a href="#查看Key是什么类型" class="headerlink" title="查看Key是什么类型"></a>查看Key是什么类型</h4><p><strong>使用语句：</strong><code>TYPE &lt;key&gt;</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; TYPE k1</span><br><span class="line">string</span><br><span class="line">127.0.0.1:6379&gt; TYPE k4</span><br><span class="line">none</span><br></pre></td></tr></table></figure>

<h4 id="删除指定的Key数据"><a href="#删除指定的Key数据" class="headerlink" title="删除指定的Key数据"></a>删除指定的Key数据</h4><p><strong>方法一：</strong></p>
<p><strong>使用语句：</strong><code>DEL &lt;key&gt;</code> 直接删除</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; DEL k3</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">1) &quot;k2&quot;</span><br><span class="line">2) &quot;k1&quot;</span><br></pre></td></tr></table></figure>

<p><strong>方法二：</strong></p>
<p><strong>使用语句：</strong><code>UNLINK &lt;key&gt;</code> 选择非阻塞删除</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; UNLINK k3</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">1) &quot;k2&quot;</span><br><span class="line">2) &quot;k1&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>区别：</strong></p>
<p>使用<code>DEL key</code>直接删除数据，选择<code>UNLINK key</code>将根据<code>value</code>选择非阻塞删除：仅将<code>keys</code>从<code>keyspace</code>元数据中删除，真正的删除会在后续的异步操作 </p>
</blockquote>
<h4 id="设置与查看过期状态"><a href="#设置与查看过期状态" class="headerlink" title="设置与查看过期状态"></a>设置与查看过期状态</h4><p><strong>使用语句：</strong><code>EXPIRE &lt;key&gt; &lt;sec&gt;</code> 设置多少秒后键值对过期</p>
<p><strong>使用语句：</strong><code>TTL &lt;key&gt;</code> 查看还有多少秒过期，**-1<strong>表示永不过期，</strong>-2**表示已经过期(即已被清除，<code>TTL</code>未<code>SET</code>的键也得到<code>-1</code>)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; TTL k1</span><br><span class="line">(integer) -1</span><br><span class="line">127.0.0.1:6379&gt; EXPIRE k1 20</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; TTL k1</span><br><span class="line">(integer) 16</span><br><span class="line">127.0.0.1:6379&gt; TTL k1</span><br><span class="line">(integer) 13</span><br><span class="line">127.0.0.1:6379&gt; TTL k1</span><br><span class="line">(integer) 8</span><br><span class="line">127.0.0.1:6379&gt; TTL k1</span><br><span class="line">(integer) -2</span><br><span class="line">127.0.0.1:6379&gt; TTL k5</span><br><span class="line">(integer) -2</span><br><span class="line">127.0.0.1:6379&gt; KEYS *</span><br><span class="line">1) &quot;k2&quot;</span><br></pre></td></tr></table></figure>

<h4 id="其他命令"><a href="#其他命令" class="headerlink" title="其他命令"></a>其他命令</h4><p><strong>使用语句：</strong><code>DUMP &lt;key&gt;</code> 返回存储在指定键的值的序列化版本</p>
<p><strong>使用语句：</strong><code>EXPIREAT &lt;key&gt; &lt;timestamp&gt;</code> 设置在指定时间戳之后键到期/过期，这里的时间是Unix时间戳格式</p>
<p><strong>使用语句：</strong><code>PEXPIRE &lt;key&gt; &lt;milliseconds&gt;</code> 设置键的到期时间(以毫秒为单位)</p>
<p><strong>使用语句：</strong><code>PEXPIREAT &lt;key&gt; &lt;milliseconds-timestamp&gt;</code> 以Unix时间戳形式来设置键的到期时间(以毫秒为单位)</p>
<p><strong>使用语句：</strong><code>KEYS &lt;pattern&gt;</code> 查找与指定模式匹配的所有键</p>
<p><strong>使用语句：</strong><code>MOVE &lt;key&gt; &lt;dbid&gt;</code> 将键移动到另一个数据库</p>
<p><strong>使用语句：</strong><code>PERSIST &lt;key&gt;</code> 删除指定键的过期时间，得永生</p>
<p><strong>使用语句：</strong><code>RANDOMKEY</code> 从Redis返回一个随机的键</p>
<p><strong>使用语句：</strong><code>RENAME &lt;key&gt; &lt;newkey&gt;</code> 更改键的名称</p>
<p><strong>使用语句：</strong><code>RENAMENX &lt;key&gt; &lt;newkey&gt;</code> 如果新键不存在，重命名键</p>
<p><strong>使用语句：</strong><code>PTTL &lt;key&gt;</code> 获取键到期的剩余时间(以毫秒为单位)。</p>
<p><strong>使用语句：</strong><code>SELECT &lt;dbid&gt;</code> 切换数据库，默认16个库，默认选择0数据库</p>
<p><strong>使用语句：</strong><code>DBSIZE</code> 查看当前数据库中key的数量</p>
<p><strong>使用语句：</strong><code>FLUSHDB</code> 清空当前数据库中的数据</p>
<p><strong>使用语句：</strong><code>FLUSHALL</code> 清空所有数据库中的数据</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; DBSIZE</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; SELECT 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[1]&gt; DBSIZE</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379[1]&gt; FLUSHALL</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379[1]&gt; SELECT 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; DBSIZE</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure>

<h3 id="字符串-String"><a href="#字符串-String" class="headerlink" title="字符串(String)"></a>字符串(String)</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><ul>
<li><strong>String</strong>是Redis最基本的类型，一个key对应一个value</li>
<li><strong>String</strong>是<strong>二进制安全</strong>的，意味着Redis的String可以包含任何数据，比如jpg图片，序列化的对象</li>
<li><strong>String</strong>是最基本的数据类型，一个Redis中的字符串value最大可以为<strong>512M</strong></li>
</ul>
<h4 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h4><h5 id="SET命令"><a href="#SET命令" class="headerlink" title="SET命令"></a>SET命令</h5><p><strong>SET</strong>命令用于在Redis键中设置一些字符串值</p>
<p><strong>返回值：</strong>若在键中设置了值，返回<code>OK</code>，否则返回<code>Null</code></p>
<p><strong>基本语法：</strong><code>SET KEY VALUE [EX seconds] [PX milliseconds] [NX|XX]</code></p>
<ul>
<li><code>EX seconds</code> − 设置指定的到期时间(以秒为单位)。</li>
<li><code>PX milliseconds</code> - 设置指定的到期时间(以毫秒为单位)。</li>
<li><code>NX</code> - 仅在键不存在时设置键。</li>
<li><code>XX</code> - 只有在键已存在时才设置。</li>
</ul>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 表示设置key1为字符串redis，在60s后到期，仅在键不存在时设置</span></span><br><span class="line">127.0.0.1:6379&gt; SET key1 &quot;redis&quot; EX 60 NX</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>SETNX</code>，<code>SETEX</code>可以直接达成相应的功能：<code>SETEX key seconds value</code>，<code>SETNX key value</code></p>
</blockquote>
<h5 id="GET命令"><a href="#GET命令" class="headerlink" title="GET命令"></a>GET命令</h5><p><strong>GET</strong>命令用于获取存储在指定键中的值</p>
<p><strong>返回值：</strong>若在键中设置了值，返回<code>字符串值</code>，否则返回<code>nil</code></p>
<p><strong>基本语法：</strong><code>GET KEY </code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GET k1</span><br><span class="line">&quot;redis&quot;</span><br><span class="line">127.0.0.1:6379&gt; GET k2</span><br><span class="line">&quot;Null&quot;</span><br><span class="line">127.0.0.1:6379&gt; GET k4</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure>

<h5 id="APPEND命令"><a href="#APPEND命令" class="headerlink" title="APPEND命令"></a>APPEND命令</h5><p><strong>APPEND</strong>命令用于在当前键的值末尾添加一些值</p>
<p><strong>返回值：</strong>返回一个整数，即追加操作后的字符串的长度。</p>
<p><strong>基本语法：</strong><code>APPEND KEY_NAME APPEND_VALUE </code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; APPEND k1 &quot; hello world&quot;</span><br><span class="line">(integer) 17</span><br><span class="line">127.0.0.1:6379&gt; GET k1</span><br><span class="line">&quot;redis hello world&quot;</span><br></pre></td></tr></table></figure>

<h5 id="STRLEN命令"><a href="#STRLEN命令" class="headerlink" title="STRLEN命令"></a>STRLEN命令</h5><p><strong>STRLEN</strong>命令用于获取存储在键中的字符串值的长度。</p>
<p><strong>返回值：</strong>返回在键中的值的字符串长度，或当键不存在时返回<code>0</code></p>
<p><strong>基本语法：</strong><code>STRLEN KEY_NAME </code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; STRLEN k1</span><br><span class="line">(integer) 17</span><br><span class="line">127.0.0.1:6379&gt; STRLEN k2</span><br><span class="line">(integer) 4</span><br><span class="line">127.0.0.1:6379&gt; STRLEN k3</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure>

<h5 id="INCR命令"><a href="#INCR命令" class="headerlink" title="INCR命令"></a>INCR命令</h5><p>INCR命令用于将键的整数值递增<code>1</code>。如果键不存在，则在执行操作之前将其设置为<code>0</code>。 如果键包含错误类型的值或包含无法表示为整数的字符串，则会返回错误。此操作限于<code>64</code>位有符号整数。</p>
<p><strong>返回值：</strong>返回一个整数，增加后键的值。</p>
<p><strong>基本语法：</strong><code>INCR KEY_NAME </code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SET k3 100</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; GET k3</span><br><span class="line">&quot;100&quot;</span><br><span class="line">127.0.0.1:6379&gt; INCR k3</span><br><span class="line">(integer) 101</span><br><span class="line">127.0.0.1:6379&gt; GET k3</span><br><span class="line">&quot;101&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>INCR和DECR命令都是原子命令，因为Redis底层使用单线程，因此在一个线程执行时不会被另一个线程打断，最终不可能产生数据不同步的情况</p>
<p>但是在JAVA中的i++命令不是，若两个线程同时执行100次i++，因为i++语句可以分解成取值，加1，存值的流程，因此最终得到的i的值在2-200之间</p>
</blockquote>
<h5 id="DECR命令"><a href="#DECR命令" class="headerlink" title="DECR命令"></a>DECR命令</h5><p><strong>DECR</strong>命令用于将键的整数值减<code>1</code>。 如果键不存在，则在执行操作之前将其设置为<code>0</code>。 如果键包含错误类型的值或包含无法表示为整数的字符串，则会返回错误。 此操作限于<code>64</code>位有符号整数。</p>
<p><strong>返回值：</strong>返回一个整数，递减后键的值。</p>
<p><strong>基本语法：</strong><code>DECR KEY_NAME </code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; DECR k3</span><br><span class="line">(integer) 100</span><br><span class="line">127.0.0.1:6379&gt; GET k3</span><br><span class="line">&quot;100&quot;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>INCRBY KEY_NAME STEP</code>: 按照STEP步数自增，如<code>INCRBY key 10</code></p>
<p><code>DECRBY KEY_NAME STEP</code>: 按照STEP步数自减，如<code>DECRBY key 10</code></p>
</blockquote>
<h5 id="MSET命令"><a href="#MSET命令" class="headerlink" title="MSET命令"></a>MSET命令</h5><p><strong>MSET</strong>命令用于一次多个键设置它们的值。</p>
<p><strong>返回值：</strong>返回字符串 - <code>OK</code></p>
<p><strong>基本语法：</strong><code>MSET key1 value1 key2 value2 .. keyN valueN</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; MSET k4 v4 k5 v5 k6 v6</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>MSETNX</code>当且仅当所有的key都不存在时，设置一个或多个key-value对，<strong>原子性，有一个失效，则所有的都失效</strong></p>
</blockquote>
<h5 id="MGET命令"><a href="#MGET命令" class="headerlink" title="MGET命令"></a>MGET命令</h5><p><strong>MGET</strong>命令用于获取所有指定键的值。</p>
<p><strong>返回值：</strong>返回数组，指定键的值列表。对于不包含字符串值或不存在的每个键，返回特殊值<code>nil</code></p>
<p><strong>基本语法：</strong><code>MGET key1 key2 .. keyN</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; MGET k1 k2 k3 k4 k10</span><br><span class="line">1) &quot;redis hello world&quot;</span><br><span class="line">2) &quot;Null&quot;</span><br><span class="line">3) &quot;100&quot;</span><br><span class="line">4) &quot;v4&quot;</span><br><span class="line">5) (nil)</span><br></pre></td></tr></table></figure>

<h5 id="GETRANGE命令"><a href="#GETRANGE命令" class="headerlink" title="GETRANGE命令"></a>GETRANGE命令</h5><p><strong>GETRANGE</strong>命令用于获取存储在键的字符串值的子字符串，由偏移量的开始和结束(左闭右闭)确定，可以使用负偏移，以便从字符串的末尾开始计算偏移。</p>
<p><strong>返回值：</strong>返回数组，指定键的值列表。对于不包含字符串值或不存在的每个键，返回特殊值<code>nil</code></p>
<p><strong>基本语法：</strong><code>GETRANGE KEY_NAME start end</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; GETRANGE k1 1 4</span><br><span class="line">&quot;edis&quot;</span><br></pre></td></tr></table></figure>

<h5 id="SETRANGE命令"><a href="#SETRANGE命令" class="headerlink" title="SETRANGE命令"></a>SETRANGE命令</h5><p><strong>SETRANGE</strong>命令用于覆盖键的值，从指定偏移处开始的一部分字符串。</p>
<p><strong>返回值：</strong>返回整数，字符串在修改后的长度。</p>
<p><strong>基本语法：</strong><code>SETRANGE KEY_NAME OFFSET VALUE</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SETRANGE k1 0 REDIS</span><br><span class="line">(integer) 17</span><br><span class="line">127.0.0.1:6379&gt; GET k1</span><br><span class="line">&quot;REDIS hello world&quot;</span><br></pre></td></tr></table></figure>

<h4 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h4><ul>
<li>底层结构是简单的动态字符串，是可以用来修改的字符串，内部实现类似于<code>java</code>中的<code>ArrayList</code>，采用预分配冗余空间的形式来减少内存的频繁分配</li>
<li><code>String</code>中为当前字符串分配的空间<code>capacity</code>一般要高于字符串实际的长度<code>len</code>，当字符串长度小于<code>1M</code>时，扩容均为加倍现有的空间，若高于<code>1M</code>，扩容一次多扩<code>1M</code>的空间，需要注意的是，字符串最大的长度为<code>512M</code></li>
</ul>
<h3 id="列表-List"><a href="#列表-List" class="headerlink" title="列表(List)"></a>列表(List)</h3><h4 id="简介-1"><a href="#简介-1" class="headerlink" title="简介"></a>简介</h4><p>Redis列表是简单的字符串列表，按照插入顺序排序，你可以添加一个元素到列表的头部，或者列表的尾部，它的底层实现是一个双向链表，对两端的操作性能非常高，通过索引下标操作中间结点的性能会较差</p>
<h4 id="常用命令-1"><a href="#常用命令-1" class="headerlink" title="常用命令"></a>常用命令</h4><h5 id="LPUSH-RPUSH命令"><a href="#LPUSH-RPUSH命令" class="headerlink" title="LPUSH/RPUSH命令"></a>LPUSH/RPUSH命令</h5><p><strong>LPUSH</strong>命令用于在key列表的头部按照从左至右的顺序插入所有指定的值</p>
<p><strong>RPUSH</strong>命令用于在key列表的尾部按照从左至右的顺序插入所有指定的值</p>
<p><strong>返回值：</strong>返回整数，推送操作后列表的长度。</p>
<p><strong>基本语法：</strong><code>LPUSH KEY_NAME VALUE1.. VALUEN</code> / <code>RPUSH KEY_NAME VALUE1.. VALUEN</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 可以看到头插法插入查看结果等于将其倒序</span></span><br><span class="line">127.0.0.1:6379&gt; LPUSH list1 7 &quot;hello&quot; 5 &quot;world&quot;</span><br><span class="line">(integer) 4</span><br><span class="line">127.0.0.1:6379&gt; LRANGE list1 0 -1</span><br><span class="line">1) &quot;world&quot;</span><br><span class="line">2) &quot;5&quot;</span><br><span class="line">3) &quot;hello&quot;</span><br><span class="line">4) &quot;7&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到尾插法插入查看结果为正序</span></span><br><span class="line">127.0.0.1:6379&gt; RPUSH list1 2 3 4 5</span><br><span class="line">(integer) 8</span><br><span class="line">127.0.0.1:6379&gt; LRANGE list1 0 -1</span><br><span class="line">1) &quot;world&quot;</span><br><span class="line">2) &quot;5&quot;</span><br><span class="line">3) &quot;hello&quot;</span><br><span class="line">4) &quot;7&quot;</span><br><span class="line">5) &quot;2&quot;</span><br><span class="line">6) &quot;3&quot;</span><br><span class="line">7) &quot;4&quot;</span><br><span class="line">8) &quot;5&quot;</span><br></pre></td></tr></table></figure>

<h5 id="LPOP-RPOP命令"><a href="#LPOP-RPOP命令" class="headerlink" title="LPOP/RPOP命令"></a>LPOP/RPOP命令</h5><p><strong>LPOP/RPOP</strong>命令表示从左边或右边弹出一个值，值若存在，键仍存在，值若弹光，键则被删除。</p>
<p><strong>返回值：</strong>返回字符串，即第一个元素的值，如果<code>key</code>不存在，结果则为<code>nil</code> 。</p>
<p><strong>基本语法：</strong><code>LPOP KEY_NAME</code> / <code>RPOP KEY_NAME</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 左侧弹出值</span></span><br><span class="line">127.0.0.1:6379&gt; LPOP list1</span><br><span class="line">&quot;world&quot;</span><br><span class="line">127.0.0.1:6379&gt; LRANGE list1 0 -1</span><br><span class="line">1) &quot;5&quot;</span><br><span class="line">2) &quot;hello&quot;</span><br><span class="line">3) &quot;7&quot;</span><br><span class="line">4) &quot;2&quot;</span><br><span class="line">5) &quot;3&quot;</span><br><span class="line">6) &quot;4&quot;</span><br><span class="line">7) &quot;5&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 右侧弹出值</span></span><br><span class="line">127.0.0.1:6379&gt; RPOP list1</span><br><span class="line">&quot;5&quot;</span><br><span class="line">127.0.0.1:6379&gt; LRANGE list1 0 -1</span><br><span class="line">1) &quot;5&quot;</span><br><span class="line">2) &quot;hello&quot;</span><br><span class="line">3) &quot;7&quot;</span><br><span class="line">4) &quot;2&quot;</span><br><span class="line">5) &quot;3&quot;</span><br><span class="line">6) &quot;4&quot;</span><br></pre></td></tr></table></figure>

<h5 id="RPOPLPUSH命令"><a href="#RPOPLPUSH命令" class="headerlink" title="RPOPLPUSH命令"></a>RPOPLPUSH命令</h5><p><strong>RPOPLPUSH</strong>命令返回并删除存储在<code>source</code>列表中的最后一个元素(尾部)，并<code>push</code>元素到<code>destination</code>列表中的第一个元素(头部)。</p>
<p><strong>返回值：</strong>返回被弹出和推出的字符串元素。</p>
<p><strong>基本语法：</strong><code>RPOPLPUSH SOURCE_KEY_NAME DESTINATION_KEY_NAME</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; RPOPLPUSH list1 list2</span><br><span class="line">&quot;4&quot;</span><br><span class="line">127.0.0.1:6379&gt; LRANGE list1 0 -1</span><br><span class="line">1) &quot;5&quot;</span><br><span class="line">2) &quot;hello&quot;</span><br><span class="line">3) &quot;7&quot;</span><br><span class="line">4) &quot;2&quot;</span><br><span class="line">5) &quot;3&quot;</span><br><span class="line">127.0.0.1:6379&gt; LRANGE list2 0 -1</span><br><span class="line">1) &quot;4&quot;</span><br></pre></td></tr></table></figure>

<h5 id="LRANGE命令"><a href="#LRANGE命令" class="headerlink" title="LRANGE命令"></a>LRANGE命令</h5><p><strong>LRANGE</strong>命令将返回存储在key列表的特定元素。偏移量开始和停止是从0开始的索引，0是第一元素(该列表的头部)，1是列表的下一个元素。这些偏移量也可以是表示开始在列表的末尾偏移负数。例如，-1是该列表的最后一个元素，-2倒数第二个，等等。</p>
<p><strong>返回值：</strong>返回数组，指定范围内的元素的列表</p>
<p><strong>基本语法：</strong><code>LRANGE KEY_NAME START END</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; LRANGE list1 0 -1</span><br><span class="line">1) &quot;5&quot;</span><br><span class="line">2) &quot;hello&quot;</span><br><span class="line">3) &quot;7&quot;</span><br><span class="line">4) &quot;2&quot;</span><br><span class="line">5) &quot;3&quot;</span><br><span class="line">127.0.0.1:6379&gt; LRANGE list1 0 2</span><br><span class="line">1) &quot;5&quot;</span><br><span class="line">2) &quot;hello&quot;</span><br><span class="line">3) &quot;7&quot;</span><br></pre></td></tr></table></figure>

<h5 id="LINDEX命令"><a href="#LINDEX命令" class="headerlink" title="LINDEX命令"></a>LINDEX命令</h5><p><strong>LINDEX</strong>命令用于获取在存储于列表的key索引的元素。索引是从0开始的，所以0表示第一个元素，1第二个元素等等。负数可用于指定开始在列表的尾部元素。这里，-1表示最后一个元素，-2指倒数第二个等等。</p>
<p><strong>返回值：</strong>返回请求的元素，或者当索引超出范围返回<code>nil</code></p>
<p><strong>基本语法：</strong><code>LINDEX KEY_NAME INDEX_POSITION</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; LINDEX list1 2</span><br><span class="line">&quot;7&quot;</span><br><span class="line">127.0.0.1:6379&gt; LINDEX list1 10</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure>

<h5 id="LLEN命令"><a href="#LLEN命令" class="headerlink" title="LLEN命令"></a>LLEN命令</h5><p><strong>LLEN</strong>命令将返回存储在key列表的长度。</p>
<p><strong>返回值：</strong>返回整数为列表键长度，如果key不存在，它被解释为一个空列表，则返回0。当存储在关key的值不是一个列表，则会返回错误。</p>
<p><strong>基本语法：</strong><code>LLEN KEY_NAME</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; LLEN list1</span><br><span class="line">(integer) 5</span><br></pre></td></tr></table></figure>

<h5 id="LINSERT命令"><a href="#LINSERT命令" class="headerlink" title="LINSERT命令"></a>LINSERT命令</h5><p><strong>LINSERT</strong>命令将值插入到某一个列表中的值之前或之后</p>
<p><strong>返回值：</strong>回复整数，列表插入操作后的长度，没有找到该值时返回-1。</p>
<p><strong>基本语法：</strong><code>LINSERT KEY_NAME &lt;BEFORE/AFTER&gt; EXISTING_VALUE NEW_VALUE </code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; LRANGE list1 0 -1</span><br><span class="line">1) &quot;5&quot;</span><br><span class="line">2) &quot;hello&quot;</span><br><span class="line">3) &quot;7&quot;</span><br><span class="line">4) &quot;2&quot;</span><br><span class="line">5) &quot;3&quot;</span><br><span class="line">127.0.0.1:6379&gt; LINSERT list1 BEFORE &quot;7&quot; &quot;before7&quot;</span><br><span class="line">(integer) 6</span><br><span class="line">127.0.0.1:6379&gt; LINSERT list1 AFTER &quot;7&quot; &quot;after7&quot;</span><br><span class="line">(integer) 7</span><br><span class="line">127.0.0.1:6379&gt; LRANGE list1 0 -1</span><br><span class="line">1) &quot;5&quot;</span><br><span class="line">2) &quot;hello&quot;</span><br><span class="line">3) &quot;before7&quot;</span><br><span class="line">4) &quot;7&quot;</span><br><span class="line">5) &quot;after7&quot;</span><br><span class="line">6) &quot;2&quot;</span><br><span class="line">7) &quot;3&quot;</span><br></pre></td></tr></table></figure>

<h5 id="LREM命令"><a href="#LREM命令" class="headerlink" title="LREM命令"></a>LREM命令</h5><p><strong>LREM</strong>命令用于从左边向右边删除n个当前设定值。</p>
<p><strong>返回值：</strong>返回整数，删除的值的数量</p>
<p><strong>基本语法：</strong><code>LREM KEY_NAME &lt;NUM&gt; TARGET_VALUE</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 只存在一个hello，因此返回1</span></span><br><span class="line">127.0.0.1:6379&gt; LREM list1 3 &quot;hello&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; LRANGE list1 0 -1</span><br><span class="line">1) &quot;5&quot;</span><br><span class="line">2) &quot;before7&quot;</span><br><span class="line">3) &quot;7&quot;</span><br><span class="line">4) &quot;after7&quot;</span><br><span class="line">5) &quot;2&quot;</span><br><span class="line">6) &quot;3&quot;</span><br></pre></td></tr></table></figure>

<h5 id="LSET命令"><a href="#LSET命令" class="headerlink" title="LSET命令"></a>LSET命令</h5><p><strong>LSET</strong>命令将在索引值处修改列表元素</p>
<p><strong>返回值：</strong>返回字符串，超出范围将报错</p>
<p><strong>基本语法：</strong><code>LSET KEY_NAME INDEX VALUE</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; LSET list1 0 &quot;update&quot;</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; LRANGE list1 0 -1</span><br><span class="line">1) &quot;update&quot;</span><br><span class="line">2) &quot;before7&quot;</span><br><span class="line">3) &quot;7&quot;</span><br><span class="line">4) &quot;after7&quot;</span><br><span class="line">5) &quot;2&quot;</span><br><span class="line">6) &quot;3&quot;</span><br></pre></td></tr></table></figure>

<h4 id="数据结构-1"><a href="#数据结构-1" class="headerlink" title="数据结构"></a>数据结构</h4><p><code>List</code>的数据结构为快速链表<code>quickList</code></p>
<p>首先在列表元素较少的情况下会使用一块连续的内存存储，这个结构是<code>ziplist</code>，即<strong>压缩列表</strong>，它将所有的元素紧挨着一起存储，分配的是一块连续的内存。</p>
<p>当数据量比较多的时候才会改成<code>quickList</code>，因为普通的链表需要的附加指针空间太大，会比较浪费空间。例如只存放<code>int</code>型数据，却还要额外的两个指针<code>prev</code>和<code>next</code>，额外空间远大于存放的数据。因此Redis将链表和<code>zipList</code>组合起来形成<code>quickList</code>，即将多个连续空间的<code>zipList</code>使用<strong>双向指针</strong>串接起来使用，既满足了快速插入删除的性能，又不会出现较大的空间冗余</p>
<h3 id="集合-Set"><a href="#集合-Set" class="headerlink" title="集合(Set)"></a>集合(Set)</h3><h4 id="简介-2"><a href="#简介-2" class="headerlink" title="简介"></a>简介</h4><p><strong>Set</strong>对外提供的功能与<code>List</code>类似，是一个列表的功能，特殊之处在于<code>set</code>是可以自动排重的，当需要存储列表数据，又不希望出现重复数据时，<code>set</code>是一个很好的选择。</p>
<p><code>Redis</code>的<code>Set</code>是<code>String</code>的<strong>无序集合，底层是一个value为null的hash表，所以增删查的性能都为O(1)</strong></p>
<h4 id="常用命令-2"><a href="#常用命令-2" class="headerlink" title="常用命令"></a>常用命令</h4><h5 id="SADD命令"><a href="#SADD命令" class="headerlink" title="SADD命令"></a>SADD命令</h5><p><strong>SADD</strong>命令用于保存key到集合中。</p>
<p><strong>返回值：</strong>返回成功添加到该集合中的元素的数量。</p>
<p><strong>基本语法：</strong><code>SADD KEY_NAME VALUE1..VALUEN</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SADD set1 1 2 3 4</span><br><span class="line">(integer) 4</span><br><span class="line">127.0.0.1:6379&gt; SADD set1 1 2 3 4</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure>

<h5 id="SISMEMBER命令"><a href="#SISMEMBER命令" class="headerlink" title="SISMEMBER命令"></a>SISMEMBER命令</h5><p><strong>SISMEMBER</strong>命令将查询键是否存在</p>
<p><strong>返回值：</strong>如果是该集合的成员返回1，否则返回0</p>
<p><strong>基本语法：</strong><code>SISMEMBER KEY VALUE</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SISMEMBER set1 1</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; SISMEMBER set1 10</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure>

<h5 id="SREM命令"><a href="#SREM命令" class="headerlink" title="SREM命令"></a>SREM命令</h5><p><strong>SREM</strong>命令将移除一个或多个值</p>
<p><strong>返回值：</strong>返回被移除的元素的个数</p>
<p><strong>基本语法：</strong><code>SREM KEY MEMBER1..MEMBERN</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SREM set1 3 4 5 6</span><br><span class="line">(integer) 2</span><br></pre></td></tr></table></figure>

<h5 id="SPOP命令"><a href="#SPOP命令" class="headerlink" title="SPOP命令"></a>SPOP命令</h5><p><strong>SPOP</strong>命令将随机弹出一个元素</p>
<p><strong>返回值：</strong>返回弹出的值</p>
<p><strong>基本语法：</strong><code>SPOP KEY_NAME</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SPOP set1</span><br><span class="line">&quot;1&quot;</span><br><span class="line">127.0.0.1:6379&gt; SPOP set1</span><br><span class="line">&quot;2&quot;</span><br><span class="line">127.0.0.1:6379&gt; SPOP set1</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure>

<h5 id="SRANDMEMBER命令"><a href="#SRANDMEMBER命令" class="headerlink" title="SRANDMEMBER命令"></a>SRANDMEMBER命令</h5><p><strong>SRANDMEMBER</strong>命令将随机取出N个值，不删除</p>
<p><strong>返回值：</strong>返回取出的值</p>
<p><strong>基本语法：</strong><code>SRANDMEMBER KEY [count]</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SADD set1 1 2 3 4 5 6 7 8 9 10</span><br><span class="line">(integer) 10</span><br><span class="line">127.0.0.1:6379&gt; SRANDMEMBER set1 3</span><br><span class="line">1) &quot;2&quot;</span><br><span class="line">2) &quot;3&quot;</span><br><span class="line">3) &quot;8&quot;</span><br><span class="line">127.0.0.1:6379&gt; SRANDMEMBER set1 19</span><br><span class="line"> 1) &quot;1&quot;</span><br><span class="line"> 2) &quot;2&quot;</span><br><span class="line"> 3) &quot;3&quot;</span><br><span class="line"> 4) &quot;4&quot;</span><br><span class="line"> 5) &quot;5&quot;</span><br><span class="line"> 6) &quot;6&quot;</span><br><span class="line"> 7) &quot;7&quot;</span><br><span class="line"> 8) &quot;8&quot;</span><br><span class="line"> 9) &quot;9&quot;</span><br><span class="line">10) &quot;10&quot;</span><br><span class="line">127.0.0.1:6379&gt; SRANDMEMBER set2 1</span><br><span class="line">(empty array)</span><br></pre></td></tr></table></figure>

<h5 id="SMOVE命令"><a href="#SMOVE命令" class="headerlink" title="SMOVE命令"></a>SMOVE命令</h5><p><strong>SMOVE</strong>命令将一个集合中的成员移动到另一个集合中</p>
<p><strong>返回值：</strong>如果被移动成功，返回1，否则返回0</p>
<p><strong>基本语法：</strong><code>SMOVE SOURCE DESTINATION MEMBER</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SMOVE set1 set2 1</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; SMOVE set1 set2 11</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure>

<h5 id="SINTER-SUNION-SDIFF命令"><a href="#SINTER-SUNION-SDIFF命令" class="headerlink" title="SINTER/SUNION/SDIFF命令"></a>SINTER/SUNION/SDIFF命令</h5><p><strong>SINTER</strong>命令将获得两个集合的交集</p>
<p><strong>SUNION</strong>命令将获得两个集合的交集</p>
<p><strong>SDIFF</strong>命令将获得两个集合的差集，key1中有，key2中没有的</p>
<p><strong>返回值：</strong>元素</p>
<p><strong>基本语法：</strong><code>COMMAND KEY1 KEY2</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SINTER set1 set2</span><br><span class="line">1) &quot;2&quot;</span><br><span class="line">2) &quot;3&quot;</span><br><span class="line">3) &quot;4&quot;</span><br><span class="line">4) &quot;5&quot;</span><br><span class="line">127.0.0.1:6379&gt; SUNION set1 set2</span><br><span class="line"> 1) &quot;1&quot;</span><br><span class="line"> 2) &quot;2&quot;</span><br><span class="line"> 3) &quot;3&quot;</span><br><span class="line"> 4) &quot;4&quot;</span><br><span class="line"> 5) &quot;5&quot;</span><br><span class="line"> 6) &quot;6&quot;</span><br><span class="line"> 7) &quot;7&quot;</span><br><span class="line"> 8) &quot;8&quot;</span><br><span class="line"> 9) &quot;9&quot;</span><br><span class="line">10) &quot;10&quot;</span><br><span class="line">127.0.0.1:6379&gt; SDIFF set1 set2</span><br><span class="line">1) &quot;6&quot;</span><br><span class="line">2) &quot;7&quot;</span><br><span class="line">3) &quot;8&quot;</span><br><span class="line">4) &quot;9&quot;</span><br><span class="line">5) &quot;10&quot;</span><br></pre></td></tr></table></figure>

<h4 id="数据结构-2"><a href="#数据结构-2" class="headerlink" title="数据结构"></a>数据结构</h4><p><strong>Set</strong>的数据结构是<code>dict</code>字典，字典是使用哈希表实现的</p>
<p><code>JAVA</code>中的<code>HashSet</code>内部实现也用的<code>HashMap</code>，只不过所有的<code>Value</code>都指向同一个对象</p>
<p><code>Redis</code>中的<code>Set</code>内部实现也用的<code>Hash</code>结构，只不过所有的<code>Value</code>都指向同一个内部值</p>
<h3 id="哈希-Hash"><a href="#哈希-Hash" class="headerlink" title="哈希(Hash)"></a>哈希(Hash)</h3><h4 id="简介-3"><a href="#简介-3" class="headerlink" title="简介"></a>简介</h4><p>Hash是一个键值对集合，特别适合用来存储对象。在Redis中，每个哈希(散列)可以存储多达4亿个键-值对。</p>
<h4 id="常用命令-3"><a href="#常用命令-3" class="headerlink" title="常用命令"></a>常用命令</h4><h5 id="HSET命令"><a href="#HSET命令" class="headerlink" title="HSET命令"></a>HSET命令</h5><p><strong>HSET</strong>命令用于设置散列字段</p>
<p><strong>返回值：</strong>若字段是哈希值并且被更新则返回1，若字段已经存在并被更新 则返回0</p>
<p><strong>基本语法：</strong><code> HSET KEY_NAME FIELD VALUE</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; HSET hash1 field1 hello</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; HSET hash1 field2 world</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; HSET hash1 field1 Hello</span><br><span class="line">(integer) 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> HSETNX &lt;key&gt; &lt;field&gt; &lt;value&gt; 不存在字段名才允许设置</span></span><br></pre></td></tr></table></figure>

<h5 id="HGET命令"><a href="#HGET命令" class="headerlink" title="HGET命令"></a>HGET命令</h5><p><strong>HGET</strong>命令将获取与字段中存储的哈希键相关联的值</p>
<p><strong>返回值：</strong>存在时返回关联的字段，不存在时返回<code>nil</code></p>
<p><strong>基本语法：</strong><code>HGET KEY_NAME FIELD_NAME</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; HGET hash1 field1</span><br><span class="line">&quot;Hello&quot;</span><br><span class="line">127.0.0.1:6379&gt; HGET hash1 field4</span><br><span class="line">(nil)</span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用HGETALL &lt;key&gt;可以获得所有的键和值</span></span><br><span class="line">127.0.0.1:6379&gt; HGETALL hash1</span><br><span class="line">1) &quot;field1&quot;</span><br><span class="line">2) &quot;Hello&quot;</span><br><span class="line">3) &quot;field2&quot;</span><br><span class="line">4) &quot;world&quot;</span><br></pre></td></tr></table></figure>

<h5 id="HMSET命令"><a href="#HMSET命令" class="headerlink" title="HMSET命令"></a>HMSET命令</h5><p><strong>HMSET</strong>命令用于设置指定字段各自的值，此命令将覆盖该哈希的任何现存字段，若键不存在，则直接由hash创建</p>
<p><strong>返回值：</strong>返回OK</p>
<p><strong>基本语法：</strong><code>HMSET KEY_NAME FIELD1 VALUE1 ...FIELDN VALUEN</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; HMSET user name &quot;heavytiger&quot; age &quot;20&quot; gender &quot;1&quot;</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; HGETALL user</span><br><span class="line">1) &quot;name&quot;</span><br><span class="line">2) &quot;heavytiger&quot;</span><br><span class="line">3) &quot;age&quot;</span><br><span class="line">4) &quot;20&quot;</span><br><span class="line">5) &quot;gender&quot;</span><br><span class="line">6) &quot;1&quot;</span><br></pre></td></tr></table></figure>

<h5 id="HEXISTS命令"><a href="#HEXISTS命令" class="headerlink" title="HEXISTS命令"></a>HEXISTS命令</h5><p><strong>HEXISTS</strong>命令将检查哈希字段是否存在</p>
<p><strong>返回值：</strong>若包含字段返回1，若不包含或key不存在，返回0</p>
<p><strong>基本语法：</strong><code>HEXISTS KEY_NAME FIELD_NAME</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; HEXISTS user name</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; HEXISTS user hobby</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; HEXISTS user age</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>

<h5 id="HKEYS命令"><a href="#HKEYS命令" class="headerlink" title="HKEYS命令"></a>HKEYS命令</h5><p><strong>HKEYS</strong>命令将获取哈希中的所有字段</p>
<p><strong>返回值：</strong>返回所有哈希字段列表或者当key不存在时为一个空的列表。</p>
<p><strong>基本语法：</strong><code>HKEYS KEY_NAME</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; HKEYS user</span><br><span class="line">1) &quot;name&quot;</span><br><span class="line">2) &quot;age&quot;</span><br><span class="line">3) &quot;gender&quot;</span><br><span class="line">127.0.0.1:6379&gt; HKEYS user1</span><br><span class="line">(empty array)</span><br></pre></td></tr></table></figure>

<h5 id="HVALS命令"><a href="#HVALS命令" class="headerlink" title="HVALS命令"></a>HVALS命令</h5><p><strong>HVALS</strong>命令将获取哈希中的所有字段值</p>
<p><strong>返回值：</strong>返回所有哈希字段值列表或者当key不存在时为一个空的列表。</p>
<p><strong>基本语法：</strong><code>HVALS KEY_NAME</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; HVALS user1</span><br><span class="line">(empty array)</span><br><span class="line">127.0.0.1:6379&gt; HVALS user</span><br><span class="line">1) &quot;heavytiger&quot;</span><br><span class="line">2) &quot;20&quot;</span><br><span class="line">3) &quot;1&quot;</span><br></pre></td></tr></table></figure>

<h5 id="HINCRBY命令"><a href="#HINCRBY命令" class="headerlink" title="HINCRBY命令"></a>HINCRBY命令</h5><p><strong>HINCRBY</strong>命令用于增加字段中的存储的值的数量。若键不存在，创建新键，若字段不存在，将值设置为0再进行操作</p>
<p><strong>返回值：</strong>回复整数，字段的增值操作后的值</p>
<p><strong>基本语法：</strong><code>HINCRBY KEY_NAME FIELD_NAME INCR_BY_NUMBER</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; HGET user age</span><br><span class="line">&quot;20&quot;</span><br><span class="line">127.0.0.1:6379&gt; HINCRBY user age 3</span><br><span class="line">(integer) 23</span><br><span class="line">127.0.0.1:6379&gt; HINCRBY user age -4</span><br><span class="line">(integer) 19</span><br></pre></td></tr></table></figure>

<h5 id="HDEL命令"><a href="#HDEL命令" class="headerlink" title="HDEL命令"></a>HDEL命令</h5><p><strong>HDEL</strong>命令将删除一个或多个哈希字段</p>
<p><strong>返回值：</strong>返回从哈希键中删除的字段的数量</p>
<p><strong>基本语法：</strong><code>HDEL KEY_NAME FIELD1.. FIELDN </code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; HKEYS hash1</span><br><span class="line">1) &quot;field1&quot;</span><br><span class="line">2) &quot;field2&quot;</span><br><span class="line">127.0.0.1:6379&gt; HDEL hash1 field1 field2 field3</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; HKEYS hash1</span><br><span class="line">(empty array)</span><br></pre></td></tr></table></figure>

<h5 id="HLEN命令"><a href="#HLEN命令" class="headerlink" title="HLEN命令"></a>HLEN命令</h5><p><strong>HLEN</strong>命令将获得哈希键中包含的字段的数量</p>
<p><strong>返回值：</strong>回复哈希键中字段的数量，若不存在，返回0</p>
<p><strong>基本语法：</strong><code>HLEN KEY_NAME</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; HLEN hash1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; HLEN user</span><br><span class="line">(integer) 3</span><br></pre></td></tr></table></figure>

<h4 id="数据结构-3"><a href="#数据结构-3" class="headerlink" title="数据结构"></a>数据结构</h4><p>Hash类型对应的数据结构有两种，当<code>field-value</code>长度较短且个数较少时，使用<code>ziplist</code>，否则使用<code>hashtable</code></p>
<h3 id="有序集合-Zset"><a href="#有序集合-Zset" class="headerlink" title="有序集合(Zset)"></a>有序集合(Zset)</h3><h4 id="简介-4"><a href="#简介-4" class="headerlink" title="简介"></a>简介</h4><p>Redis有序集合<code>zset</code>与普通集合<code>set</code>非常相似，是一个<strong>没有重复元素</strong>的字符串集合。</p>
<p>不同之处是有序集合的每个成员都关联了一个评分(<code>score</code>)，<strong>这个评分(score)被用来按照从最低分到最高分的方式排序集合中的成员</strong>。集合的成员是唯一的，但是评分可以是重复了。</p>
<p>因为元素是有序的,所以你也可以很快的根据评分<code>score</code>或者次序<code>position</code>来获取一个范围的元素。</p>
<p>访问有序集合的中间元素也是非常快的,因此你能够使用有序集合作为一个没有重复成员的智能列表。</p>
<h4 id="常用命令-4"><a href="#常用命令-4" class="headerlink" title="常用命令"></a>常用命令</h4><h5 id="ZADD命令"><a href="#ZADD命令" class="headerlink" title="ZADD命令"></a>ZADD命令</h5><p><strong>ZADD</strong>命令将一个或多个成员及其score值存入到有序集合中</p>
<p><strong>返回值：</strong>返回添加到有序集合中的元素个数</p>
<p><strong>基本语法：</strong><code>ZADD &lt;key&gt; &lt;score1&gt; &lt;value1&gt; .. &lt;scoreN&gt; &lt;valueN&gt;</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; ZADD zset 1 Java 10 Python 20 C++ 30 GoLang 15 MySQL</span><br><span class="line">(integer) 5</span><br></pre></td></tr></table></figure>

<h5 id="ZRANGE命令"><a href="#ZRANGE命令" class="headerlink" title="ZRANGE命令"></a>ZRANGE命令</h5><p><strong>ZRANGE</strong>命令将一个有序集合在规定的<strong>下标</strong>范围内进行排序，按照<code>score</code>从小至大的顺序排序</p>
<p><strong>返回值：</strong>返回排序的有序集合</p>
<p><strong>基本语法：</strong><code>ZRANGE &lt;key&gt; &lt;start&gt; &lt;end&gt;</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> -1表示到最大值</span></span><br><span class="line">127.0.0.1:6379&gt; ZRANGE zset 0 -1</span><br><span class="line">1) &quot;Java&quot;</span><br><span class="line">2) &quot;Python&quot;</span><br><span class="line">3) &quot;MySQL&quot;</span><br><span class="line">4) &quot;C++&quot;</span><br><span class="line">5) &quot;GoLang&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"> withscores表示展示分数</span></span><br><span class="line">127.0.0.1:6379&gt; ZRANGE zset 0 -1 withscores</span><br><span class="line"> 1) &quot;Java&quot;</span><br><span class="line"> 2) &quot;1&quot;</span><br><span class="line"> 3) &quot;Python&quot;</span><br><span class="line"> 4) &quot;10&quot;</span><br><span class="line"> 5) &quot;MySQL&quot;</span><br><span class="line"> 6) &quot;15&quot;</span><br><span class="line"> 7) &quot;C++&quot;</span><br><span class="line"> 8) &quot;20&quot;</span><br><span class="line"> 9) &quot;GoLang&quot;</span><br><span class="line">10) &quot;30&quot;</span><br></pre></td></tr></table></figure>

<h5 id="ZRANGEBYSCORE命令"><a href="#ZRANGEBYSCORE命令" class="headerlink" title="ZRANGEBYSCORE命令"></a>ZRANGEBYSCORE命令</h5><p><strong>ZRANGEBYSCORE</strong>命令将一个有序集合在规定的<strong>score</strong>范围内进行排序，按照<code>score</code>从小至大的顺序排序</p>
<p><strong>返回值：</strong>返回排序的有序集合</p>
<p><strong>基本语法：</strong><code>ZRANGEBYSCORE &lt;key&gt; &lt;min&gt; &lt;max&gt;</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; ZRANGEBYSCORE zset 0 20</span><br><span class="line">1) &quot;Java&quot;</span><br><span class="line">2) &quot;Python&quot;</span><br><span class="line">3) &quot;MySQL&quot;</span><br><span class="line">4) &quot;C++&quot;</span><br><span class="line">127.0.0.1:6379&gt; ZRANGEBYSCORE zset 0 20 withscores</span><br><span class="line">1) &quot;Java&quot;</span><br><span class="line">2) &quot;1&quot;</span><br><span class="line">3) &quot;Python&quot;</span><br><span class="line">4) &quot;10&quot;</span><br><span class="line">5) &quot;MySQL&quot;</span><br><span class="line">6) &quot;15&quot;</span><br><span class="line">7) &quot;C++&quot;</span><br><span class="line">8) &quot;20&quot;</span><br></pre></td></tr></table></figure>

<h5 id="ZINCRBY命令"><a href="#ZINCRBY命令" class="headerlink" title="ZINCRBY命令"></a>ZINCRBY命令</h5><p><strong>ZINCRBY</strong>命令为元素的<code>score</code>加上增量</p>
<p><strong>返回值：</strong>返回修改后<code>score</code>的值</p>
<p><strong>基本语法：</strong><code>ZINCRBY &lt;key&gt; &lt;increment&gt; &lt;value&gt;</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; ZINCRBY zset 5 java</span><br><span class="line">&quot;5&quot;</span><br><span class="line">127.0.0.1:6379&gt; ZINCRBY zset -5 java</span><br><span class="line">&quot;0&quot;</span><br></pre></td></tr></table></figure>

<h5 id="ZREM命令"><a href="#ZREM命令" class="headerlink" title="ZREM命令"></a>ZREM命令</h5><p><strong>ZREM</strong>命令将删除该集合下，指定的元素</p>
<p><strong>返回值：</strong>删除的元素的个数</p>
<p><strong>基本语法：</strong><code>ZREM &lt;key&gt; &lt;value&gt;</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; ZREM zset java</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; ZRANGE zset 0 -1</span><br><span class="line">1) &quot;Java&quot;</span><br><span class="line">2) &quot;Redis&quot;</span><br><span class="line">3) &quot;Python&quot;</span><br><span class="line">4) &quot;MySQL&quot;</span><br><span class="line">5) &quot;C++&quot;</span><br><span class="line">6) &quot;GoLang&quot;</span><br></pre></td></tr></table></figure>

<h5 id="ZCOUNT命令"><a href="#ZCOUNT命令" class="headerlink" title="ZCOUNT命令"></a>ZCOUNT命令</h5><p><strong>ZCOUNT</strong>命令将统计该集合的<code>score</code>区间内的元素个数</p>
<p><strong>返回值：</strong>返回在区间内的元素</p>
<p><strong>基本语法：</strong><code>ZCOUNT &lt;key&gt; &lt;min&gt; &lt;max&gt;</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; ZCOUNT zset 0 30</span><br><span class="line">(integer) 6</span><br><span class="line">127.0.0.1:6379&gt; ZCOUNT zset -5 20</span><br><span class="line">(integer) 5</span><br></pre></td></tr></table></figure>

<h5 id="ZRANK命令"><a href="#ZRANK命令" class="headerlink" title="ZRANK命令"></a>ZRANK命令</h5><p><strong>ZRANK</strong>命令将得到值在集合中的排名，排名从0开始</p>
<p><strong>返回值：</strong>返回值在集合中的排名，从0开始，若不存在返回<code>nil</code></p>
<p><strong>基本语法：</strong><code>ZRANK &lt;key&gt; &lt;value&gt;</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; ZRANK zset Java</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; ZRANK zset C++</span><br><span class="line">(integer) 4</span><br><span class="line">127.0.0.1:6379&gt; ZRANK zset unknown</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; ZRANGE zset 0 -1</span><br><span class="line">1) &quot;Java&quot;</span><br><span class="line">2) &quot;Redis&quot;</span><br><span class="line">3) &quot;Python&quot;</span><br><span class="line">4) &quot;MySQL&quot;</span><br><span class="line">5) &quot;C++&quot;</span><br><span class="line">6) &quot;GoLang&quot;</span><br></pre></td></tr></table></figure>

<h4 id="数据结构-4"><a href="#数据结构-4" class="headerlink" title="数据结构"></a>数据结构</h4><p>**SortedSet(zset)**是Redis提供的一个非常特别的数据结构，一方面它等价于Java的数据结构<code>Map&lt;String, Double&gt;</code>，它可以给每一个元素赋予一个权重<code>score</code>，另一方面，他有类似于<code>TreeSet</code>，内部的元素会按照权重<code>score</code>进行排序，可以得到每个元素的名次，还可以通过<code>score</code>的范围来获取元素的列表。</p>
<p><code>zset</code>的底层使用到了两个数据结构</p>
<ol>
<li><code>hash</code>，哈西德作用就是关联元素<code>value</code>和权重<code>score</code>，保障元素<code>value</code>的唯一性，可以通过元素<code>value</code>找到相应的<code>score</code>值。</li>
<li><strong>跳跃表</strong>，跳跃表的目的在于给元素<code>value</code>排序，根据<code>score</code>的范围获取元素的列表</li>
</ol>
<blockquote>
<p><strong>跳跃表：</strong></p>
<p>跳表是一个随机化的数据结构，可以被看做二叉树的一个变种，它在性能上和红黑树，AVL树不相上下，但是跳表的原理非常简单，目前在Redis和LeveIDB中都有用到。</p>
<p>它采用随机技术决定链表中哪些节点应增加向前指针以及在该节点中应增加多少个指针。跳表结构的头节点需有足够的指针域，以满足可能构造最大级数的需要，而尾节点不需要指针域。</p>
<p><strong>采用这种随机技术，跳表中的搜索、插入、删除操作的时间均为O(logn)，然而，最坏情况下时间复杂性却变成O(n)。相比之下，在一个有序数组或链表中进行插入/删除操作的时间为O(n)，最坏情况下为O(n)。</strong></p>
<p><img src="1920px-Skip_list.svg.png" alt="img"></p>
</blockquote>
<h2 id="Redis6新数据类型"><a href="#Redis6新数据类型" class="headerlink" title="Redis6新数据类型"></a>Redis6新数据类型</h2><h3 id="Bitmaps"><a href="#Bitmaps" class="headerlink" title="Bitmaps"></a>Bitmaps</h3><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4><p>现代计算机用二进制（位）作为信息的基础单位，1个字节等于8位，例如<code>abc</code>字符串是由3个字节组成，但实际在计算机存储时将其用二进制表示，<code>abc</code>分别对应的ASCII码分别是<code>97</code>、<code>98</code>、<code>99</code>，对应的二进制分别是<code>01100001</code>、<code>01100010</code>和<code>01100011</code></p>
<p>通过合理地使用<code>Bitmaps</code>，可以合理地使用操作位能够有效地提高内存使用率和开发效率。</p>
<ol>
<li><code>Bitmaps</code>本身不是一种数据类型，实际上它就是字符串<code>key-value</code>，但是它可以对字符串的位进行操作。</li>
<li><code>Bitmaps</code>单独提供了一套命令，所以在Redis中使用<code>Bitmaps</code>和使用字符串的方法不太相同。 可以把<code>Bitmaps</code>想象成一个以位为单位的数组，数组的每个单元只能存储0和1，数组的下标在<code>Bitmaps</code>中叫做偏移量。</li>
</ol>
<p><img src="image-20220126151622002.png" alt="image-20220126151622002"></p>
<h4 id="常用命令-5"><a href="#常用命令-5" class="headerlink" title="常用命令"></a>常用命令</h4><h5 id="SETBIT命令"><a href="#SETBIT命令" class="headerlink" title="SETBIT命令"></a>SETBIT命令</h5><p><strong>SETBIT</strong>命令将设置Bitmaps中的某个偏移量的值为（0或1）</p>
<p>很多站点的用户id以某个编号开头，直接使用id作为偏移量会造成很大的浪费，可以在每次setbit操作时减去初始id偏移量，可以用来做网站在线人数的统计</p>
<p><strong>返回值：</strong>返回修改之前该<code>offset</code>上的值，0或1</p>
<p><strong>基本语法：</strong><code>SETBIT &lt;key&gt; &lt;offset&gt; &lt;value&gt;</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SETBIT bitmap1 19 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; SETBIT bitmap1 19 0</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; SETBIT bitmap1 19 0</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure>

<h5 id="GETBIT命令"><a href="#GETBIT命令" class="headerlink" title="GETBIT命令"></a>GETBIT命令</h5><p><strong>GETBIT</strong>命令将获取某偏移量处的值，偏移量从0开始</p>
<p><strong>返回值：</strong>返回当前该<code>offset</code>上的值，0或1</p>
<p><strong>基本语法：</strong><code>GETBIT &lt;key&gt; &lt;offset&gt;</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SETBIT bitmap1 19 1</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; GETBIT bitmap1 19</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; GETBIT bitmap1 20</span><br><span class="line">(integer) 0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 例如确认id为10的用户在某天是否访问过</span></span><br><span class="line">GETBIT users：20220101 10</span><br></pre></td></tr></table></figure>

<h5 id="BITCOUNT命令"><a href="#BITCOUNT命令" class="headerlink" title="BITCOUNT命令"></a>BITCOUNT命令</h5><p><strong>BITCOUNT</strong>命令将获取Bitmaps中被设置为1的bit数一般情况下会统计整个字符串，通过<code>start</code>和<code>end</code>参数，可以使计数旨在特定下标区间上进行（<strong>注意：下标表示字节区间，左闭右闭</strong>）。</p>
<p><strong>返回值：</strong>返回当前范围内为Bitmaps中为1的数量</p>
<p><strong>基本语法：</strong><code>BITCOUNT&lt;key&gt; &lt;start&gt; &lt;end&gt;</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SET abc abc</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到就是调用的String类型，`01100001`、`01100010`和`01100011`</span></span><br><span class="line">127.0.0.1:6379&gt; BITCOUNT abc 0 -1</span><br><span class="line">(integer) 10</span><br><span class="line"><span class="meta">#</span><span class="bash"> 01100001</span></span><br><span class="line">127.0.0.1:6379&gt; BITCOUNT abc 0 0</span><br><span class="line">(integer) 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 01100010</span></span><br><span class="line">127.0.0.1:6379&gt; BITCOUNT abc 1 1</span><br><span class="line">(integer) 3</span><br><span class="line"><span class="meta">#</span><span class="bash"> 01100011</span></span><br><span class="line">127.0.0.1:6379&gt; BITCOUNT abc 2 2</span><br><span class="line">(integer) 4</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="BITOP命令"><a href="#BITOP命令" class="headerlink" title="BITOP命令"></a>BITOP命令</h5><p><strong>BITOP</strong>命令将多个Bitmaps进行<strong>交、并、非、异或</strong>运算，将结果保存在<code>destkey</code>中，可以用类似命令计算月活度等</p>
<p><strong>返回值：</strong>返回修改之前该<code>offset</code>上的值，0或1</p>
<p><strong>基本语法：</strong><code>BITOP (and/or/not/xor) &lt;destkey&gt; [key…]</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 2022年1月1日，用户1，2，5，9登录</span></span><br><span class="line">SETBIT unique:users:20220101 1 1</span><br><span class="line">SETBIT unique:users:20220101 2 1</span><br><span class="line">SETBIT unique:users:20220101 5 1</span><br><span class="line">SETBIT unique:users:20220101 9 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2022年1月2日，用户0，1，4，9登录</span></span><br><span class="line">SETBIT unique:users:20220102 0 1</span><br><span class="line">SETBIT unique:users:20220102 1 1</span><br><span class="line">SETBIT unique:users:20220102 4 1</span><br><span class="line">SETBIT unique:users:20220102 9 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 计算两天都访问过网站的用户数量</span></span><br><span class="line">127.0.0.1:6379&gt; BITOP AND unique:users:and unique:users:20220101 unique:users:20220102</span><br><span class="line">(integer) 2</span><br><span class="line"><span class="meta">#</span><span class="bash"> 计算均访问过的数量</span></span><br><span class="line">127.0.0.1:6379&gt; BITCOUNT unique:users:and</span><br><span class="line">(integer) 2</span><br></pre></td></tr></table></figure>

<h4 id="数据结构-5"><a href="#数据结构-5" class="headerlink" title="数据结构"></a>数据结构</h4><p>Bitmaps实质就是对String的一系列操作</p>
<p>使用bitmaps可以节省很多资源，例如用户规模为1亿的站点，若使用Bitmaps只需要占用不到12MB的空间，但是若使用set将会占用800MB，很明显可以省下很大的空间，但是只适合用户活跃度很高的网站，若用户的活跃度不高，只存在很少的在线用户，那么使用bitmaps将占用很多资源存储0，反而会导致内存开销大。</p>
<h3 id="HyperLogLog"><a href="#HyperLogLog" class="headerlink" title="HyperLogLog"></a>HyperLogLog</h3><h4 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h4><p>在工作当中，我们经常会遇到与统计相关的功能需求，比如统计网站PV（PageView页面访问量）,可以使用Redis的incr、incrby轻松实现。</p>
<p>但是要求根据独立IP，搜索记录数去重等计数问题，很难通过incr进行实现，这种需要求集合中不重复元素的个数的问题被称为基数问题。</p>
<p>解决基数问题的方案有以下很多种：</p>
<ol>
<li>数据存储在MySQL表中，使用distinct count计算不重复个数</li>
<li>使用Redis提供的hash、set、bitmaps等数据结构来处理</li>
</ol>
<p>但是以上的方案结果很精确，却会导致数据不断增加，占用空间越来越大，对于很大的数据集不切实际。</p>
<p>为了解决这个问题，Redis通过<code>HyperLogLog</code>降低一定的精度，平衡存储空间，在输入元素的数量或者体积非常大时，计算基数总空间恒为定值。</p>
<p>在 Redis 里面，每个<code>HyperLogLog</code>键只需要花费<code>12 KB</code>内存，就可以计算接近<code>2^64</code>个不同元素的基数。这和计算基数时，元素越多耗费内存就越多的集合形成鲜明对比。</p>
<p>但是，因为 HyperLogLog 只会根据输入元素来计算基数，而不会储存输入元素本身，所以 HyperLogLog 不能像集合那样，返回输入的各个元素。</p>
<blockquote>
<p><strong>什么是基数？</strong></p>
<p>比如数据集{1,3,5,7,5,7,8}，那么这个数据集的基数集为{1,3,5,7,8}，基数(不重复元素)为5。<strong>基数估计就是在误差可接受的范围内，快速计算基数。</strong></p>
</blockquote>
<h4 id="常用命令-6"><a href="#常用命令-6" class="headerlink" title="常用命令"></a>常用命令</h4><h5 id="PFADD命令"><a href="#PFADD命令" class="headerlink" title="PFADD命令"></a>PFADD命令</h5><p><strong>PFADD</strong>命令将指定的元素集添加进HyperLogLog中</p>
<p><strong>返回值：</strong>如果执行命令后HLL估计的近似基数发生变化，则返回1，否则返回0。</p>
<p><strong>基本语法：</strong><code>PFADD &lt;key&gt; [elements ... ]</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; PFADD hll1 &quot;redis&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; PFADD hll1 &quot;redis&quot;</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; PFADD hll1 &quot;redis&quot;</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; PFADD hll1 &quot;mysql&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; PFADD hll1 &quot;java&quot; &quot;mysql&quot; &quot;php&quot;</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>

<h5 id="PFCOUNT命令"><a href="#PFCOUNT命令" class="headerlink" title="PFCOUNT命令"></a>PFCOUNT命令</h5><p><strong>PFCOUNT</strong>命令将计算HLL的近似基数，不见得准确，但是误差很低，标准误差只有<code>0.81%</code>左右，即估算百万级的访问IP，大致误差数量只为1万左右</p>
<p><strong>返回值：</strong>获得近似基数值，也可以获取多组数据的近似基数值，例如一周的UV可以使用7天的日UV合并计算</p>
<p><strong>基本语法：</strong><code>PFCOUNT [keys ... ]</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; PFCOUNT hll1</span><br><span class="line">(integer) 4</span><br><span class="line">127.0.0.1:6379&gt; PFADD hll2 redis java java mysql mysql</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT hll2</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT hll1 hll2</span><br><span class="line">(integer) 4</span><br></pre></td></tr></table></figure>

<h5 id="PFMERGE命令"><a href="#PFMERGE命令" class="headerlink" title="PFMERGE命令"></a>PFMERGE命令</h5><p><strong>PFMERGE</strong>命令将多个HLL合并后的结果计算存储在另一个HLL中，比如每月的活跃用户可以用每天的活跃用户合并计算</p>
<p><strong>返回值：</strong>合并成功返回OK</p>
<p><strong>基本语法：</strong><code>PFMERGE [keys ... ]</code></p>
<p><strong>例如：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; PFMERGE hll3 hll1 hll2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; KEYS hll*</span><br><span class="line">1) &quot;hll1&quot;</span><br><span class="line">2) &quot;hll2&quot;</span><br><span class="line">3) &quot;hll3&quot;</span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT hll3</span><br><span class="line">(integer) 4</span><br></pre></td></tr></table></figure>

<h4 id="数据结构-6"><a href="#数据结构-6" class="headerlink" title="数据结构"></a>数据结构</h4><p>可以详见该文章：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903785744056333">HyperLogLog 算法的原理讲解以及 Redis 是如何应用它的 - 掘金 (juejin.cn)</a></p>
<p>插入数据及误差模拟：<a target="_blank" rel="noopener" href="http://content.research.neustar.biz/blog/hll.html">Sketch of the Day: HyperLogLog — Cornerstone of a Big Data Infrastructure – AK Tech Blog (neustar.biz)</a></p>
<h3 id="Geospatial"><a href="#Geospatial" class="headerlink" title="Geospatial"></a>Geospatial</h3><h4 id="介绍-2"><a href="#介绍-2" class="headerlink" title="介绍"></a>介绍</h4><p>Redis 3.2 中增加了对GEO类型的支持。GEO，Geographic，地理信息的缩写。该类型，就是元素的2维坐标，在地图上就是经纬度。redis基于该类型，提供了经纬度设置，查询，范围查询，距离查询，经纬度Hash等常见操作。</p>
<p>可以用来实现诸如附近的人，附近的景点之类的功能。</p>
<h4 id="常用命令-7"><a href="#常用命令-7" class="headerlink" title="常用命令"></a>常用命令</h4><ol>
<li><p><code>GEOADD</code>添加地理位置，经度纬度名称。两极无法直接添加，一般会下载城市数据，直接通过 Java 程序一次性导入。有效的经度从 -180 度到 180 度。有效的纬度从 -85.05112878 度到 85.05112878 度。当坐标位置超出指定范围时，该命令将会返回一个错误。已经添加的数据，是无法再次往里面添加的。</p>
<p><code>GEOADD &lt;key&gt; &lt;longitude&gt; &lt;latitude&gt; &lt;member&gt; [longitude latitude member...]</code></p>
</li>
<li><p><code>GEOPOS</code>获取指定位置的坐标值</p>
<p><code>GEOPOS &lt;key&gt; &lt;member&gt; [members...]</code></p>
</li>
<li><p><code>GEODIST</code>获取两个位置之间的指向距离</p>
<p><code>GEODIST &lt;key&gt; &lt;member1&gt; &lt;member2&gt; [m|km|ft|mi]</code></p>
</li>
<li><p><code>GEORADIUS</code>将给定的经纬度为中心，找出某一半径内的元素</p>
<p><code>GEORADIUS &lt;key&gt; &lt;longitude&gt; &lt;latitude&gt; radius m|km|ft|mi</code></p>
</li>
</ol>
<h2 id="Redis配置文件详解"><a href="#Redis配置文件详解" class="headerlink" title="Redis配置文件详解"></a>Redis配置文件详解</h2><p>按照<code>redis.conf</code>文件中的相关配置，进行从上至下的依次介绍：</p>
<ol>
<li><p>首先声明了存储大小的使用及配置规则</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1k =&gt; 1000 bytes</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1kb =&gt; 1024 bytes</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1m =&gt; 1000000 bytes</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1mb =&gt; 1024*1024 bytes</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1g =&gt; 1000000000 bytes</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 1gb =&gt; 1024*1024*1024 bytes</span></span><br></pre></td></tr></table></figure>

<p>redis配置中只支持<code>bytes</code>即字节单位，其他的单位均按照规范声明，非大小写敏感</p>
</li>
<li><p><code>INCLUDES</code>部分声明了需要包含的文件，类似于<code>jsp</code>中的include，可以把其他的文件包含到该配置文件中：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> include /path/to/local.conf</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> include /path/to/other.conf</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>NETWORK</code>部分包含了很多与网络相关的配置：</p>
<ol>
<li><code>bind</code>，默认为<code>bind 127.0.0.1 -::1</code>，表示该机的Redis只能通过本地<code>localhost</code>进行访问，其他通过远程对该<code>6379</code>端口的访问均无法连接，bind指的是绑定部署redis服务机器的网卡ip，比如一台机器对外暴露了多个ip，ip1，ip2，ip3，通过ip1，ip2，ip3都可以访问这台机器，也就是通过ip1，ip2，ip3都可以连接到redis服务，但是设置了bind参数后，比如bind=ip1，此时只能通过ip1访问redis服务，ip2，ip3不行，虽然ip2，ip3可以访问部署redis的机器，但是却不能访问此机器上的redis服务。</li>
<li><code>protected-mode</code>，默认为<code>yes</code>，表示保护模式开启，若要允许远程访问，需要将3.1中的<code>bind</code>注释掉，修改该项为<code>no</code></li>
<li><code>port</code>，默认为<code>6379</code></li>
<li><code>tcp-backlog</code>，默认为<code>511</code>；设置<code>tcp</code>的<code>backlog</code>，<code>backlog</code>其实是一个连接队列，<strong>backlog队列总和=未完成三次握手队列＋已经完成三次握手队列</strong> 在高并发环境下你需要一个高<code>backlog</code>值来避免慢客户端连接问题。注意Linux内核会将这个值减小到<code>proc/sys/net/core/somaxconn</code>的值<code>128</code>，所以需要确认增大<code>/proc/sys/net/core/somaxconn</code>和<code>/proc/sys/net/ipv4/tcp_max_syn_backlog(128)</code>两个值来达到想要的效果</li>
<li><code>timeout</code>默认为<code>0</code>，表示一个连接在经过多少秒无操作后自动关闭，0表示永不超时</li>
<li><code>tcp-keepalive</code>默认为<code>300</code>，表示一个<code>tcp</code>连接在经过多少秒无操作后关闭</li>
</ol>
</li>
<li><p><code>GENERAL</code>部分包含了很多通用配置</p>
<ol>
<li><p><code>daemonize</code>，默认为<code>no</code>表示不启用守护进程，即只允许在前台操作，若需要后台操作将其改为<code>yes</code></p>
</li>
<li><p><code>pidfile</code>，默认为<code>/var/run/redis_6379.pid</code>，服务在启动后会将端口号存到该文件中</p>
</li>
<li><p><code>loglevel</code>，默认为<code>notice</code>，与log4j类似，其也允许多种日志级别：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> debug (a lot of information, useful <span class="keyword">for</span> development/testing)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> verbose (many rarely useful info, but not a mess like the debug level)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> notice (moderately verbose, what you want <span class="keyword">in</span> production probably)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> warning (only very important / critical messages are logged)</span></span><br></pre></td></tr></table></figure></li>
<li><p><code>logfile</code>，默认为空，即日志的存放位置，修改后，将日志存放到修改后的路径</p>
</li>
<li><p><code>databases</code>，默认为<code>16</code>，即16个数据库编号从<code>0</code>到<code>databases-1</code></p>
</li>
</ol>
</li>
<li><p><code>SECURITY</code>部分包含了很多与Redis安全相关的配置</p>
<ol>
<li>默认密码是没有做设置的，可以修改密码，默认为<code># requirepass foobared</code>，将注释取消后，修改为密码即可</li>
</ol>
</li>
<li><p><code>LIMITS</code>部分表示客户端的相关限制</p>
<ol>
<li><p><code>maxclients</code>，默认为10000，设置Redis同时可与多少个客户端进行连接。如果达到了此限制，redis则会拒绝新的连接请求，并且向这些连接请求方发出<code>max number of clients reached</code>以作回应。</p>
</li>
<li><p><code>maxmemory</code>，<strong>必须设置</strong>，否则内存占满会导致服务器宕机，该选项设置redis可用内存量，一旦达到上限会移除内部数据，移除规则可以在<code>maxmemory-policy</code>中进行设置。</p>
</li>
<li><p><code>maxmemory-policy</code>，表示移除规则：</p>
<blockquote>
<ul>
<li>volatile-lru：使用LRU算法移除key，只对设置了过期时间的键；（最近最少使用）</li>
<li>allkeys-lru：在所有集合key中，使用LRU算法移除key</li>
<li>volatile-random：在过期集合中移除随机的key，只对设置了过期时间的键</li>
<li>allkeys-random：在所有集合key中，移除随机的key</li>
<li>volatile-ttl：移除那些TTL值最小的key，即那些最近要过期的key</li>
<li>noeviction：不进行移除。针对写操作，只是返回错误信息</li>
</ul>
</blockquote>
</li>
<li><p><code>maxmemory-samples</code>，表示LRU算法和TTL算法的样本大小，一般设置3-7的数字，数值越小，样本越不精确，但是性能消耗也小。</p>
</li>
</ol>
</li>
</ol>
<h2 id="Redis发布与订阅"><a href="#Redis发布与订阅" class="headerlink" title="Redis发布与订阅"></a>Redis发布与订阅</h2><h3 id="发布与订阅介绍"><a href="#发布与订阅介绍" class="headerlink" title="发布与订阅介绍"></a>发布与订阅介绍</h3><p>Redis 发布订阅 (pub/sub) 是一种消息通信模式：发送者 (pub) 发送消息，订阅者 (sub) 接收消息。</p>
<p>Redis 客户端可以订阅任意数量的频道。</p>
<h3 id="发布与订阅简易流程"><a href="#发布与订阅简易流程" class="headerlink" title="发布与订阅简易流程"></a>发布与订阅简易流程</h3><ol>
<li><p>新建两个ssh连接连接到redis数据库</p>
<p><img src="SLELOGN.png" alt="SLELOGN"></p>
</li>
<li><p>连接1使用<code>SUBSCRIBE</code>命令订阅频道<code>channelTest</code></p>
</li>
<li><p>连接2使用<code>PUBLISH</code>命令通过频道<code>channelTest</code>发送<code>hello!!!</code>消息</p>
</li>
<li><p>连接1能接受到订阅的频道中的消息</p>
<p><img src="7V1X.png" alt="7V1X"></p>
</li>
</ol>
<blockquote>
<p>发布的消息没有经过持久化操作，订阅的客户端只能收到订阅后发布的消息</p>
</blockquote>
<h2 id="Jedis操作Redis"><a href="#Jedis操作Redis" class="headerlink" title="Jedis操作Redis"></a>Jedis操作Redis</h2><p>由于是在阿里云服务器上进行Redis操作，因此需要保证操作安全，若不设置密码被扫描到<code>6379</code>端口开放，恭喜你，你的服务器将很快变成矿机。</p>
<p>在<code>/etc/redis.conf</code>中进行如下配置：</p>
<ol>
<li><p>注释掉 <code>bind 127.0.0.1</code><br>可以在<code>vim /etc/redis.conf</code>后进入指令模式，然后输入<code>：/单词</code>快速找到单词的位置</p>
</li>
<li><p>修改<code>protected-mode</code><br>在<code>redis.conf</code>中找到<code>protected-mode</code>将后面的<code>yes</code>改为<code>no</code></p>
</li>
<li><p>修改<code>daemonize</code><br>在<code>redis.conf</code>中找到<code>daemonize</code>将后面的<code>no</code>改为<code>yes</code></p>
</li>
<li><p>修改密码<code>requirepass foobared</code><br>在<code>redis.conf</code>中找到<code>requirepass foobared</code>，可在其后添加密码：<code>requirepass yourPassword</code></p>
</li>
<li><p>关闭<code>redis-server</code>，使用语句<code>ps -ef | grep redis</code>找到redis的<code>pid</code>，使用命令<code>kill -9 pid</code>结束服务</p>
</li>
<li><p>使用命令重启服务<code>redis-server /etc/redis.conf</code></p>
</li>
<li><p>使用<code>redis-cli -a yourPassword</code>命令尝试<code>redis-cli</code>连接，若连接成功，输入<code>ping</code>将得到<code>PONG</code></p>
</li>
<li><p>防火墙开启<code>6379</code>端口，允许外网连接访问</p>
</li>
</ol>
<h3 id="测试Redis连接"><a href="#测试Redis连接" class="headerlink" title="测试Redis连接"></a>测试Redis连接</h3><h4 id="导入Jedis所需的包"><a href="#导入Jedis所需的包" class="headerlink" title="导入Jedis所需的包"></a>导入Jedis所需的包</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>redis.clients<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jedis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="编写如下所示代码测试连接"><a href="#编写如下所示代码测试连接" class="headerlink" title="编写如下所示代码测试连接"></a>编写如下所示代码测试连接</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试Redis连接及相关功能</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> heavytiger</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">testRedis</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">&quot;192.xxx.xxx.xxx&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        jedis.auth(<span class="string">&quot;6o5FLS9b...........EGf56vE1orO&quot;</span>);</span><br><span class="line">        System.out.println(jedis.ping());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试结果如下：</span></span><br><span class="line"><span class="comment">// PONG</span></span><br></pre></td></tr></table></figure>

<h3 id="Jedis的常用操作"><a href="#Jedis的常用操作" class="headerlink" title="Jedis的常用操作"></a>Jedis的常用操作</h3><h4 id="API：Key"><a href="#API：Key" class="headerlink" title="API：Key"></a>API：Key</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试操作key</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建Jedis连接</span></span><br><span class="line">    Jedis jedis = createConnect();</span><br><span class="line">    <span class="comment">// KEYS &lt;pattern&gt; 模式串匹配获取键</span></span><br><span class="line">    Set&lt;String&gt; keys = jedis.keys(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(String key : keys) &#123;</span><br><span class="line">        System.out.println(key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// SET &lt;key&gt; &lt;value&gt;, k2不存在时才构造，k3设置15s后过期</span></span><br><span class="line">    jedis.set(<span class="string">&quot;k1&quot;</span>, <span class="string">&quot;value1&quot;</span>);</span><br><span class="line">    jedis.setnx(<span class="string">&quot;k2&quot;</span>, <span class="string">&quot;value2&quot;</span>);</span><br><span class="line">    jedis.setex(<span class="string">&quot;k3&quot;</span>, <span class="number">15</span>, <span class="string">&quot;value3&quot;</span>);</span><br><span class="line">    <span class="comment">// 测试EXISTS</span></span><br><span class="line">    System.out.println(<span class="string">&quot;If exists k1: &quot;</span> + jedis.exists(<span class="string">&quot;k1&quot;</span>));</span><br><span class="line">    System.out.println(<span class="string">&quot;If exists k2, k3, k4: &quot;</span> + jedis.exists(<span class="string">&quot;k2&quot;</span>, <span class="string">&quot;k3&quot;</span>, <span class="string">&quot;k4&quot;</span>));</span><br><span class="line">    <span class="comment">// 测试GET</span></span><br><span class="line">    System.out.println(<span class="string">&quot;k1 is: &quot;</span> + jedis.get(<span class="string">&quot;k1&quot;</span>));</span><br><span class="line">    <span class="comment">// 测试TTL</span></span><br><span class="line">    System.out.println(<span class="string">&quot;k3 will expire after &quot;</span> + jedis.ttl(<span class="string">&quot;k3&quot;</span>) + <span class="string">&quot; seconds!&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;k3 is: &quot;</span> + jedis.get(<span class="string">&quot;k3&quot;</span>));</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 休眠15s</span></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">15</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;k3 will expire after &quot;</span> + jedis.ttl(<span class="string">&quot;k3&quot;</span>) + <span class="string">&quot; seconds!&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;k3 is: &quot;</span> + jedis.get(<span class="string">&quot;k3&quot;</span>));</span><br><span class="line">    jedis.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 测试结果</span></span><br><span class="line">PONG</span><br><span class="line">s3</span><br><span class="line">list1</span><br><span class="line">zset</span><br><span class="line">k1</span><br><span class="line">k2</span><br><span class="line">set1</span><br><span class="line">user</span><br><span class="line">s1</span><br><span class="line">s2</span><br><span class="line">If exists k1: true</span><br><span class="line">If exists k2, k3, k4: 2</span><br><span class="line">k1 is: value1</span><br><span class="line">k3 will expire after 14 seconds!</span><br><span class="line">k3 is: value3</span><br><span class="line">k3 will expire after -2 seconds!</span><br><span class="line">k3 is: null</span><br></pre></td></tr></table></figure>

<h4 id="API：String"><a href="#API：String" class="headerlink" title="API：String"></a>API：String</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试操作String</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建Jedis连接</span></span><br><span class="line">    Jedis jedis = createConnect();</span><br><span class="line">    jedis.mset(<span class="string">&quot;str1&quot;</span>, <span class="string">&quot;meow&quot;</span>, <span class="string">&quot;str2&quot;</span>, <span class="string">&quot;hello&quot;</span>, <span class="string">&quot;str3&quot;</span>, <span class="string">&quot;world&quot;</span>);</span><br><span class="line">    System.out.println(jedis.mget(<span class="string">&quot;str1&quot;</span>, <span class="string">&quot;str2&quot;</span>, <span class="string">&quot;str3&quot;</span>, <span class="string">&quot;strN&quot;</span>));</span><br><span class="line">    jedis.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PONG</span><br><span class="line">[meow, hello, world, null]</span><br></pre></td></tr></table></figure>

<h4 id="API：List"><a href="#API：List" class="headerlink" title="API：List"></a>API：List</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试操作List</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建Jedis连接</span></span><br><span class="line">    Jedis jedis = createConnect();</span><br><span class="line">    List&lt;String&gt; list = jedis.lrange(<span class="string">&quot;list1&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (String s : list) &#123;</span><br><span class="line">        System.out.println(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 测试压入数据</span></span><br><span class="line">    jedis.lpush(<span class="string">&quot;list1&quot;</span>, <span class="string">&quot;hello&quot;</span>, <span class="string">&quot;world&quot;</span>);</span><br><span class="line">    <span class="comment">// 应该输出redis</span></span><br><span class="line">    System.out.println(<span class="string">&quot;The 4th index is: &quot;</span> + jedis.lindex(<span class="string">&quot;list1&quot;</span>, <span class="number">4</span>));</span><br><span class="line">    <span class="comment">// 测试循环弹出数据</span></span><br><span class="line">    <span class="keyword">while</span>(jedis.llen(<span class="string">&quot;list1&quot;</span>) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        System.out.println(jedis.rpop(<span class="string">&quot;list1&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    jedis.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">PONG</span><br><span class="line">5</span><br><span class="line">4</span><br><span class="line">redis</span><br><span class="line">hi</span><br><span class="line">3</span><br><span class="line">2</span><br><span class="line">1</span><br><span class="line">The 4th index is: redis</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">hi</span><br><span class="line">redis</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">hello</span><br><span class="line">world</span><br></pre></td></tr></table></figure>

<h4 id="API：Set"><a href="#API：Set" class="headerlink" title="API：Set"></a>API：Set</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试操作Set</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo4</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建Jedis连接</span></span><br><span class="line">    Jedis jedis = createConnect();</span><br><span class="line">    jedis.sadd(<span class="string">&quot;orders&quot;</span>, <span class="string">&quot;order01&quot;</span>);</span><br><span class="line">    jedis.sadd(<span class="string">&quot;orders&quot;</span>, <span class="string">&quot;order02&quot;</span>);</span><br><span class="line">    jedis.sadd(<span class="string">&quot;orders&quot;</span>, <span class="string">&quot;order03&quot;</span>);</span><br><span class="line">    jedis.sadd(<span class="string">&quot;orders&quot;</span>, <span class="string">&quot;order01&quot;</span>);</span><br><span class="line">    jedis.sadd(<span class="string">&quot;orders&quot;</span>, <span class="string">&quot;order02&quot;</span>);</span><br><span class="line">    Set&lt;String&gt; sMembers = jedis.smembers(<span class="string">&quot;orders&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (String order : sMembers) &#123;</span><br><span class="line">        System.out.println(order);</span><br><span class="line">    &#125;</span><br><span class="line">    jedis.srem(<span class="string">&quot;orders&quot;</span>, <span class="string">&quot;order02&quot;</span>);</span><br><span class="line">    sMembers = jedis.smembers(<span class="string">&quot;orders&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> (String order : sMembers) &#123;</span><br><span class="line">        System.out.println(order);</span><br><span class="line">    &#125;</span><br><span class="line">    jedis.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PONG</span><br><span class="line">order03</span><br><span class="line">order01</span><br><span class="line">order02</span><br><span class="line">order03</span><br><span class="line">order01</span><br></pre></td></tr></table></figure>

<h4 id="API：Hash"><a href="#API：Hash" class="headerlink" title="API：Hash"></a>API：Hash</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试操作Hash</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo5</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建Jedis连接</span></span><br><span class="line">    Jedis jedis = createConnect();</span><br><span class="line">    Map&lt;String, String&gt; val = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    <span class="comment">// 多种方式存入值</span></span><br><span class="line">    val.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;heavytiger&quot;</span>);</span><br><span class="line">    val.put(<span class="string">&quot;age&quot;</span>, <span class="string">&quot;20&quot;</span>);</span><br><span class="line">    val.put(<span class="string">&quot;school&quot;</span>, <span class="string">&quot;wut&quot;</span>);</span><br><span class="line">    jedis.hset(<span class="string">&quot;user&quot;</span>, val);</span><br><span class="line">    jedis.hset(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;gender&quot;</span> , <span class="string">&quot;1&quot;</span>);</span><br><span class="line">    <span class="comment">// 获取hash中的值</span></span><br><span class="line">    <span class="keyword">for</span>(Map.Entry&lt;String, String&gt; item : jedis.hgetAll(<span class="string">&quot;user&quot;</span>).entrySet()) &#123;</span><br><span class="line">        System.out.println(item.getKey() + <span class="string">&quot; is: &quot;</span> + item.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    jedis.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PONG</span><br><span class="line">name is: heavytiger</span><br><span class="line">gender is: 1</span><br><span class="line">school is: wut</span><br><span class="line">age is: 20</span><br></pre></td></tr></table></figure>

<h4 id="API：ZSet"><a href="#API：ZSet" class="headerlink" title="API：ZSet"></a>API：ZSet</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 测试操作ZSet</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">demo6</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建Jedis连接</span></span><br><span class="line">    Jedis jedis = createConnect();</span><br><span class="line">    jedis.zadd(<span class="string">&quot;zSet01&quot;</span>, <span class="number">100d</span>, <span class="string">&quot;z3&quot;</span>);</span><br><span class="line">    jedis.zadd(<span class="string">&quot;zSet01&quot;</span>, <span class="number">90d</span>, <span class="string">&quot;l4&quot;</span>);</span><br><span class="line">    jedis.zadd(<span class="string">&quot;zSet01&quot;</span>, <span class="number">80d</span>, <span class="string">&quot;w5&quot;</span>);</span><br><span class="line">    jedis.zadd(<span class="string">&quot;zSet01&quot;</span>, <span class="number">70d</span>, <span class="string">&quot;z6&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Set&lt;String&gt; zRange1 = jedis.zrange(<span class="string">&quot;zSet01&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (String e : zRange1) &#123;</span><br><span class="line">        System.out.println(e);</span><br><span class="line">    &#125;</span><br><span class="line">    Set&lt;Tuple&gt; zRange2 = jedis.zrangeWithScores(<span class="string">&quot;zset&quot;</span>, <span class="number">0</span>, -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (Tuple tuple : zRange2) &#123;</span><br><span class="line">        System.out.println(tuple.getElement() + <span class="string">&quot; : &quot;</span> + tuple.getScore());</span><br><span class="line">    &#125;</span><br><span class="line">    jedis.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">PONG</span><br><span class="line">z6</span><br><span class="line">w5</span><br><span class="line">l4</span><br><span class="line">z3</span><br><span class="line">Java : 1.0</span><br><span class="line">Python : 10.0</span><br><span class="line">MySQL : 15.0</span><br><span class="line">C++ : 20.0</span><br><span class="line">GoLang : 30.0</span><br></pre></td></tr></table></figure>

<h2 id="SpringBoot整合Redis实例"><a href="#SpringBoot整合Redis实例" class="headerlink" title="SpringBoot整合Redis实例"></a>SpringBoot整合Redis实例</h2><h3 id="实现发送校验手机验证码功能性需求"><a href="#实现发送校验手机验证码功能性需求" class="headerlink" title="实现发送校验手机验证码功能性需求"></a>实现发送校验手机验证码功能性需求</h3><blockquote>
<p><strong>需求：</strong></p>
<ol>
<li>输入手机号，点击发送后随机生成6位数字码，2分钟有效</li>
<li>输入验证码，点击验证，返回成功或失败</li>
<li>每个手机号每天只能输入3次</li>
</ol>
<p><strong>需求分析：</strong></p>
<ol>
<li>随机6位数字验证码可以通过<code>Random.nextInt()</code>生成</li>
<li>验证码2分钟之内有效可以通过将验证码放入<code>Redis</code>中，设置120s后过期实现</li>
<li>从<code>Redis</code>中取出验证码，判断是否一致，若一致成功，不一致错误</li>
<li>使用<code>incr</code>每次发送验证码后<code>+1</code>，值大于2时不能继续发送</li>
</ol>
</blockquote>
<h3 id="代码实现及结果"><a href="#代码实现及结果" class="headerlink" title="代码实现及结果"></a>代码实现及结果</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Calendar;</span><br><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.Scanner;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用Redis实现验证码的相关功能</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> heavytiger</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PhoneCode</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取jedis连接对象</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回获取到的jedis连接对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Jedis <span class="title">createConnect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Jedis jedis = <span class="keyword">new</span> Jedis(<span class="string">&quot;121.xxx.xxx.xxx&quot;</span>, <span class="number">6379</span>);</span><br><span class="line">        jedis.auth(<span class="string">&quot;6o5FLS9b..............iEGf56vE1orO&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> jedis;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取距离当天结束所剩的秒数.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回距离一天结束所剩秒数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getRemainTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Calendar ca = Calendar.getInstance();</span><br><span class="line">        ca.set(Calendar.HOUR_OF_DAY, <span class="number">23</span>);</span><br><span class="line">        ca.set(Calendar.MINUTE, <span class="number">59</span>);</span><br><span class="line">        ca.set(Calendar.SECOND, <span class="number">59</span>);</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) (ca.getTimeInMillis() - System.currentTimeMillis()) / <span class="number">1000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获得验证码.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回生成的验证码</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">createCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Random random = <span class="keyword">new</span> Random(System.currentTimeMillis());</span><br><span class="line">        StringBuffer code = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">            code.append(random.nextInt(<span class="number">10</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> code.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端获取验证码.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> phone 客户端提供的手机号</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getCode</span><span class="params">(String phone)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = createConnect();</span><br><span class="line">        String countKey = <span class="string">&quot;VerifyCode&quot;</span> + phone + <span class="string">&quot;:count&quot;</span>;</span><br><span class="line">        String codeKey = <span class="string">&quot;VerifyCode&quot;</span> + phone + <span class="string">&quot;:code&quot;</span>;</span><br><span class="line">        <span class="comment">// 获取当前该手机号的count，超过3次不再提供验证码</span></span><br><span class="line">        String curCount = jedis.get(countKey);</span><br><span class="line">        <span class="keyword">if</span> (curCount == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 表示此时是第一次发送</span></span><br><span class="line">            jedis.setex(countKey, getRemainTime(), <span class="string">&quot;1&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Integer.parseInt(curCount) &lt;= <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="comment">// 说明该手机号没有到3次，次数加一</span></span><br><span class="line">            jedis.incr(countKey);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 说明改手机号到三次，报错</span></span><br><span class="line">            System.out.println(<span class="string">&quot;您今日获取验证码次数已达三次，请联系客服或明日重试！&quot;</span>);</span><br><span class="line">            jedis.close();</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将验证码存入redis中</span></span><br><span class="line">        String curCode = createCode();</span><br><span class="line">        System.out.println(curCode);</span><br><span class="line">        jedis.setex(codeKey, getRemainTime(), curCode);</span><br><span class="line">        jedis.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">verifyCode</span><span class="params">(String phone, String code)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = createConnect();</span><br><span class="line">        String codeKey = <span class="string">&quot;VerifyCode&quot;</span> + phone + <span class="string">&quot;:code&quot;</span>;</span><br><span class="line">        String curCode = jedis.get(codeKey);</span><br><span class="line">        <span class="keyword">if</span> (code == <span class="keyword">null</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;请输入验证码！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (code.equals(curCode)) &#123;</span><br><span class="line">            <span class="comment">// 此时密码正确</span></span><br><span class="line">            System.out.println(<span class="string">&quot;验证码正确！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;验证码错误或已失效，请重试！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        jedis.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">boolean</span> OK = <span class="keyword">true</span>;</span><br><span class="line">        Scanner scanner = <span class="keyword">new</span> Scanner(System.in);</span><br><span class="line">        PhoneCode phoneCode = <span class="keyword">new</span> PhoneCode();</span><br><span class="line">        <span class="keyword">while</span>(OK) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;1. 生成验证码&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;2. 校验验证码&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;0. 退出&quot;</span>);</span><br><span class="line">            <span class="keyword">int</span> choice = scanner.nextInt();</span><br><span class="line">            <span class="keyword">if</span>(choice == <span class="number">1</span>) &#123;</span><br><span class="line">                String phone = scanner.next();</span><br><span class="line">                phoneCode.getCode(phone);</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (choice == <span class="number">2</span>) &#123;</span><br><span class="line">                String phone = scanner.next();</span><br><span class="line">                String code = scanner.next();</span><br><span class="line">                phoneCode.verifyCode(phone, code);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                OK = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试如下所示：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 测试生成验证码</span></span><br><span class="line">1. 生成验证码</span><br><span class="line">2. 校验验证码</span><br><span class="line">0. 退出</span><br><span class="line">1 15327618888</span><br><span class="line">148400</span><br><span class="line">1. 生成验证码</span><br><span class="line">2. 校验验证码</span><br><span class="line">0. 退出</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 校验成功</span></span><br><span class="line">2 15327618888 148400</span><br><span class="line">验证码正确！</span><br><span class="line">1. 生成验证码</span><br><span class="line">2. 校验验证码</span><br><span class="line">0. 退出</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 验证码错误校验失败</span></span><br><span class="line">2 15327618888 123456</span><br><span class="line">验证码错误或已失效，请重试！</span><br><span class="line">1. 生成验证码</span><br><span class="line">2. 校验验证码</span><br><span class="line">0. 退出</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 手机号不对应查询失败</span></span><br><span class="line">2 15311111111 148400</span><br><span class="line">验证码错误或已失效，请重试！</span><br><span class="line">1. 生成验证码</span><br><span class="line">2. 校验验证码</span><br><span class="line">0. 退出</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 同一手机号三次获取验证码后提示已达三次</span></span><br><span class="line">1 110</span><br><span class="line">476165</span><br><span class="line">1. 生成验证码</span><br><span class="line">2. 校验验证码</span><br><span class="line">0. 退出</span><br><span class="line">1 110</span><br><span class="line">071776</span><br><span class="line">1. 生成验证码</span><br><span class="line">2. 校验验证码</span><br><span class="line">0. 退出</span><br><span class="line">1 110</span><br><span class="line">128346</span><br><span class="line">1. 生成验证码</span><br><span class="line">2. 校验验证码</span><br><span class="line">0. 退出</span><br><span class="line">1 110</span><br><span class="line">您今日获取验证码次数已达三次，请联系客服或明日重试！</span><br><span class="line">1. 生成验证码</span><br><span class="line">2. 校验验证码</span><br><span class="line">0. 退出</span><br><span class="line">0</span><br></pre></td></tr></table></figure>

<h3 id="SpringBoot整合"><a href="#SpringBoot整合" class="headerlink" title="SpringBoot整合"></a>SpringBoot整合</h3><p><strong>在pom.xml文件中引入Redis的相关依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- redis --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- spring2.X集成redis所需common-pool2--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>在application.properties中配置Redis</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Redis服务器地址</span></span><br><span class="line"><span class="meta">spring.redis.host</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="comment">#Redis连接密码</span></span><br><span class="line"><span class="meta">spring.redis.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="comment">#Redis服务器连接端口</span></span><br><span class="line"><span class="meta">spring.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="comment">#Redis数据库索引（默认为0）</span></span><br><span class="line"><span class="meta">spring.redis.database</span>= <span class="string">0</span></span><br><span class="line"><span class="comment">#连接超时时间（毫秒）</span></span><br><span class="line"><span class="meta">spring.redis.timeout</span>=<span class="string">1800000</span></span><br><span class="line"><span class="comment">#连接池最大连接数（使用负值表示没有限制）</span></span><br><span class="line"><span class="meta">spring.redis.lettuce.pool.max-active</span>=<span class="string">20</span></span><br><span class="line"><span class="comment">#最大阻塞等待时间(负数表示没限制)</span></span><br><span class="line"><span class="meta">spring.redis.lettuce.pool.max-wait</span>=<span class="string">-1</span></span><br><span class="line"><span class="comment">#连接池中的最大空闲连接</span></span><br><span class="line"><span class="meta">spring.redis.lettuce.pool.max-idle</span>=<span class="string">5</span></span><br><span class="line"><span class="comment">#连接池中的最小空闲连接</span></span><br><span class="line"><span class="meta">spring.redis.lettuce.pool.min-idle</span>=<span class="string">0</span></span><br></pre></td></tr></table></figure>

<p><strong>在/config/下添加redis配置类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> <span class="keyword">extends</span> <span class="title">CachingConfigurerSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title">redisTemplate</span><span class="params">(RedisConnectionFactory factory)</span> </span>&#123;</span><br><span class="line">        RedisTemplate&lt;String, Object&gt; template = <span class="keyword">new</span> RedisTemplate&lt;&gt;();</span><br><span class="line">        RedisSerializer&lt;String&gt; redisSerializer = <span class="keyword">new</span> StringRedisSerializer();</span><br><span class="line">        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer(Object.class);</span><br><span class="line">        ObjectMapper om = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class="line">        template.setConnectionFactory(factory);</span><br><span class="line"><span class="comment">//key序列化方式</span></span><br><span class="line">        template.setKeySerializer(redisSerializer);</span><br><span class="line"><span class="comment">//value序列化</span></span><br><span class="line">        template.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line"><span class="comment">//value hashmap序列化</span></span><br><span class="line">        template.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        <span class="keyword">return</span> template;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">(RedisConnectionFactory factory)</span> </span>&#123;</span><br><span class="line">        RedisSerializer&lt;String&gt; redisSerializer = <span class="keyword">new</span> StringRedisSerializer();</span><br><span class="line">        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer(Object.class);</span><br><span class="line"><span class="comment">//解决查询缓存转换异常的问题</span></span><br><span class="line">        ObjectMapper om = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class="line"><span class="comment">// 配置序列化（解决乱码的问题）,过期时间600秒</span></span><br><span class="line">        RedisCacheConfiguration config = RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">                .entryTtl(Duration.ofSeconds(<span class="number">600</span>))</span><br><span class="line">                .serializeKeysWith(RedisSerializationContext.SerializationPair.fromSerializer(redisSerializer))</span><br><span class="line">                .serializeValuesWith(RedisSerializationContext.SerializationPair.fromSerializer(jackson2JsonRedisSerializer))</span><br><span class="line">                .disableCachingNullValues();</span><br><span class="line">        RedisCacheManager cacheManager = RedisCacheManager.builder(factory)</span><br><span class="line">                .cacheDefaults(config)</span><br><span class="line">                .build();</span><br><span class="line">        <span class="keyword">return</span> cacheManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/testRedis&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisTestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testRedis</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//设置值到redis</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;heavytiger&quot;</span>);</span><br><span class="line">        <span class="comment">//从redis获取值</span></span><br><span class="line">        String name = (String)redisTemplate.opsForValue().get(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Redis事务"><a href="#Redis事务" class="headerlink" title="Redis事务"></a>Redis事务</h2><h3 id="事务的定义"><a href="#事务的定义" class="headerlink" title="事务的定义"></a>事务的定义</h3><p>Redis事务是一个单独的隔离操作，事务中的所有命令都会被序列化按顺序地执行，事务在执行的过程中，不会被其他的客户端发送过来的命令请求所打断</p>
<p>Redis事务地主要作用就是<strong>串联多个命令</strong>，防止其他的命令在中间插队使得结果出现偏差</p>
<h3 id="Multi、Exec、Discard"><a href="#Multi、Exec、Discard" class="headerlink" title="Multi、Exec、Discard"></a>Multi、Exec、Discard</h3><p>从输入<code>Multi</code>命令开始，输入的命令都会依次进入命令队列中，但不会执行，直到输入<code>Exec</code>后，Redis会将之前的命令队列中的命令依次执行。组队的过程中可以通过<code>discard</code>来放弃组队。</p>
<p><img src="image-20220127164809897.png" alt="image-20220127164809897"></p>
<p>在输入<code>multi</code>后，事务开启，在中间输入的所有命令都会进入队列中等待，在输入<code>exec</code>执行命令后，所有队列中的命令被依次执行。当组队阶段出现任何问题时，组队都将失败，此时执行<code>exec</code>命令会提示之前存在错误，无法执行。</p>
<h3 id="事务的错误处理"><a href="#事务的错误处理" class="headerlink" title="事务的错误处理"></a>事务的错误处理</h3><p>若组队中的某个命令出现了报错，执行时所有队列中的命令都会被取消。</p>
<p><img src="image-20220127165228796.png" alt="image-20220127165228796"></p>
<p>若执行阶段时，某个命令才出现报错，那么只有这个报错的命令被取消，其余的所有命令仍会继续执行，不会回滚</p>
<p><img src="image-20220127165321307.png" alt="image-20220127165321307"></p>
<h3 id="事务冲突问题"><a href="#事务冲突问题" class="headerlink" title="事务冲突问题"></a>事务冲突问题</h3><p>假设银行卡余额有10000，有三个人同时使用余额交易，分别花了8000，5000，2000，此时如果不加锁机制，则会产生事务冲突，导致某一笔交易出现问题。</p>
<h4 id="悲观锁"><a href="#悲观锁" class="headerlink" title="悲观锁"></a>悲观锁</h4><p><strong>悲观锁(<code>Pessimistic Lock</code>)</strong>, 顾名思义，就是很悲观对待每次数据获取，每次去拿数据的时候都认为别人会修改，所以每次在拿数据的时候都会上锁，这样别人想拿这个数据就会block直到它拿到锁。<strong>传统的关系型数据库里边就用到了很多这种锁机制</strong>，比如<strong>行锁</strong>，<strong>表锁</strong>等，<strong>读锁</strong>，<strong>写锁</strong>等，都是在做操作之前先上锁。</p>
<p><img src="image-20220127212236873.png" alt="image-20220127212236873"></p>
<h4 id="乐观锁"><a href="#乐观锁" class="headerlink" title="乐观锁"></a>乐观锁</h4><p><strong>乐观锁(<code>Optimistic Lock</code>)</strong>, 顾名思义，就是很乐观，每次去拿数据的时候都认为别人不会修改，所以不会上锁，但是在更新的时候会判断一下在此期间别人有没有去更新这个数据，可以使用版本号等机制。<strong>乐观锁适用于多读的应用类型，这样可以提高吞吐量</strong>。<strong>Redis就是利用这种check-and-set机制实现事务的。</strong></p>
<p><img src="image-20220127212311020.png" alt="image-20220127212311020"></p>
<h4 id="WATCH-key-key-…"><a href="#WATCH-key-key-…" class="headerlink" title="WATCH key [key … ]"></a>WATCH key [key … ]</h4><p>在执行<code>multi</code>之前，先执行<code>WATCH key1 [key2 ... ]</code>，可以监视一个或多个<code>key</code>，如果在事务执行之前，这个或这些<code>key</code>被其他命令所改动，那么该事务会被打断，不予执行。</p>
<h4 id="UNWATCH-key-key-…"><a href="#UNWATCH-key-key-…" class="headerlink" title="UNWATCH key [key … ]"></a>UNWATCH key [key … ]</h4><p>取消<code>WATCH</code>命令对所有的<code>key</code>的监视</p>
<p>如果在执行<code>WATCH</code>命令之后，<code>EXEC</code>命令或<code>DISCARD</code>命令被执行的话，就不再需要执行<code>UNWATCH</code>了</p>
<h3 id="事务的三特性"><a href="#事务的三特性" class="headerlink" title="事务的三特性"></a>事务的三特性</h3><ul>
<li><p><strong>单独的隔离操作</strong> </p>
<p>事务中的所有命令都会序列化、按顺序地执行。事务在执行的过程中，不会被其他客户端发送来的命令请求所打断。 </p>
</li>
<li><p><strong>没有隔离级别的概念</strong> </p>
<p>队列中的命令没有提交之前都不会实际被执行，因为事务提交前任何指令都不会被实际执行</p>
</li>
<li><p><strong>不保证原子性</strong> </p>
<p>事务中如果有一条命令执行失败，其后的命令仍然会被执行，没有回滚 </p>
</li>
</ul>
<h2 id="Redis秒杀案例"><a href="#Redis秒杀案例" class="headerlink" title="Redis秒杀案例"></a>Redis秒杀案例</h2><h3 id="秒杀中存在的问题"><a href="#秒杀中存在的问题" class="headerlink" title="秒杀中存在的问题"></a>秒杀中存在的问题</h3><ol>
<li>高并发下可能会产生超卖问题，即卖出的商品多于库存</li>
<li>高并发下可能会产生超时问题，即来不及处理导致连接超时</li>
<li>使用乐观锁导致很多请求失败，先点击的没有秒杀到商品，后点击的反而抢到了商品，商品库存很多的情况下卖完了仍有库存，但是之前抢失败的用户无法购买了，还剩很多库存。</li>
</ol>
<h3 id="问题解决方案"><a href="#问题解决方案" class="headerlink" title="问题解决方案"></a>问题解决方案</h3><ol>
<li>可以使用事务和乐观锁进行处理，可以解决超卖问题，但是仍会存在2，3的问题</li>
<li>可以加入<code>JedisPool</code>连接池，解决获取连接超时问题</li>
<li>可以使用<code>LUA</code>脚本解决问题，将复杂或多步的Redis操作改写为一个脚本，一次性提交给Redis执行，减少了反复连接Redis的次数，能提高性能。</li>
</ol>
<blockquote>
<p><strong>Lua</strong>是一个小巧的脚本语言，Lua脚本可以很容易的被C/C++ 代码调用，也可以反过来调用C/C++的函数，Lua并没有提供强大的库，一个完整的Lua解释器不过200k，所以Lua不适合作为开发独立应用程序的语言，而是作为嵌入式脚本语言。</p>
<p>很多应用程序、游戏使用LUA作为自己的嵌入式脚本语言，以此来实现可配置性、可扩展性。</p>
<p>这其中包括魔兽争霸地图、魔兽世界、博德之门、愤怒的小鸟等众多游戏插件或外挂。</p>
<p>LUA脚本是类似redis事务，有一定的原子性，不会被其他命令插队，可以完成一些redis事务性的操作。</p>
<p><strong>但是注意redis的lua脚本功能，只有在Redis 2.6以上的版本才可以使用。</strong></p>
<p>利用lua脚本淘汰用户，解决超卖问题。</p>
<p>redis 2.6版本以后，通过lua脚本解决<strong>争抢问题</strong>，实际上是<strong>redis</strong> <strong>利用其单线程的特性，用任务队列的方式解决多任务并发问题</strong>。</p>
</blockquote>
<h3 id="代码及运行效果"><a href="#代码及运行效果" class="headerlink" title="代码及运行效果"></a>代码及运行效果</h3><p><strong>创建Jedis连接池</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.heavytiger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPoolConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JedisPoolUtil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> JedisPool jedisPool = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">JedisPoolUtil</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> JedisPool <span class="title">getJedisPoolInstance</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 单例模式创建Redis线程池</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == jedisPool) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (JedisPoolUtil.class) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> == jedisPool) &#123;</span><br><span class="line">                    JedisPoolConfig poolConfig = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">                    poolConfig.setMaxTotal(<span class="number">200</span>);</span><br><span class="line">                    poolConfig.setMaxIdle(<span class="number">32</span>);</span><br><span class="line">                    poolConfig.setMaxWaitMillis(<span class="number">100</span> * <span class="number">1000</span>);</span><br><span class="line">                    poolConfig.setBlockWhenExhausted(<span class="keyword">true</span>);</span><br><span class="line">                    poolConfig.setTestOnBorrow(<span class="keyword">true</span>);  <span class="comment">// ping  PONG</span></span><br><span class="line"></span><br><span class="line">                    jedisPool = <span class="keyword">new</span> JedisPool(poolConfig, <span class="string">&quot;121.xxx.xxx.xxx&quot;</span>, <span class="number">6379</span>, <span class="number">60000</span>,</span><br><span class="line">                            <span class="string">&quot;6o5FLS9b..............f56vE1orO&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> jedisPool;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>秒杀service，此方法存在问题3，加乐观锁导致剩库存</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.heavytiger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Transaction;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 使用Redis实现秒杀场景的数据缓存，减轻频繁访问数据库的压力</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecKill_redis</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//秒杀过程</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">doSecKill</span><span class="params">(String uid,String prodid)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">		<span class="comment">//1 uid和prodid非空判断</span></span><br><span class="line">		<span class="keyword">if</span>(uid == <span class="keyword">null</span> || prodid == <span class="keyword">null</span>) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//2 连接redis</span></span><br><span class="line">		<span class="comment">//通过连接池得到jedis对象</span></span><br><span class="line">		JedisPool jedisPoolInstance = JedisPoolUtil.getJedisPoolInstance();</span><br><span class="line">		Jedis jedis = jedisPoolInstance.getResource();</span><br><span class="line"></span><br><span class="line">		<span class="comment">//3 拼接key</span></span><br><span class="line">		<span class="comment">// 3.1 库存key</span></span><br><span class="line">		String kcKey = <span class="string">&quot;sk:&quot;</span>+prodid+<span class="string">&quot;:qt&quot;</span>;</span><br><span class="line">		<span class="comment">// 3.2 秒杀成功用户key</span></span><br><span class="line">		String userKey = <span class="string">&quot;sk:&quot;</span>+prodid+<span class="string">&quot;:user&quot;</span>;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//监视库存，加乐观锁，之后的事务中若版本不一致将提交失败，因此会导致剩库存问题</span></span><br><span class="line">		jedis.watch(kcKey);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//4 获取库存，如果库存null，秒杀还没有开始</span></span><br><span class="line">		String kc = jedis.get(kcKey);</span><br><span class="line">		<span class="keyword">if</span>(kc == <span class="keyword">null</span>) &#123;</span><br><span class="line">			System.out.println(<span class="string">&quot;秒杀还没有开始，请等待&quot;</span>);</span><br><span class="line">			jedis.close();</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 5 判断用户是否重复秒杀操作</span></span><br><span class="line">		<span class="keyword">if</span>(jedis.sismember(userKey, uid)) &#123;</span><br><span class="line">			System.out.println(<span class="string">&quot;已经秒杀成功了，不能重复秒杀&quot;</span>);</span><br><span class="line">			jedis.close();</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//6 判断如果商品数量，库存数量小于1，秒杀结束</span></span><br><span class="line">		<span class="keyword">if</span>(Integer.parseInt(kc)&lt;=<span class="number">0</span>) &#123;</span><br><span class="line">			System.out.println(<span class="string">&quot;秒杀已经结束了&quot;</span>);</span><br><span class="line">			jedis.close();</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//7 秒杀过程</span></span><br><span class="line">		<span class="comment">//使用事务</span></span><br><span class="line">		Transaction multi = jedis.multi();</span><br><span class="line"></span><br><span class="line">		<span class="comment">//组队操作</span></span><br><span class="line">		multi.decr(kcKey);</span><br><span class="line">		multi.sadd(userKey,uid);</span><br><span class="line"></span><br><span class="line">		<span class="comment">//执行</span></span><br><span class="line">		List&lt;Object&gt; results = multi.exec();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span>(results == <span class="keyword">null</span> || results.size()==<span class="number">0</span>) &#123;</span><br><span class="line">			System.out.println(<span class="string">&quot;秒杀失败了....&quot;</span>);</span><br><span class="line">			jedis.close();</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">//7.1 库存-1</span></span><br><span class="line">		<span class="comment">//jedis.decr(kcKey);</span></span><br><span class="line">		<span class="comment">//7.2 把秒杀成功用户添加清单里面</span></span><br><span class="line">		<span class="comment">//jedis.sadd(userKey,uid);</span></span><br><span class="line"></span><br><span class="line">		System.out.println(<span class="string">&quot;秒杀成功了..&quot;</span>);</span><br><span class="line">		jedis.close();</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>修改后使用LUA脚本解决问题</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.heavytiger;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.HostAndPort;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.Jedis;</span><br><span class="line"><span class="keyword">import</span> redis.clients.jedis.JedisPool;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecKill_redisByScript</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.slf4j.Logger logger = LoggerFactory.getLogger(SecKill_redisByScript.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> String secKillScript = <span class="string">&quot;local userid=KEYS[1];\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;local prodid=KEYS[2];\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;local qtkey=&#x27;sk:&#x27;..prodid..\&quot;:qt\&quot;;\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;local usersKey=&#x27;sk:&#x27;..prodid..\&quot;:usr\&quot;;\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;local userExists=redis.call(\&quot;sismember\&quot;,usersKey,userid);\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;if tonumber(userExists)==1 then \r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;   return 2;\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;end\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;local num= redis.call(\&quot;get\&quot; ,qtkey);\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;if tonumber(num)&lt;=0 then \r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;   return 0;\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;else \r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;   redis.call(\&quot;decr\&quot;,qtkey);\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;   redis.call(\&quot;sadd\&quot;,usersKey,userid);\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;end\r\n&quot;</span> +</span><br><span class="line">            <span class="string">&quot;return 1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> String secKillScript2 =</span><br><span class="line">            <span class="string">&quot;local userExists=redis.call(\&quot;sismember\&quot;,\&quot;&#123;sk&#125;:0101:usr\&quot;,userid);\r\n&quot;</span> +</span><br><span class="line">                    <span class="string">&quot; return 1&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">doSecKill</span><span class="params">(String uid, String prodid)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">        JedisPool jedispool = JedisPoolUtil.getJedisPoolInstance();</span><br><span class="line">        Jedis jedis = jedispool.getResource();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 导入Lua脚本</span></span><br><span class="line">        String sha1 = jedis.scriptLoad(secKillScript);</span><br><span class="line">        <span class="comment">// 运行Lua脚本，提供两个参数，分别为uid和prodid，使用Object接受返回值</span></span><br><span class="line">        Object result = jedis.evalsha(sha1, <span class="number">2</span>, uid, prodid);</span><br><span class="line"></span><br><span class="line">        String reString = String.valueOf(result);</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;0&quot;</span>.equals(reString)) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;已抢空！！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;1&quot;</span>.equals(reString)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;抢购成功！！！！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;2&quot;</span>.equals(reString)) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;该用户已抢过！！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;抢购异常！！&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        jedis.close();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>LUA脚本如下所示</strong></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> userid=KEYS[<span class="number">1</span>]; </span><br><span class="line"><span class="keyword">local</span> prodid=KEYS[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">local</span> qtkey=<span class="string">&quot;sk:&quot;</span>..prodid..<span class="string">&quot;:qt&quot;</span>;</span><br><span class="line"><span class="keyword">local</span> usersKey=<span class="string">&quot;sk:&quot;</span>..prodid.<span class="string">&quot;:usr&#x27;; </span></span><br><span class="line"><span class="string">local userExists=redis.call(&quot;</span>sismember<span class="string">&quot;,usersKey,userid);</span></span><br><span class="line"><span class="string">if tonumber(userExists)==1 then </span></span><br><span class="line"><span class="string">  return 2;</span></span><br><span class="line"><span class="string">end</span></span><br><span class="line"><span class="string">local num= redis.call(&quot;</span>get<span class="string">&quot; ,qtkey);</span></span><br><span class="line"><span class="string">if tonumber(num)&lt;=0 then </span></span><br><span class="line"><span class="string">  return 0; </span></span><br><span class="line"><span class="string">else </span></span><br><span class="line"><span class="string">  redis.call(&quot;</span>decr<span class="string">&quot;,qtkey);</span></span><br><span class="line"><span class="string">  redis.call(&quot;</span>sadd<span class="string">&quot;,usersKey,userid);</span></span><br><span class="line"><span class="string">end</span></span><br><span class="line"><span class="string">return 1;</span></span><br></pre></td></tr></table></figure>

<p><strong>秒杀操作Servlet</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecKillServlet</span> <span class="keyword">extends</span> <span class="title">HttpServlet</span> </span>&#123;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">SecKillServlet</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPost</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">		String userid = <span class="keyword">new</span> Random().nextInt(<span class="number">50000</span>) +<span class="string">&quot;&quot;</span> ;</span><br><span class="line">		String prodid =request.getParameter(<span class="string">&quot;prodid&quot;</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//boolean isSuccess=SecKill_redis.doSecKill(userid,prodid);</span></span><br><span class="line">		<span class="keyword">boolean</span> isSuccess= SecKill_redisByScript.doSecKill(userid,prodid);</span><br><span class="line">		response.getWriter().print(isSuccess);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>jsp页面</strong></p>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span></span><br><span class="line">    pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br><span class="line">&lt;!DOCTYPE html PUBLIC <span class="string">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span> <span class="string">&quot;http://www.w3.org/TR/html4/loose.dtd&quot;</span>&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta http-equiv=<span class="string">&quot;Content-Type&quot;</span> content=<span class="string">&quot;text/html; charset=UTF-8&quot;</span>&gt;</span><br><span class="line">&lt;title&gt;Insert title here&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;iPhone <span class="number">13</span> Pro !!!  <span class="number">1</span>元秒杀！！！</span><br><span class="line">&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;form id=<span class="string">&quot;msform&quot;</span> action=<span class="string">&quot;$&#123;pageContext.request.contextPath&#125;/doseckill&quot;</span> enctype=<span class="string">&quot;application/x-www-form-urlencoded&quot;</span>&gt;</span><br><span class="line">	&lt;input type=<span class="string">&quot;hidden&quot;</span> id=<span class="string">&quot;prodid&quot;</span> name=<span class="string">&quot;prodid&quot;</span> value=<span class="string">&quot;0101&quot;</span>&gt;</span><br><span class="line">	&lt;input type=<span class="string">&quot;button&quot;</span>  id=<span class="string">&quot;miaosha_btn&quot;</span> name=<span class="string">&quot;seckill_btn&quot;</span> value=<span class="string">&quot;秒杀点我&quot;</span>/&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;script  type=<span class="string">&quot;text/javascript&quot;</span> src=<span class="string">&quot;$&#123;pageContext.request.contextPath&#125;/script/jquery/jquery-3.1.0.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;script  type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">$(function()&#123;</span><br><span class="line">	$(<span class="string">&quot;#miaosha_btn&quot;</span>).click(function()&#123;	 </span><br><span class="line">		<span class="keyword">var</span> url=$(<span class="string">&quot;#msform&quot;</span>).attr(<span class="string">&quot;action&quot;</span>);</span><br><span class="line">	     $.post(url,$(<span class="string">&quot;#msform&quot;</span>).serialize(),function(data)&#123;</span><br><span class="line">     		<span class="keyword">if</span>(data==<span class="string">&quot;false&quot;</span>)&#123;</span><br><span class="line">    			alert(<span class="string">&quot;抢光了&quot;</span> );</span><br><span class="line">    			$(<span class="string">&quot;#miaosha_btn&quot;</span>).attr(<span class="string">&quot;disabled&quot;</span>,<span class="keyword">true</span>);</span><br><span class="line">    		&#125;</span><br><span class="line">		&#125; );    </span><br><span class="line">	&#125;)</span><br><span class="line">&#125;)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>

<p><strong>测试结果如下</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Redis结果显示</span></span><br><span class="line">127.0.0.1:6379&gt; FLUSHDB</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set sk:0101:qt 10</span><br><span class="line">OK</span><br><span class="line"><span class="meta">#</span><span class="bash"> 10件商品进行抢购</span></span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;sk:0101:usr&quot;</span><br><span class="line">2) &quot;sk:0101:qt&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 抢购后结果如下</span></span><br><span class="line">127.0.0.1:6379&gt; get sk:0101:qt</span><br><span class="line">&quot;0&quot;</span><br><span class="line">127.0.0.1:6379&gt; SMEMBERS sk:0101:usr</span><br><span class="line"> 1) &quot;2004&quot;</span><br><span class="line"> 2) &quot;12176&quot;</span><br><span class="line"> 3) &quot;15858&quot;</span><br><span class="line"> 4) &quot;21790&quot;</span><br><span class="line"> 5) &quot;24473&quot;</span><br><span class="line"> 6) &quot;25066&quot;</span><br><span class="line"> 7) &quot;26166&quot;</span><br><span class="line"> 8) &quot;32644&quot;</span><br><span class="line"> 9) &quot;37576&quot;</span><br><span class="line">10) &quot;41021&quot;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tomcat服务器输出结果</span></span><br><span class="line">抢购成功！！！！</span><br><span class="line">抢购成功！！！！</span><br><span class="line">抢购成功！！！！</span><br><span class="line">抢购成功！！！！</span><br><span class="line">抢购成功！！！！</span><br><span class="line">抢购成功！！！！</span><br><span class="line">抢购成功！！！！</span><br><span class="line">抢购成功！！！！</span><br><span class="line">抢购成功！！！！</span><br><span class="line">抢购成功！！！！</span><br><span class="line">已抢空！！</span><br><span class="line">已抢空！！</span><br><span class="line">已抢空！！</span><br><span class="line">已抢空！！</span><br><span class="line">已抢空！！</span><br></pre></td></tr></table></figure>

<h2 id="Redis持久化"><a href="#Redis持久化" class="headerlink" title="Redis持久化"></a>Redis持久化</h2><h3 id="RDB持久化"><a href="#RDB持久化" class="headerlink" title="RDB持久化"></a>RDB持久化</h3><h4 id="RDB持久化简介"><a href="#RDB持久化简介" class="headerlink" title="RDB持久化简介"></a>RDB持久化简介</h4><p>在<strong>指定的时间间隔内</strong>将内存中的数据集快照写入磁盘，也就是<code>Snapshot快照</code>，<strong>它恢复时是将快照文件直接读到内存里</strong></p>
<blockquote>
<p><strong>RDB持久化流程：</strong></p>
<p>Redis会单独创建（fork）一个子进程来进行持久化，会先将数据写入到 一个临时文件中，待持久化过程都结束了，再用这个临时文件替换上次持久化好的文件。 整个过程中，主进程是不进行任何IO操作的，这就确保了极高的性能 如果需要进行大规模数据的恢复，且对于数据恢复的完整性不是非常敏感，那RDB方式要比AOF方式更加的高效。<strong>RDB的缺点是最后一次持久化后的数据可能丢失</strong>。</p>
<p><strong>Fork介绍：</strong></p>
<ul>
<li>Fork的作用是复制一个与当前进程一样的进程。新进程的所有数据（变量、环境变量、程序计数器等）数值都和原进程一致，但是是一个全新的进程，并作为原进程的子进程</li>
<li>在Linux程序中，fork()会产生一个和父进程完全相同的子进程，但子进程在此后多会exec系统调用，出于效率考虑，Linux中引入了<strong>写时复制技术</strong></li>
<li><strong>一般情况父进程和子进程会共用同一段物理内存</strong>，只有进程空间的各段的内容要发生变化时，才会将父进程的内容复制一份给子进程。</li>
</ul>
<p><strong>持久化流程图：</strong></p>
<p><img src="image-20220129164417936.png" alt="image-20220129164417936"></p>
</blockquote>
<h4 id="RDB使用方法"><a href="#RDB使用方法" class="headerlink" title="RDB使用方法"></a>RDB使用方法</h4><p><strong>1.配置备份文件名称</strong></p>
<p>文件名称默认是<code>dump.rdb</code>，若要进行修改，可以去配置文件<code>redis.conf</code>中进行修改<code>dbfilename</code>配置后的属性值</p>
<p><strong>2.配置rdb文件存放位置</strong></p>
<p>rdb文件默认为Redis启动时命令行所在的目录下(一般为<code>/usr/local/bin</code>目录)，通过<code>redis.conf</code>的<code>dir</code>配置中的值决定。</p>
<p><strong>3.保持策略触发快照</strong></p>
<p>在<code>redis.conf</code>配置文件中存在<code>save 60 10000</code>等参数，默认被注释掉，意思是若在<code>60s</code>之内存在<code>10000</code>次对key的修改，此时将进行快照</p>
<p>有两种命令也可以直接触发快照，<code>save</code>&amp;<code>bgsave</code>命令，<strong>save只管保存，其它不管，全部阻塞，手动保存，不建议。bgsave会在后台异步进行快照操作，快照同时还可以响应客户端请求。</strong></p>
<p>执行<code>flushall</code>命令也会产生<code>dump.rdb</code>文件，但是为空无意义，使用<code>lastsave</code>将获取最近的一次成功执行快照的时间。</p>
<blockquote>
<p><strong>相关配置：</strong></p>
<ol>
<li><code>stop-writes-on-bgsave-error</code> 当Redis无法写入磁盘的话，直接关掉Redis的写操作，默认为yes.</li>
<li><code>rdbcompression</code> 对于存储到磁盘中的快照，可以设置是否进行压缩存储。如果是的话，redis会采用<code>LZF</code>算法进行压缩，默认为<code>yes</code>。</li>
<li><code>rdbchecksum</code> 在存储快照后，可以让redis使用<code>CRC64</code>算法来进行数据校验，但是这样做会增加大约10%的性能消耗，如果希望获取到最大的性能提升，可以关闭此功能，推荐<code>yes</code></li>
</ol>
</blockquote>
<h4 id="RDB的备份恢复流程"><a href="#RDB的备份恢复流程" class="headerlink" title="RDB的备份恢复流程"></a>RDB的备份恢复流程</h4><p><strong>1.将<code>dump.rdb</code>文件修改名备份到别的目录</strong></p>
<p>​    <code>cp dump.rdb temp.rdb</code></p>
<p><strong>2. 关闭Redis(一般要数据恢复的原因也是因为Redis突然挂掉)</strong></p>
<p><strong>3. 将备份的文件拷贝到工作路径下改回<code>dump.rdb</code>，启动Redis会直接加载备份数据</strong></p>
<h4 id="RDB的优劣势"><a href="#RDB的优劣势" class="headerlink" title="RDB的优劣势"></a>RDB的优劣势</h4><p><strong>优势</strong></p>
<ul>
<li>适合大规模的数据恢复</li>
<li>对数据完整性和一致性要求不高更适合使用</li>
<li>节省磁盘空间</li>
<li>恢复速度快</li>
</ul>
<p><strong>劣势</strong></p>
<ul>
<li>Fork的时候，内存中的数据被克隆了一份，大致2倍的膨胀性需要考虑</li>
<li>虽然Redis在fork时使用了<strong>写时拷贝技术</strong>,但是如果数据庞大时还是比较消耗性能。</li>
<li>在备份周期在一定间隔时间做一次备份，所以如果Redis意外down掉的话，就会丢失最后一次快照后的所有修改。</li>
</ul>
<h3 id="AOF持久化"><a href="#AOF持久化" class="headerlink" title="AOF持久化"></a>AOF持久化</h3><h4 id="AOF持久化简介"><a href="#AOF持久化简介" class="headerlink" title="AOF持久化简介"></a>AOF持久化简介</h4><p>以<strong>日志</strong>的形式来记录每个写操作（增量保存），将Redis执行过的所有写指令记录下来(<strong>读操作不记录</strong>)， <strong>只许追加文件但不可以改写文件</strong>，redis启动之初会读取该文件重新构建数据，换言之，redis 重启的话就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作</p>
<blockquote>
<p><strong>AOF持久化流程</strong></p>
<ol>
<li>客户端的请求写命令会被append追加到AOF缓冲区内；</li>
<li>AOF缓冲区根据AOF持久化策略[always,everysec,no]将操作sync同步到磁盘的AOF文件中；</li>
<li>AOF文件大小超过重写策略或手动重写时，会对AOF文件rewrite重写，压缩AOF文件容量；</li>
<li>Redis服务重启时，会重新load加载AOF文件中的写操作达到数据恢复的目的；</li>
</ol>
<p><strong>相关问题</strong></p>
<ol>
<li>AOF默认不开启，可以在redis.conf中配置文件名称，默认为<code>appendonly.aof</code></li>
<li>AOF和RDB同时开启，系统默认取AOF的数据（<strong>因为数据不会存在丢失</strong>）</li>
</ol>
</blockquote>
<h4 id="异常恢复"><a href="#异常恢复" class="headerlink" title="异常恢复"></a>异常恢复</h4><ul>
<li>修改默认的<code>appendonly no</code>，改为<code>yes</code></li>
<li>如遇到<strong>AOF文件损坏</strong>，通过<code>/usr/local/bin/redis-check-aof--fix appendonly.aof</code>进行恢复</li>
<li>备份被写坏的AOF文件</li>
<li>恢复：重启redis，然后重新加载</li>
</ul>
<h4 id="相关配置"><a href="#相关配置" class="headerlink" title="相关配置"></a>相关配置</h4><ol>
<li><p>AOF同步频率设置</p>
<ol>
<li><p><code>appendfsync always</code></p>
<p>始终同步，每次Redis的写入都会立刻记入日志；性能较差但数据完整性比较好</p>
</li>
<li><p><code>appendfsync everysec</code></p>
<p>每秒同步，每秒记入日志一次，如果宕机，本秒的数据可能丢失。</p>
</li>
<li><p><code>appendfsync no</code></p>
<p>redis不主动进行同步，<strong>把同步时机交给操作系统</strong>。</p>
</li>
</ol>
</li>
<li><p>Rewrite压缩</p>
<ol>
<li><p>AOF采用文件追加的方式，文件会越来越大为避免出现此种情况，新增了重写机制, 当AOF文件的大小超过所设定的阈值时，Redis就会启动AOF文件的内容压缩，只保留可以恢复数据的最小指令集.可以使用命令<code>bgrewriteaof</code>执行，<strong>原理为：fork出一个新进程重写，只关注最终结果，将冗杂的操作步骤替换成尽可能少的步骤</strong></p>
</li>
<li><p>触发条件</p>
<blockquote>
<p>Redis会记录上次重写时的AOF大小，默认配置是当AOF文件大小是上次rewrite后大小的一倍且文件大于64M时触发</p>
<p>重写虽然可以节约大量磁盘空间，减少恢复时间。但是每次重写还是有一定的负担的，因此设定Redis要满足一定条件才会进行重写。 </p>
<p><code>auto-aof-rewrite-percentage</code>：设置重写的基准值，默认文件增量达到100%时开始重写（文件是原来重写后文件的2倍时触发）</p>
<p><code>auto-aof-rewrite-min-size</code>：设置重写的基准值，默认最小文件64MB。达到这个值开始重写。</p>
<p>例如：文件达到70MB开始重写，降到50MB，下次什么时候开始重写？100MB</p>
<p>系统载入时或者上次重写完毕时，Redis会记录此时AOF大小，设为base_size,</p>
<p>IF <code>cur_size &gt;= base_size + base_size * percentage(100%)</code> &amp;&amp; <code>cur_size &gt;= min_size(64MB)</code>的情况下，Redis会对AOF进行重写。</p>
</blockquote>
</li>
<li><p>重写流程</p>
<blockquote>
<ol>
<li><p><code>bgrewriteaof</code>触发重写，判断是否当前有<code>bgsave</code>或<code>bgrewriteaof</code>在运行，如果有，则等待该命令结束后再继续执行。</p>
</li>
<li><p>主进程<code>fork</code>出子进程执行重写操作，保证主进程不会阻塞。</p>
</li>
<li><p>子进程遍历redis内存中数据到临时文件，客户端的写请求同时写入<code>aof_buf</code>缓冲区和<code>aof_rewrite_buf</code>重写缓冲区保证原AOF文件完整以及新AOF文件生成期间的新的数据修改动作不会丢失。</p>
</li>
<li><p>子进程写完新的AOF文件后，向主进程发信号，父进程更新统计信息。</p>
</li>
<li><p>主进程把<code>aof_rewrite_buf</code>中的数据写入到新的AOF文件。</p>
</li>
<li><p>使用新的AOF文件覆盖旧的AOF文件，完成AOF重写。    </p>
</li>
</ol>
</blockquote>
</li>
</ol>
</li>
</ol>
<h4 id="AOF的优劣势"><a href="#AOF的优劣势" class="headerlink" title="AOF的优劣势"></a>AOF的优劣势</h4><p><strong>优势</strong></p>
<ul>
<li>备份机制更稳健，丢失数据概率更低。</li>
<li>可读的日志文本，通过操作AOF稳健，可以处理误操作。</li>
</ul>
<p><strong>劣势</strong></p>
<ul>
<li>比起RDB占用更多的磁盘空间。</li>
<li>恢复备份速度要慢。</li>
<li>每次读写都同步的话，有一定的性能压力。</li>
<li>存在个别Bug，造成恢复不能。</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><blockquote>
<p>官方推荐两个都启用。</p>
<p>如果对数据不敏感，可以选单独用RDB。</p>
<p>不建议单独用 AOF，因为可能会出现Bug。</p>
<p>如果只是做纯内存缓存，可以都不用。</p>
</blockquote>
<h2 id="Redis主从复制"><a href="#Redis主从复制" class="headerlink" title="Redis主从复制"></a>Redis主从复制</h2><h3 id="什么是主从复制"><a href="#什么是主从复制" class="headerlink" title="什么是主从复制"></a>什么是主从复制</h3><p>主机数据更新后根据配置和策略， 自动同步到备机的<code>master/slaver</code>机制，<strong>Master以写为主，Slave以读为主</strong></p>
<p>这样可以实现读写分离，性能扩展，容灾快速恢复等功能</p>
<h3 id="搭建主从环境"><a href="#搭建主从环境" class="headerlink" title="搭建主从环境"></a>搭建主从环境</h3><p>由于没有多台云服务器，因此使用一台开多个端口实现主从复制的环境，原理为创建多个配置文件，分别通过这些配置文件开启<code>redis-server</code>，本次环境搭建使用<code>1主2从</code>配置</p>
<p><strong>配置文件内容</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 以redis6379.conf为例</span> </span><br><span class="line">include /usr/local/dbBackup/redis/redis.conf</span><br><span class="line">pidfile /var/run/redis_6379.pid</span><br><span class="line">port 6379</span><br><span class="line">dbfilename dump6379.rdb</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ls</span></span><br><span class="line">redis6379.conf  redis6380.conf  redis6381.conf  redis.conf</span><br></pre></td></tr></table></figure>

<p><strong>启动3个服务</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS redis]# redis-server /usr/local/dbBackup/redis/redis6379.conf</span><br><span class="line">[root@CentOS redis]# redis-server /usr/local/dbBackup/redis/redis6380.conf</span><br><span class="line">[root@CentOS redis]# redis-server /usr/local/dbBackup/redis/redis6381.conf</span><br><span class="line">[root@CentOS redis]# ps -ef | grep redis</span><br><span class="line">root      505404       1  0 22:04 ?        00:00:00 redis-server *:6379</span><br><span class="line">root      505410       1  0 22:04 ?        00:00:00 redis-server *:6380</span><br><span class="line">root      505416       1  0 22:04 ?        00:00:00 redis-server *:6381</span><br><span class="line">root      505422  504948  0 22:04 pts/1    00:00:00 grep --color=auto redis</span><br></pre></td></tr></table></figure>

<p><strong>查看服务运行情况</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 选择端口连接服务</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> redis-cli -p 6379 -a 6o5FLS..........lyqJWxiEGf56vE1orO</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> redis-cli -p 6380 -a 6o5FLS..........lyqJWxiEGf56vE1orO</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> redis-cli -p 6381 -a 6o5FLS..........lyqJWxiEGf56vE1orO</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 6379为主服务master</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 127.0.0.1:6379&gt; INFO replication</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:5755185537a056e2924171ae2ef15f3046a51a5b</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:0</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 6380为主服务master</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 127.0.0.1:6380&gt; INFO replication</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:82a18c130081c64623ded446a958e1647fa271e0</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:0</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 6381为主服务master</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 127.0.0.1:6381&gt; INFO replication</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:0a9d18bf383123dc81e23a963796183f62bee05f</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:0</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br></pre></td></tr></table></figure>

<p><strong>配置从机</strong></p>
<p>若主机设置了密码，需要在从机配置文件中加上<code>masterauth password</code></p>
<p>从机使用<code>slaveof &lt;ip&gt; &lt;port&gt;</code>连接到主机，也可以直接加入从机配置文件中，启动服务将自动连接</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 6379端口主机查看详情，显示有两台从机</span></span><br><span class="line">127.0.0.1:6379&gt; INFO replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=84,lag=0</span><br><span class="line">slave1:ip=127.0.0.1,port=6381,state=online,offset=84,lag=1</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:121d997c9f2d16b45322f2929e66c68ac404eb5b</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:84</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:84</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 6380端口从机查看详情，连接状态为up</span></span><br><span class="line">127.0.0.1:6380&gt; INFO replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:4</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_read_repl_offset:56</span><br><span class="line">slave_repl_offset:56</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">replica_announced:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:121d997c9f2d16b45322f2929e66c68ac404eb5b</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:56</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:56</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 6381端口从机查看详情，连接状态为up</span></span><br><span class="line">127.0.0.1:6381&gt; INFO replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:6</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_read_repl_offset:70</span><br><span class="line">slave_repl_offset:70</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">replica_announced:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:121d997c9f2d16b45322f2929e66c68ac404eb5b</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:70</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:15</span><br><span class="line">repl_backlog_histlen:56</span><br></pre></td></tr></table></figure>

<p><strong>读写分离测试</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set s1 v1</span><br><span class="line">OK</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 主机写入的数据可以在从机读取</span></span><br><span class="line">127.0.0.1:6380&gt; get s1</span><br><span class="line">&quot;v1&quot;</span><br><span class="line">127.0.0.1:6381&gt; keys *</span><br><span class="line">1) &quot;s1&quot;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 从机禁止写入数据</span></span><br><span class="line">127.0.0.1:6381&gt; set k2 v2</span><br><span class="line">(error) READONLY You can&#x27;t write against a read only replica.</span><br></pre></td></tr></table></figure>

<p>主机挂掉后直接重启就行，但是从机要重设<code>slaveof</code>，加入到配置文件中将永久生效，不需要多次配置</p>
<h3 id="一主二仆"><a href="#一主二仆" class="headerlink" title="一主二仆"></a>一主二仆</h3><p>主从复制存在如下问题：</p>
<ol>
<li><p><strong>切入点问题</strong> (若<code>master</code>已写入数据，从机<code>slave2</code>挂掉，重连后恢复之前的数据吗？)</p>
<blockquote>
<p>能！从机挂掉后，会从头恢复主机中的所有数据</p>
</blockquote>
</li>
<li><p>主机挂掉后，从机上位还是待命等到主机？</p>
<blockquote>
<p>等待主机！大哥永远是大哥，从机会等主机 “东山再起”</p>
<p>从机<code>INFO replication</code>后，<code>master_link_status</code>从<code>up</code>变为<code>down</code>，但是<code>role</code>仍为<code>slave</code>且保留主服务器的连接信息</p>
<p>主机重启后自动连接从机，宕机期间redis暂时失去写功能，只有读功能</p>
</blockquote>
</li>
</ol>
<h3 id="薪火相传"><a href="#薪火相传" class="headerlink" title="薪火相传"></a>薪火相传</h3><p>一台主机同步2-3台从机可能没有问题，但是从机的数量很多时，将导致同步的开销过大，因此可以类似二叉树的造型来<strong>薪火相传</strong>，从机只找自己的父节点同步数据，这样一台主机只对应两台从机，从机再将数据同步给其他的从机。</p>
<p><code>slave</code>作为了链条中下一个的<code>master</code>, 可以有效减轻<code>master</code>的写压力,去中心化降低风险。</p>
<blockquote>
<p>用 <code>slaveof &lt;ip&gt; &lt;port&gt;</code></p>
<p>中途变更转向:会清除之前的数据，重新建立拷贝最新的</p>
<p>风险是一旦某个<code>slave</code>宕机，后面的<code>slave</code>都没法复制</p>
<p>主机挂了，从机还是从机，可以读，只是无法写数据了</p>
</blockquote>
<h3 id="反客为主"><a href="#反客为主" class="headerlink" title="反客为主"></a>反客为主</h3><p>当一个<code>master</code>宕机后，后面的<code>slave</code>可以立刻升为<code>master</code>，其后面的<code>slave</code>不用做任何修改。</p>
<p>只需要在从机输入命令<code>slaveof no one</code>，将该从机变为主机，其后从机不做修改。</p>
<h3 id="主从复制原理"><a href="#主从复制原理" class="headerlink" title="主从复制原理"></a>主从复制原理</h3><ol>
<li><code>Slave</code>启动成功连接到<code>master</code>后会发送一个<code>sync</code>命令，请求主机同步数据</li>
<li><code>Master</code>接到命令启动后台的存盘进程(<strong>进行持久化存盘为rdb文件</strong>)，同时收集所有接收到的用于修改数据集命令，在后台进程执行完毕之后，<code>master</code>将传送整个数据文件(<strong>rdb文件</strong>)到<code>slave</code>，从机执行<code>flushall</code>后恢复rdb文件以完成一次完全同步</li>
<li><strong>全量复制</strong>：<code>slave</code>服务在接收到数据库文件数据后，将其存盘并加载到内存中。</li>
<li><strong>增量复制</strong>：<code>Master</code>继续将新的所有收集到的修改命令依次传给<code>slave</code>,完成同步</li>
<li><code>slave</code>只要是重新连接<code>master</code>，一次完全同步(全量复制)将被自动执行</li>
</ol>
<h3 id="哨兵模式"><a href="#哨兵模式" class="headerlink" title="哨兵模式"></a>哨兵模式</h3><h4 id="简介-5"><a href="#简介-5" class="headerlink" title="简介"></a>简介</h4><p>哨兵模式是反客为主的自动升级版，反客为主还需要运维人员手动切换，但是哨兵模式将自动完成主从的切换，在主机挂掉后自动根据投票数指派从机作为主机</p>
<h4 id="哨兵模式实现"><a href="#哨兵模式实现" class="headerlink" title="哨兵模式实现"></a>哨兵模式实现</h4><p><strong>1.在目录下新建<code>sentinel.conf</code>文件</strong></p>
<p><code>touch /usr/local/dbBackup/redis/sentinel.conf</code></p>
<p><strong>2.配置哨兵，填写相关内容</strong></p>
<p><code>vim /usr/local/dbBackup/redis/sentinel.conf</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 该配置指定哨兵观测本机6379端口，将该主机命名为mymaster，有一个哨兵允许切换后，直接切换主从</span></span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 1</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可选开启，设为yes后，设置为守护进程，允许在后台运行</span></span><br><span class="line">daemonize yes</span><br></pre></td></tr></table></figure>

<p><strong>3.启动哨兵</strong></p>
<p>执行<code>redis-sentinel /usr/local/dbBackup/redis/sentinel.conf --sentinel</code></p>
<p><strong>4.测试哨兵功能</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 将master主机手动挂掉</span></span><br><span class="line">127.0.0.1:6379&gt; shutdown</span><br><span class="line">not connected&gt; </span><br><span class="line"><span class="meta">#</span><span class="bash"> 等待sentinel哨兵做出反应选举出新的主机，哨兵选举新主机如下</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 碰到了主机挂掉后无法切换主从的问题，原因是从机也有password，需要在主机配置文件和sentinel中设置密码</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 主机的redis.conf中也要设置其他从机的密码</span></span><br><span class="line">masterauth password</span><br><span class="line"><span class="meta">#</span><span class="bash"> 哨兵配置文件中也要设置主从机密码，密码应该保证一致</span></span><br><span class="line">sentinel auth-pass mymaster password</span><br><span class="line"><span class="meta">#</span><span class="bash"> 此时，哨兵才知道主机和从机的配置，之前不设置密码是无法连接的</span></span><br><span class="line">506732:X 30 Jan 2022 11:09:05.389 # +monitor master mymaster 127.0.0.1 6379 quorum 1</span><br><span class="line">506732:X 30 Jan 2022 11:09:05.391 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379</span><br><span class="line">506732:X 30 Jan 2022 11:09:05.394 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 此时若主机挂掉，从机会自动上位，主机再次连接后，变成从机</span></span><br><span class="line">506732:X 30 Jan 2022 11:11:20.844 # +sdown master mymaster 127.0.0.1 6379</span><br><span class="line">506732:X 30 Jan 2022 11:11:20.844 # +odown master mymaster 127.0.0.1 6379 #quorum 1/1</span><br><span class="line">506732:X 30 Jan 2022 11:11:20.844 # +new-epoch 7</span><br><span class="line">506732:X 30 Jan 2022 11:11:20.844 # +try-failover master mymaster 127.0.0.1 6379</span><br><span class="line">506732:X 30 Jan 2022 11:11:20.847 # +vote-for-leader 3c577838b1155d034ecafbad3854918cc5473220 7</span><br><span class="line">506732:X 30 Jan 2022 11:11:20.847 # +elected-leader master mymaster 127.0.0.1 6379</span><br><span class="line">506732:X 30 Jan 2022 11:11:20.847 # +failover-state-select-slave master mymaster 127.0.0.1 6379</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 选举了6380作为此时的主机mymaster</span></span><br><span class="line">506732:X 30 Jan 2022 11:11:20.930 # +selected-slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379</span><br><span class="line">506732:X 30 Jan 2022 11:11:20.930 * +failover-state-send-slaveof-noone slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379</span><br><span class="line">506732:X 30 Jan 2022 11:11:20.982 * +failover-state-wait-promotion slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379</span><br><span class="line">506732:X 30 Jan 2022 11:11:21.632 # +promoted-slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6379</span><br><span class="line">506732:X 30 Jan 2022 11:11:21.632 # +failover-state-reconf-slaves master mymaster 127.0.0.1 6379</span><br><span class="line">506732:X 30 Jan 2022 11:11:21.694 * +slave-reconf-sent slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379</span><br><span class="line">506732:X 30 Jan 2022 11:11:22.677 * +slave-reconf-inprog slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379</span><br><span class="line">506732:X 30 Jan 2022 11:11:22.677 * +slave-reconf-done slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379</span><br><span class="line">506732:X 30 Jan 2022 11:11:22.735 # +failover-end master mymaster 127.0.0.1 6379</span><br><span class="line">506732:X 30 Jan 2022 11:11:22.735 # +switch-master mymaster 127.0.0.1 6379 127.0.0.1 6380</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 此时6379变为从机</span> </span><br><span class="line">506732:X 30 Jan 2022 11:11:22.735 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6380</span><br><span class="line">506732:X 30 Jan 2022 11:11:22.735 * +slave slave 127.0.0.1:6379 127.0.0.1 6379 @ mymaster 127.0.0.1 6380</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6380</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:1</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_read_repl_offset:17058</span><br><span class="line">slave_repl_offset:17058</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">replica_announced:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:6e0aa18c6c8ee1750aa8a84acdd23f2ea2876581</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:17058</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:15944</span><br><span class="line">repl_backlog_histlen:1115</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 此时6380成为主机，6379上线后变为从机</span></span><br><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line"><span class="meta">#</span><span class="bash"> Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=127.0.0.1,port=6381,state=online,offset=19228,lag=0</span><br><span class="line">slave1:ip=127.0.0.1,port=6379,state=online,offset=19228,lag=0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:6e0aa18c6c8ee1750aa8a84acdd23f2ea2876581</span><br><span class="line">master_replid2:7285213316fc0f8f3c3d66d22fcd8d79e3b33051</span><br><span class="line">master_repl_offset:19228</span><br><span class="line">second_repl_offset:6961</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:19228</span><br></pre></td></tr></table></figure>

<p><img src="image-20220130111620706.png" alt="image-20220130111620706"></p>
<blockquote>
<p><strong>优先级在redis.conf中默认：replica-priority 100，值越小优先级越高</strong></p>
<p>偏移量是指获得原主机数据最全的</p>
<p>每个redis实例启动后都会随机生成一个40位的runid</p>
</blockquote>
<h4 id="Java连接池修改"><a href="#Java连接池修改" class="headerlink" title="Java连接池修改"></a>Java连接池修改</h4><p>java连接池需要做出相应的修改</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> JedisSentinelPool jedisSentinelPool = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Jedis <span class="title">getJedisFromSentinel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span>(jedisSentinelPool==<span class="keyword">null</span>)&#123;</span><br><span class="line">    	Set&lt;String&gt; sentinelSet=<span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">    	sentinelSet.add(<span class="string">&quot;xxx.xxx.xxx.xxx:26379&quot;</span>);</span><br><span class="line"></span><br><span class="line">    	JedisPoolConfig jedisPoolConfig =<span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">    	jedisPoolConfig.setMaxTotal(<span class="number">10</span>); 				<span class="comment">// 最大可用连接数</span></span><br><span class="line">		jedisPoolConfig.setMaxIdle(<span class="number">5</span>); 					<span class="comment">// 最大闲置连接数</span></span><br><span class="line">		jedisPoolConfig.setMinIdle(<span class="number">5</span>); 					<span class="comment">// 最小闲置连接数</span></span><br><span class="line">		jedisPoolConfig.setBlockWhenExhausted(<span class="keyword">true</span>); 	<span class="comment">// 连接耗尽是否等待</span></span><br><span class="line">		jedisPoolConfig.setMaxWaitMillis(<span class="number">2000</span>); 		<span class="comment">// 等待时间</span></span><br><span class="line">		jedisPoolConfig.setTestOnBorrow(<span class="keyword">true</span>); 			<span class="comment">// 取连接的时候测试 ping pong</span></span><br><span class="line">		<span class="comment">// 从jedis连接池的哨兵监控进程中获取mymaster主从机相关配置</span></span><br><span class="line">		jedisSentinelPool=<span class="keyword">new</span> JedisSentinelPool(<span class="string">&quot;mymaster&quot;</span>,sentinelSet,jedisPoolConfig);</span><br><span class="line">		<span class="keyword">return</span> jedisSentinelPool.getResource();</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> jedisSentinelPool.getResource();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Redis集群"><a href="#Redis集群" class="headerlink" title="Redis集群"></a>Redis集群</h2><h3 id="集群简介"><a href="#集群简介" class="headerlink" title="集群简介"></a>集群简介</h3><p>容量不够，redis如何进行扩容？</p>
<p>并发写操作， redis如何分摊？</p>
<p>另外，主从模式，薪火相传模式，主机宕机，导致ip地址发生变化，应用程序中配置需要修改对应的主机地址、端口等信息。</p>
<p>之前通过<strong>代理主机</strong>来解决，但是redis3.0中提供了解决方案。就是<strong>无中心化集</strong></p>
<p><strong>群配置</strong>。集群就是用来解决这些而问题的。</p>
<p><strong>Redis 集群实现了对Redis的水平扩容，即启动N个redis节点，将整个数据库分布存储在这N个节点中，每个节点存储总数据的1/N。</strong></p>
<p>Redis 集群通过分区（<code>partition</code>）来提供一定程度的可用性（<code>availability</code>）： 即使集群中有一部分节点失效或者无法进行通讯， 集群也可以继续处理命令请求。</p>
<blockquote>
<p><code>Cluster</code>模式推荐最少有6个节点。Cluster模式是数据分开存放在不同的节点上，如果有6个节点，通常设置3个主节点，每个主节点有一个从节点作为备份。正常情况下读写操作的是主节点，从节点会同步主节点的更变。当某个主节点挂了之后，其对应的从节点会变成主节点。如果一段时间后之前挂掉的主节点恢复了，它将变成从节点。如果某个主节点挂了之后，其对应的从节点也挂了，集群将不可访问。即每个主节点相互独立，从节点作为主节点的备份。</p>
</blockquote>
<h3 id="集群搭建"><a href="#集群搭建" class="headerlink" title="集群搭建"></a>集群搭建</h3><p><strong>1.删除持久化数据</strong></p>
<p>将路径中的rdb，aof文件全部删除</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">find . -name &quot;*.rdb&quot; | xargs rm -rf</span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行结果</span></span><br><span class="line">[root@CentOS redis]# find . -name &quot;*.rdb&quot; | xargs rm -rf</span><br><span class="line">[root@CentOS redis]# ls</span><br><span class="line">redis6379.conf  redis6380.conf  redis6381.conf  redis.conf  sentinel.conf</span><br></pre></td></tr></table></figure>

<p><strong>2.制作六个server实例，分别开放6379，6380，6381，6389，6390，6391端口作为集群</strong></p>
<p>配置<code>redis cluster</code>，相关参数如下所示：</p>
<blockquote>
<p><code>cluster-enabled yes</code>  打开集群模式</p>
<p><code>cluster-config-file nodes-6379.conf</code> 设定节点配置文件名</p>
<p><code>cluster-node-timeout 15000</code>  设定节点失联时间，超过该时间（毫秒），集群自动进行主从切换。</p>
</blockquote>
<p>配置文件如下所示，以<code>6379</code>为例子：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">include /usr/local/dbBackup/redis/redis.conf</span><br><span class="line">port 6379</span><br><span class="line">pidfile &quot;/var/run/redis_6379.pid&quot;</span><br><span class="line">dbfilename &quot;dump6379.rdb&quot;</span><br><span class="line">dir &quot;/usr/local/dbBackup/redis_cluster&quot;</span><br><span class="line">logfile &quot;/usr/local/dbBackup/redis_cluster/redis_err_6379.log&quot;</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes-6379.conf</span><br><span class="line">cluster-node-timeout 15000</span><br></pre></td></tr></table></figure>

<p>使用<code>sed</code>命令，查找替换其他文本中的内容<code>sed &#39;s/source/target/g&#39; filename</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 表示在redis6380.conf文件中全局搜索替换，s表示搜索其后的6379，g表示全局替换为6380</span></span><br><span class="line">[root@CentOS redis]# sed &#x27;s/6379/6380/g&#x27; redis6380.conf </span><br><span class="line">include /usr/local/dbBackup/redis/redis.conf</span><br><span class="line">port 6380</span><br><span class="line">pidfile &quot;/var/run/redis_6380.pid&quot;</span><br><span class="line">dbfilename &quot;dump6380.rdb&quot;</span><br><span class="line">dir &quot;/usr/local/dbBackup/redis_cluster&quot;</span><br><span class="line">logfile &quot;/usr/local/dbBackup/redis_cluster/redis_err_6380.log&quot;</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes-6380.conf</span><br><span class="line">cluster-node-timeout 15000</span><br><span class="line">[root@CentOS redis]# sed -i &#x27;s/6379/6381/g&#x27; redis6381.conf </span><br><span class="line">[root@CentOS redis]# sed -i &#x27;s/6379/6389/g&#x27; redis6389.conf </span><br><span class="line">[root@CentOS redis]# sed -i &#x27;s/6379/6390/g&#x27; redis6390.conf </span><br><span class="line">[root@CentOS redis]# sed -i &#x27;s/6379/6391/g&#x27; redis6391.conf </span><br></pre></td></tr></table></figure>

<p>由于设置了密码，因此从机连接到主机时会需要<code>masterauth</code>参数，可以使用如下语句添加：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 通配符查找并将masterauth添加到末尾</span></span><br><span class="line">find . -name &#x27;redis????.conf&#x27; | xargs sed -i &quot;$ a masterauth 6o5FLS9bSJm......6vE1orO&quot;</span><br></pre></td></tr></table></figure>

<p><strong>3.搭建完成后启动集群(开启6个服务)</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@CentOS redis]# redis-server redis6379.conf </span><br><span class="line">[root@CentOS redis]# redis-server redis6380.conf </span><br><span class="line">[root@CentOS redis]# redis-server redis6381.conf </span><br><span class="line">[root@CentOS redis]# redis-server redis6389.conf </span><br><span class="line">[root@CentOS redis]# redis-server redis6390.conf </span><br><span class="line">[root@CentOS redis]# redis-server redis6391.conf </span><br><span class="line">[root@CentOS redis]# ps -ef | grep redis</span><br><span class="line">root      509954       1  0 15:06 ?        00:00:00 redis-server *:6379 [cluster]</span><br><span class="line">root      509960       1  0 15:06 ?        00:00:00 redis-server *:6380 [cluster]</span><br><span class="line">root      509966       1  0 15:06 ?        00:00:00 redis-server *:6381 [cluster]</span><br><span class="line">root      509972       1  0 15:07 ?        00:00:00 redis-server *:6389 [cluster]</span><br><span class="line">root      509978       1  0 15:07 ?        00:00:00 redis-server *:6390 [cluster]</span><br><span class="line">root      509984       1  0 15:07 ?        00:00:00 redis-server *:6391 [cluster]</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到日志文件，结点文件已经在设定的文件夹下创建成功</span></span><br><span class="line">[root@CentOS dbBackup]# cd redis_cluster/</span><br><span class="line">[root@CentOS redis_cluster]# ls</span><br><span class="line">nodes-6379.conf  nodes-6389.conf  redis_err_6379.log  redis_err_6389.log</span><br><span class="line">nodes-6380.conf  nodes-6390.conf  redis_err_6380.log  redis_err_6390.log</span><br><span class="line">nodes-6381.conf  nodes-6391.conf  redis_err_6381.log  redis_err_6391.log</span><br></pre></td></tr></table></figure>

<p><strong>4.将六个结点合成一个集群</strong></p>
<p>首先在组合之前，要确保所有redis实例启动后，nodes-xxxx.conf文件都生成正常。</p>
<p>在上述的<code>ls</code>命令后，可以看到文件均已经正常生成，因此可以合成集群</p>
<p>在<code>Redis 6</code>中，已经有<code>ruby</code>环境，不需要手动安装，可以直接结合成一个集群</p>
<p>进入之前安装redis的<code>src</code>目录中，输入命令<code>cd /usr/local/redis/src</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster create --cluster-replicas 1 -a 6o5FLS9bSJmdTGlyqJWxiEGf56vE1orO 127.0.0.1:6379 127.0.0.1:6380 127.0.0.1:6381 127.0.0.1:6389 127.0.0.1:6390 127.0.0.1:6391</span><br></pre></td></tr></table></figure>

<blockquote>
<p><code>--cluster-replicas 1</code>表示采用最简单的方式配置集群，即一台主机存储数据，一台从机做冗余备份，正好三组，若服务存在密码，需要<code>-a</code>输入密码</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 输入上述命令后集群分配完成</span></span><br><span class="line">Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 6 nodes...</span></span><br><span class="line">Master[0] -&gt; Slots 0 - 5460</span><br><span class="line">Master[1] -&gt; Slots 5461 - 10922</span><br><span class="line">Master[2] -&gt; Slots 10923 - 16383</span><br><span class="line">Adding replica 127.0.0.1:6390 to 127.0.0.1:6379</span><br><span class="line">Adding replica 127.0.0.1:6391 to 127.0.0.1:6380</span><br><span class="line">Adding replica 127.0.0.1:6389 to 127.0.0.1:6381</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Trying to optimize slaves allocation <span class="keyword">for</span> anti-affinity</span></span><br><span class="line">[WARNING] Some slaves are in the same host as their master</span><br><span class="line">M: c9f227690a410075699ba85f19df4afe9b9cb1a5 127.0.0.1:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">M: beeb9abad9c2b862110a4b4e174f8994b70dc0ce 127.0.0.1:6380</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">M: 85fed45d7009d92c24d1f718aaab5fa0b14d23ef 127.0.0.1:6381</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">S: 84f87182c207465adcef4213540836466735b34e 127.0.0.1:6389</span><br><span class="line">   replicates beeb9abad9c2b862110a4b4e174f8994b70dc0ce</span><br><span class="line">S: b490572ff5e41c090c55f6d124dd4dbe7229ef8d 127.0.0.1:6390</span><br><span class="line">   replicates 85fed45d7009d92c24d1f718aaab5fa0b14d23ef</span><br><span class="line">S: b1ac18fcaf0475a004f74138fe141f8a5411a9c9 127.0.0.1:6391</span><br><span class="line">   replicates c9f227690a410075699ba85f19df4afe9b9cb1a5</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 输入yes允许按照上述master &amp; slaver分配</span></span><br><span class="line"></span><br><span class="line">Can I set the above configuration? (type &#x27;yes&#x27; to accept): yes</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Nodes configuration updated</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Assign a different config epoch to each node</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span></span><br><span class="line">Waiting for the cluster to join</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Performing Cluster Check (using node 127.0.0.1:6379)</span></span><br><span class="line">M: c9f227690a410075699ba85f19df4afe9b9cb1a5 127.0.0.1:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 84f87182c207465adcef4213540836466735b34e 127.0.0.1:6389</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates beeb9abad9c2b862110a4b4e174f8994b70dc0ce</span><br><span class="line">M: beeb9abad9c2b862110a4b4e174f8994b70dc0ce 127.0.0.1:6380</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 85fed45d7009d92c24d1f718aaab5fa0b14d23ef 127.0.0.1:6381</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: b490572ff5e41c090c55f6d124dd4dbe7229ef8d 127.0.0.1:6390</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 85fed45d7009d92c24d1f718aaab5fa0b14d23ef</span><br><span class="line">S: b1ac18fcaf0475a004f74138fe141f8a5411a9c9 127.0.0.1:6391</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates c9f227690a410075699ba85f19df4afe9b9cb1a5</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check <span class="keyword">for</span> open slots...</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check slots coverage...</span></span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure>

<p><strong>集群的分配原则应该尽量保证每个主数据库运行在不同的IP地址，每个从库和主库不在同一个IP地址上（否则岂不是一台机器宕机，主从全挂了，那从机冗余意义何在？）</strong></p>
<blockquote>
<p><strong>注意事项：</strong></p>
<p>在使用springboot连接集群时出现超时的情况，且多次连接仍然无法解决，经查询，是因为在创建集群时使用<code>127.0.0.1</code>，没有走<code>TCP</code>连接，若要允许外网访问，应该设置为<code>真实IP地址</code>，完成后外网即可访问。</p>
<p><code>redis-cli --cluster create --cluster-replicas 1 -a 6o5FLS9bSJmdTGlyqJWxiEGf56vE1orO 121.xxx.xxx.31:6379 121.xxx.xxx.31:6380 121.xxx.xxx.31:6381 121.xxx.xxx.31:6389 121.xxx.xxx.31:6390 121.xxx.xxx.31:6391</code></p>
<p>需要重新停止服务后，删除所有<code>rdb</code>以及<code>node</code>文件，此外，由于开放了外网连接，需要在防火墙中进行相关的配置。若出现<code>Waiting for the cluster to join</code>提示，且之后一直无响应，原因是每个 <code>Redis</code> 集群节点都需要打开两个 <code>TCP</code> 连接。服务客户端的普通<code>Redis TCP</code>端口，比如<code>6379</code>，加上数据端口加上<code>10000</code>得到的端口，所以也要开放是<code>16379</code>。</p>
<p>在开放完所有端口后，即可正常使用。</p>
</blockquote>
<h3 id="集群操作"><a href="#集群操作" class="headerlink" title="集群操作"></a>集群操作</h3><p><strong>1.采用集群策略连接到Redis集群</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -c -a password -p 6379 </span><br></pre></td></tr></table></figure>

<p><code>-c</code>表示采取集群策略连接，在设置数据后，会自动切换到相应的写主机</p>
<p>使用<code>cluster nodes</code>命令可以查看集群的信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; cluster nodes</span><br><span class="line">84f87182c207465adcef4213540836466735b34e 127.0.0.1:6389@16389 slave beeb9abad9c2b862110a4b4e174f8994b70dc0ce 0 1643700901000 2 connected</span><br><span class="line">beeb9abad9c2b862110a4b4e174f8994b70dc0ce 127.0.0.1:6380@16380 master - 0 1643700902089 2 connected 5461-10922</span><br><span class="line">85fed45d7009d92c24d1f718aaab5fa0b14d23ef 127.0.0.1:6381@16381 master - 0 1643700901000 3 connected 10923-16383</span><br><span class="line">c9f227690a410075699ba85f19df4afe9b9cb1a5 127.0.0.1:6379@16379 myself,master - 0 1643700900000 1 connected 0-5460</span><br><span class="line">b490572ff5e41c090c55f6d124dd4dbe7229ef8d 127.0.0.1:6390@16390 slave 85fed45d7009d92c24d1f718aaab5fa0b14d23ef 0 1643700903092 3 connected</span><br><span class="line">b1ac18fcaf0475a004f74138fe141f8a5411a9c9 127.0.0.1:6391@16391 slave c9f227690a410075699ba85f19df4afe9b9cb1a5 0 1643700901087 1 connected</span><br></pre></td></tr></table></figure>

<p><strong>2.什么是slots？</strong></p>
<p>一个<code>Redis</code>集群包含<code>16384</code>个插槽(<code>hash slot</code>)，数据库中的每个键都属于这<code>16384</code>个插槽的其中一个， </p>
<p>集群使用公式 <code>CRC16(key) % 16384</code> 来计算键<code>key</code>属于哪个槽，其中<code>CRC16(key)</code>语句用于计算键<code>key</code>的<code>CRC16</code>校验和。集群中的每个节点负责处理一部分插槽。类似于<code>hash</code>一样，计算hash值进行散列，判断该值应该归哪个主机存储，这样可以做出分布式存储的效果。</p>
<blockquote>
<p><strong>举例说明</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">127.0.0.1:6379@16379 myself,master - 0 1643700900000 1 connected 0-5460</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">127.0.0.1:6380@16380 master - 0 1643700902089 2 connected 5461-10922</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">127.0.0.1:6381@16381 master - 0 1643700901000 3 connected 10923-16383</span></span><br></pre></td></tr></table></figure>

<p>本次集群布置，节点<code>6379</code>负责处理<code>0</code>号至<code>5460</code>号插槽。</p>
<p>节点<code>6380</code>负责处理<code>5461</code>号至<code>10922</code>号插槽。</p>
<p>节点<code>6381</code>负责处理<code>10923</code>号至<code>16383</code>号插槽。</p>
<p><strong>为什么选择<code>mod 16384</code>？</strong></p>
<p>集群在工作时，会定期发送<code>ping/pong</code>消息交换数据，知道彼此的状态</p>
<p>传递时肯定会存在消息体消息头等信息</p>
<p>消息头中最占空间的是<code>unsigned char myslots[CLUSTER_SLOTS/8]</code>，这块类似于<code>bitmap</code>每一个位代表一个槽，该位置为1表示槽属于发送消息的结点。此块存储的信息大小为：<code>16384÷8÷1024=2kb</code></p>
<p>在消息体中也会携带其他结点的信息用于交换，携带的约为总结点数的1/10，至少3个。</p>
<p>(1)如果槽位为<code>65536</code>，发送心跳信息的消息头达<code>8k</code>，发送的<code>ping/pong</code>包过于庞大。<br>如上所述，在消息头中，最占空间的是<code>myslots[CLUSTER_SLOTS/8]</code>。当槽位为<code>65536</code>时，这块的大小是:<code>65536÷8÷1024=8kb</code></p>
<p>(2)redis的集群主节点数量基本不可能超过<code>1000</code>个。<br>如上所述，集群节点越多，心跳包的消息体内携带的数据越多。如果节点过1000个，也会导致网络拥堵。那么，对于节点数在1000以内的redis cluster集群，16384个槽位够用了。没有必要拓展到65536个。</p>
<p>(3)槽位越小，节点少的情况下，压缩比高<br>Redis主节点的配置信息中，它所负责的哈希槽是通过一张<code>bitmap</code>的形式来保存的，在传输过程中，会对bitmap进行压缩，但是如果<code>bitmap</code>的填充率<code>slots / N</code>很高的话(N表示节点数)，<code>bitmap</code>的压缩率就很低。</p>
</blockquote>
<p><strong>3.相关操作</strong></p>
<p>不在一个<code>slot</code>下的键，无法使用<code>mget</code>和<code>mset</code>等多键的操作，可以用<code>&#123;name&#125;</code>来定义组的概念，从而使得<code>&#123;name&#125;</code>内值相同的内容的键值对放入一个slot中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MSET age&#123;user&#125; 20 name&#123;user&#125;heavytiger</span><br></pre></td></tr></table></figure>

<p>可以使用<code>CLUSTER KEYSLOT &lt;name&gt;</code>查找组被放置在哪个插槽中</p>
<p>可以使用<code>CLUSTER COUNTKEYSINSLOT &lt;slot&gt;</code>查找该插槽中的键的数量，<strong>但是需要保证该插槽在该集群结点被分配的<code>slot</code>范围内，否则查询到的结果为<code>0</code></strong></p>
<p>可以使用<code>CLUSTER GETKEYSINSLOT &lt;slot&gt; &lt;count&gt;</code> 返回<code>count</code>个<code>slot</code>槽中的键。</p>
<h3 id="集群故障恢复"><a href="#集群故障恢复" class="headerlink" title="集群故障恢复"></a>集群故障恢复</h3><p><strong>1.如果主节点下线，从节点能否自动升级为主节点？</strong></p>
<p>能！主机恢复后会变为从机，从机自动顶为主节点</p>
<p><strong>2.主节点恢复后，主从关系会如何？</strong></p>
<p>主节点回来变为从节点</p>
<p><strong>3.一段插槽的主从节点全部宕掉，能否继续提供服务？</strong></p>
<p>看配置，若<code>cluster-require-full-coverage</code>为<code>yes</code>，那么，整个集群都挂掉，若为<code>no</code>，则只挂当前槽位的所有数据和信息</p>
<h3 id="集群的Jedis开发"><a href="#集群的Jedis开发" class="headerlink" title="集群的Jedis开发"></a>集群的Jedis开发</h3><p>即使连接的不是主机，集群会自动切换主机存储。主机写，从机读。</p>
<p>无中心化主从集群。无论从哪台主机写的数据，其他主机上都能读到数据。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JedisClusterTest</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123; </span><br><span class="line">		Set&lt;HostAndPort&gt;set =<span class="keyword">new</span> HashSet&lt;HostAndPort&gt;();</span><br><span class="line">        <span class="comment">// 写任何一个都可以，因为集群在操作时会自动切换</span></span><br><span class="line">		set.add(<span class="keyword">new</span> HostAndPort(<span class="string">&quot;192.168.31.211&quot;</span>, <span class="number">6379</span>));</span><br><span class="line">		JedisCluster jedisCluster=<span class="keyword">new</span> JedisCluster(set);</span><br><span class="line">		jedisCluster.set(<span class="string">&quot;k1&quot;</span>, <span class="string">&quot;v1&quot;</span>);</span><br><span class="line">		System.out.println(jedisCluster.get(<span class="string">&quot;k1&quot;</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="集群的优缺点"><a href="#集群的优缺点" class="headerlink" title="集群的优缺点"></a>集群的优缺点</h3><h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ul>
<li>实现扩容</li>
<li>分摊压力</li>
<li>无中心配置相对简单</li>
</ul>
<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><ul>
<li>多键操作不被支持 </li>
<li>多键的Redis事务不被支持的。lua脚本不被支持</li>
<li>由于集群方案出现较晚，很多公司已经采用了其他的集群方案，而代理或者客户端分片的方案想要迁移至redis cluster，需要整体迁移而不是逐步过渡，复杂度较大。</li>
</ul>
<h2 id="应用问题解决"><a href="#应用问题解决" class="headerlink" title="应用问题解决"></a>应用问题解决</h2><h3 id="缓存穿透问题"><a href="#缓存穿透问题" class="headerlink" title="缓存穿透问题"></a>缓存穿透问题</h3><h4 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h4><p>键对应的数据在数据源并不存在，每次针对此key的请求从缓存获取不到，请求都会压到数据源，从而可能压垮数据源。比如恶意访问一直用一个不存在的用户id获取用户信息，不论缓存还是数据库都没有，若黑客利用此漏洞进行攻击最终可能压垮数据库。</p>
<p>一个一定不存在缓存及查询不到的数据，由于缓存是不命中的时候被动写的，并且出于容错考虑，如果从存储层数据源查不到数据则不会写入缓存，这将导致这个不存在的数据每次请求都要到存储层去查询，失去了缓存的意义。</p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><p><strong>对空值缓存</strong></p>
<p>如果一个查询返回的数据为空（不管是数据是否不存在），我们仍然把这个空结果（null）进行缓存，设置空结果的过期时间会很短，最长不超过五分钟</p>
<p><strong>设置可访问的名单（白名单）</strong></p>
<p>使用bitmaps类型定义一个可以访问的名单，名单id作为bitmaps的偏移量，每次访问和bitmap里面的id进行比较，如果访问id不在bitmaps里面，进行拦截，不允许访问。</p>
<p><strong>采用布隆过滤器</strong></p>
<p>布隆过滤器（Bloom Filter）是1970年由布隆提出的。它实际上是一个很长的二进制向量(位图)和一系列随机映射函数（哈希函数）。</p>
<p>布隆过滤器可以用于检索一个元素是否在一个集合中。它的优点是空间效率和查询时间都远远超过一般的算法，缺点是有一定的误识别率和删除困难。</p>
<p>将所有可能存在的数据哈希到一个足够大的bitmaps中，一个一定不存在的数据会被这个bitmaps拦截掉，从而避免了对底层存储系统的查询压力。</p>
<p><strong>进行实时监控</strong></p>
<p>当发现Redis的命中率开始急速降低，需要快速排查访问对象和访问的数据，和运维人员配合，可以实时设置黑名单限制对某一特征的用户服务。</p>
<h3 id="缓存击穿"><a href="#缓存击穿" class="headerlink" title="缓存击穿"></a>缓存击穿</h3><h4 id="问题描述-1"><a href="#问题描述-1" class="headerlink" title="问题描述"></a>问题描述</h4><p>键对应的数据存在，但在redis中已经过期，此时突然有大量相同的并发请求过来，这些请求发现缓存过期一般都会从后端DB加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端数据源压垮。</p>
<p>例如某一个key作为热门词经常被搜索，随后其过期了，此时出现了大量同一时刻地对其访问，导致缓存被击穿，后台数据库崩了，详见微博程序猿。</p>
<h4 id="解决方案-1"><a href="#解决方案-1" class="headerlink" title="解决方案"></a>解决方案</h4><p>key可能会在某些时间点被超高并发地访问，是一种非常<strong>热点</strong>的数据。</p>
<ol>
<li><p><strong>预先设置热门数据</strong>：在redis高峰访问之前，把一些热门数据提前存入到redis里面，加大这些热门数据key的过期时长</p>
</li>
<li><p><strong>实时调整</strong>：现场监控哪些数据热门，动态实时地调整key的过期时长</p>
</li>
<li><p><strong>使用锁</strong>：</p>
<ol>
<li><p>就是在缓存失效的时候（判断拿出来的值为空），不是立即去<code>load db</code>。</p>
</li>
<li><p>先使用缓存工具的某些带成功操作返回值的操作（比如Redis的SETNX）去set一个mutex key</p>
</li>
<li><p>当操作返回成功时，再进行load db的操作，并回设缓存,最后删除mutex key；</p>
</li>
<li><p>当操作返回失败，证明有线程在load db，当前线程睡眠一段时间再重试整个get缓存的方法。</p>
</li>
</ol>
<p><img src="image-20220201214014677.png" alt="image-20220201214014677"></p>
</li>
</ol>
<h3 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h3><h4 id="问题描述-2"><a href="#问题描述-2" class="headerlink" title="问题描述"></a>问题描述</h4><p>缓存雪崩和缓存击穿类似，与之不同的是这个的规模更大，若有很多键同时失效，导致同一时间有大量的请求打到后端DB中，大并发会瞬间键DB压垮，缓存雪崩与缓存击穿的区别在于这里针对很多key缓存，前者则是某一个key</p>
<h4 id="解决方案-2"><a href="#解决方案-2" class="headerlink" title="解决方案"></a>解决方案</h4><p><strong>构建多级缓存架构：</strong></p>
<p>nginx缓存 + redis缓存 + 其他缓存（ehcache等）</p>
<p><strong>使用锁或队列：</strong></p>
<p>用加锁或者队列的方式保证来保证不会有大量的线程对数据库一次性进行读写，从而避免失效时大量的并发请求落到底层存储系统上。<strong>不适用高并发情况</strong></p>
<p><strong>设置过期标志更新缓存：</strong></p>
<p>记录缓存数据是否过期（设置提前量），如果过期会触发通知另外的线程在后台去更新实际key的缓存。</p>
<p><strong>将缓存失效时间分散开：</strong></p>
<p>比如我们可以在原有的失效时间基础上增加一个随机值，比如1-5分钟随机，这样每一个缓存的过期时间的重复率就会降低，就很难引发集体失效的事件。</p>
<h3 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h3><h4 id="问题描述-3"><a href="#问题描述-3" class="headerlink" title="问题描述"></a>问题描述</h4><p>在单机部署时，很多锁可以用来解决多线程问题，但是现在的业务发展逐渐变大变广，导致单机无法完成高并发下的要求，因此演化出了分布式集群系统，由于分布式的系统多线程，多进程分布在不同的机器上，这将会导致宕机部署情况下的并发控制锁策略师兄啊，单纯的JavaAPI不能提供分布式锁的能力，因此为了解决这个问题，需要一种能够跨越JVM的互锁机制来控制共享资源的访问，避免出现并发时出现错误。</p>
<p>主流的分布式锁主流实现方式有：1. 基于数据库实现的分布式锁；2. 基于缓存实现分布式锁；3. 基于Zookeeper实现</p>
<p>使用redis能够获得最高的性能，使用zookeeper能够获得最高的可用性</p>
<h4 id="解决方案-3"><a href="#解决方案-3" class="headerlink" title="解决方案"></a>解决方案</h4><p><strong>使用Redis实现分布式锁</strong></p>
<p>实现分布式锁需要具备以下条件：</p>
<ul>
<li>互斥性：在任意一个时刻，只有一个客户端持有锁。</li>
<li>无死锁：即便持有锁的客户端崩溃或者其他意外事件，锁仍然可以被获取。</li>
<li>容错：只要大部分Redis节点都活着，客户端就可以获取和释放锁。</li>
</ul>
<p>Redis可以完美实现上述需求，互斥性可以通过<code>SETNX</code>操作来实现，设置成功时返回1，表示持有锁，若已经存在<code>key</code>时，表示其他的线程正在持有锁，应该禁止访问资源，待到其他线程访问资源完毕时，则可以删除<code>key</code>释放锁；无死锁可以通过设置键的过期时间来保证，例如<code>set lock ex 5 nx</code>，在5秒后无论出现任何情况，锁都会被释放，其他进程此时访问时仍能获取锁；容错是因为Redis通过集群哨兵等容错机制保证了效率以及可用性。</p>
<h4 id="实现代码"><a href="#实现代码" class="headerlink" title="实现代码"></a>实现代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;testLock&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testLock</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// 1. 获取锁，set lock ex 3 nx，3s后自动过期保证不出现死锁</span></span><br><span class="line">    Boolean lock = redisTemplate.opsForValue()</span><br><span class="line">        .setIfAbsent(<span class="string">&quot;lock&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="comment">// 2. 若获取锁成功、查询num的值；否则过0.1s继续尝试获取锁</span></span><br><span class="line">    <span class="keyword">if</span>(lock)&#123;</span><br><span class="line">        Object value = redisTemplate.opsForValue().get(<span class="string">&quot;num&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.1. 判断num为空return</span></span><br><span class="line">        <span class="keyword">if</span>(StringUtils.isEmpty(value))&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2.2. 有值就转成成int</span></span><br><span class="line">        <span class="keyword">int</span> num = Integer.parseInt(value+<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">// 2.3. 把redis的num加1</span></span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;num&quot;</span>, ++num);</span><br><span class="line">        <span class="comment">// 2.4. 释放锁，del lock</span></span><br><span class="line">        redisTemplate.delete(<span class="string">&quot;lock&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">// 3. 获取锁失败、每隔0.1秒再获取</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">            testLock();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>但是这样做仍然存在问题！</strong></p>
<p>若一个业务需要<code>4s</code>执行，一开始<code>request1</code>请求控制器，获取锁后业务还没有完成，到了设定<code>lock</code>时设置的<code>3s</code>时，<code>lock</code>被<code>Redis</code>过期自动释放，此时<code>request2</code>成功获取到了锁<code>lock</code>，却在其运行的第一秒被完成的<code>request1</code>业务给释放掉。最终等于没有上锁，因为自己业务的锁被其他先前业务释放掉了。</p>
<blockquote>
<p><strong>解决方案：</strong>可以在存入<code>lock</code>时<code>value</code>存入一个<code>uuid</code>，在最后释放锁时先获取锁，判断值是否与之前的<code>uuid</code>相等，若相等释放值，若不相等则不释放，因为此时已经是其他进程获取到的锁。</p>
</blockquote>
<p><strong>但是这样做又引入了新的问题！</strong></p>
<p>删除释放锁操作缺乏原子性：原因是若获取<code>lock</code>中的<code>uuid</code>确实与之前存放的<code>uuid</code>一致，但是还没删除就已经过期了，此时则可能又将新的进程已经获取到的锁删除了，导致出现资源抢占问题</p>
<blockquote>
<p><strong>解决方案：</strong>使用LUA脚本保证删除的原子性</p>
<p>LUA脚本如下：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> redis.call(<span class="string">&#x27;get&#x27;</span>,KEYS[<span class="number">1</span>]) == ARGV[<span class="number">1</span>] <span class="keyword">then</span> </span><br><span class="line">   <span class="keyword">return</span> redis.call(<span class="string">&#x27;del&#x27;</span>,KEYS[<span class="number">1</span>]) </span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"><span class="keyword">end</span>;</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><blockquote>
<p>[1] <a target="_blank" rel="noopener" href="https://www.yiibai.com/redis">Redis教程™ (yiibai.com)</a></p>
<p>[2] <a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Rv41177Af">【尚硅谷】Redis 6 入门到精通 超详细 教程_哔哩哔哩_bilibili</a></p>
</blockquote>

    </div>

    
    
    

    <div>
    
        <div>
    
        <hr>
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文到此结束 <i class="fas fa-book-open"></i> 感谢您的阅读-------------</div>
    
</div>
    
    </div>
        <div class="reward-container">
  <div>谢谢你请我喝肥宅快乐水(๑＞ڡ＜) ☆☆☆</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatimg.jpg" alt="喵式重战 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipayimg.jpg" alt="喵式重战 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>喵式重战
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://heavytiger.github.io/articles/Redis%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/" title="Redis基础学习">https://heavytiger.github.io/articles/Redis基础学习/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Redis/" rel="tag"><i class="fa fa-tag"></i> Redis</a>
              <a href="/tags/NoSQL/" rel="tag"><i class="fa fa-tag"></i> NoSQL</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/articles/SpringBoot%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD/" rel="prev" title="SpringBoot核心功能">
      <i class="fa fa-chevron-left"></i> SpringBoot核心功能
    </a></div>
      <div class="post-nav-item">
    <a href="/articles/%E5%96%B5%E5%96%B5%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE_%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" rel="next" title="喵喵商城项目_环境搭建">
      喵喵商城项目_环境搭建 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E7%9A%84%E7%AE%80%E4%BB%8B"><span class="nav-number">1.</span> <span class="nav-text">Redis的简介</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis%E7%9A%84%E4%BC%98%E7%82%B9"><span class="nav-number">1.1.</span> <span class="nav-text">Redis的优点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis%E4%B8%8E%E5%85%B6%E4%BB%96%E7%9A%84%E9%94%AE%E5%80%BC%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-number">1.2.</span> <span class="nav-text">Redis与其他的键值数据库</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E7%9A%84%E5%AE%89%E8%A3%85"><span class="nav-number">2.</span> <span class="nav-text">Redis的安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E7%9F%A5%E8%AF%86%E7%82%B9%E8%AF%B4%E6%98%8E"><span class="nav-number">2.1.</span> <span class="nav-text">相关知识点说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E7%9A%84%E4%BA%94%E5%A4%A7%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">3.</span> <span class="nav-text">Redis的五大基本数据类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%AE%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="nav-number">3.1.</span> <span class="nav-text">键的基本操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8B%E5%BD%93%E5%89%8D%E5%BA%93%E4%B8%AD%E7%9A%84%E6%89%80%E6%9C%89%E7%9A%84Key"><span class="nav-number">3.1.1.</span> <span class="nav-text">查看当前库中的所有的Key</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A4%E6%96%AD%E6%9F%90%E4%B8%AAKey%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="nav-number">3.1.2.</span> <span class="nav-text">判断某个Key是否存在</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8BKey%E6%98%AF%E4%BB%80%E4%B9%88%E7%B1%BB%E5%9E%8B"><span class="nav-number">3.1.3.</span> <span class="nav-text">查看Key是什么类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E6%8C%87%E5%AE%9A%E7%9A%84Key%E6%95%B0%E6%8D%AE"><span class="nav-number">3.1.4.</span> <span class="nav-text">删除指定的Key数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%E4%B8%8E%E6%9F%A5%E7%9C%8B%E8%BF%87%E6%9C%9F%E7%8A%B6%E6%80%81"><span class="nav-number">3.1.5.</span> <span class="nav-text">设置与查看过期状态</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E5%91%BD%E4%BB%A4"><span class="nav-number">3.1.6.</span> <span class="nav-text">其他命令</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2-String"><span class="nav-number">3.2.</span> <span class="nav-text">字符串(String)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B"><span class="nav-number">3.2.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="nav-number">3.2.2.</span> <span class="nav-text">常用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SET%E5%91%BD%E4%BB%A4"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">SET命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#GET%E5%91%BD%E4%BB%A4"><span class="nav-number">3.2.2.2.</span> <span class="nav-text">GET命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#APPEND%E5%91%BD%E4%BB%A4"><span class="nav-number">3.2.2.3.</span> <span class="nav-text">APPEND命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#STRLEN%E5%91%BD%E4%BB%A4"><span class="nav-number">3.2.2.4.</span> <span class="nav-text">STRLEN命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#INCR%E5%91%BD%E4%BB%A4"><span class="nav-number">3.2.2.5.</span> <span class="nav-text">INCR命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#DECR%E5%91%BD%E4%BB%A4"><span class="nav-number">3.2.2.6.</span> <span class="nav-text">DECR命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#MSET%E5%91%BD%E4%BB%A4"><span class="nav-number">3.2.2.7.</span> <span class="nav-text">MSET命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#MGET%E5%91%BD%E4%BB%A4"><span class="nav-number">3.2.2.8.</span> <span class="nav-text">MGET命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#GETRANGE%E5%91%BD%E4%BB%A4"><span class="nav-number">3.2.2.9.</span> <span class="nav-text">GETRANGE命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SETRANGE%E5%91%BD%E4%BB%A4"><span class="nav-number">3.2.2.10.</span> <span class="nav-text">SETRANGE命令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="nav-number">3.2.3.</span> <span class="nav-text">数据结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%97%E8%A1%A8-List"><span class="nav-number">3.3.</span> <span class="nav-text">列表(List)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B-1"><span class="nav-number">3.3.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-1"><span class="nav-number">3.3.2.</span> <span class="nav-text">常用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#LPUSH-RPUSH%E5%91%BD%E4%BB%A4"><span class="nav-number">3.3.2.1.</span> <span class="nav-text">LPUSH&#x2F;RPUSH命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#LPOP-RPOP%E5%91%BD%E4%BB%A4"><span class="nav-number">3.3.2.2.</span> <span class="nav-text">LPOP&#x2F;RPOP命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#RPOPLPUSH%E5%91%BD%E4%BB%A4"><span class="nav-number">3.3.2.3.</span> <span class="nav-text">RPOPLPUSH命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#LRANGE%E5%91%BD%E4%BB%A4"><span class="nav-number">3.3.2.4.</span> <span class="nav-text">LRANGE命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#LINDEX%E5%91%BD%E4%BB%A4"><span class="nav-number">3.3.2.5.</span> <span class="nav-text">LINDEX命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#LLEN%E5%91%BD%E4%BB%A4"><span class="nav-number">3.3.2.6.</span> <span class="nav-text">LLEN命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#LINSERT%E5%91%BD%E4%BB%A4"><span class="nav-number">3.3.2.7.</span> <span class="nav-text">LINSERT命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#LREM%E5%91%BD%E4%BB%A4"><span class="nav-number">3.3.2.8.</span> <span class="nav-text">LREM命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#LSET%E5%91%BD%E4%BB%A4"><span class="nav-number">3.3.2.9.</span> <span class="nav-text">LSET命令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-1"><span class="nav-number">3.3.3.</span> <span class="nav-text">数据结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E5%90%88-Set"><span class="nav-number">3.4.</span> <span class="nav-text">集合(Set)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B-2"><span class="nav-number">3.4.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-2"><span class="nav-number">3.4.2.</span> <span class="nav-text">常用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SADD%E5%91%BD%E4%BB%A4"><span class="nav-number">3.4.2.1.</span> <span class="nav-text">SADD命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SISMEMBER%E5%91%BD%E4%BB%A4"><span class="nav-number">3.4.2.2.</span> <span class="nav-text">SISMEMBER命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SREM%E5%91%BD%E4%BB%A4"><span class="nav-number">3.4.2.3.</span> <span class="nav-text">SREM命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SPOP%E5%91%BD%E4%BB%A4"><span class="nav-number">3.4.2.4.</span> <span class="nav-text">SPOP命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SRANDMEMBER%E5%91%BD%E4%BB%A4"><span class="nav-number">3.4.2.5.</span> <span class="nav-text">SRANDMEMBER命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SMOVE%E5%91%BD%E4%BB%A4"><span class="nav-number">3.4.2.6.</span> <span class="nav-text">SMOVE命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SINTER-SUNION-SDIFF%E5%91%BD%E4%BB%A4"><span class="nav-number">3.4.2.7.</span> <span class="nav-text">SINTER&#x2F;SUNION&#x2F;SDIFF命令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-2"><span class="nav-number">3.4.3.</span> <span class="nav-text">数据结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%93%88%E5%B8%8C-Hash"><span class="nav-number">3.5.</span> <span class="nav-text">哈希(Hash)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B-3"><span class="nav-number">3.5.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-3"><span class="nav-number">3.5.2.</span> <span class="nav-text">常用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#HSET%E5%91%BD%E4%BB%A4"><span class="nav-number">3.5.2.1.</span> <span class="nav-text">HSET命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#HGET%E5%91%BD%E4%BB%A4"><span class="nav-number">3.5.2.2.</span> <span class="nav-text">HGET命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#HMSET%E5%91%BD%E4%BB%A4"><span class="nav-number">3.5.2.3.</span> <span class="nav-text">HMSET命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#HEXISTS%E5%91%BD%E4%BB%A4"><span class="nav-number">3.5.2.4.</span> <span class="nav-text">HEXISTS命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#HKEYS%E5%91%BD%E4%BB%A4"><span class="nav-number">3.5.2.5.</span> <span class="nav-text">HKEYS命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#HVALS%E5%91%BD%E4%BB%A4"><span class="nav-number">3.5.2.6.</span> <span class="nav-text">HVALS命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#HINCRBY%E5%91%BD%E4%BB%A4"><span class="nav-number">3.5.2.7.</span> <span class="nav-text">HINCRBY命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#HDEL%E5%91%BD%E4%BB%A4"><span class="nav-number">3.5.2.8.</span> <span class="nav-text">HDEL命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#HLEN%E5%91%BD%E4%BB%A4"><span class="nav-number">3.5.2.9.</span> <span class="nav-text">HLEN命令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-3"><span class="nav-number">3.5.3.</span> <span class="nav-text">数据结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88-Zset"><span class="nav-number">3.6.</span> <span class="nav-text">有序集合(Zset)</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B-4"><span class="nav-number">3.6.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-4"><span class="nav-number">3.6.2.</span> <span class="nav-text">常用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ZADD%E5%91%BD%E4%BB%A4"><span class="nav-number">3.6.2.1.</span> <span class="nav-text">ZADD命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ZRANGE%E5%91%BD%E4%BB%A4"><span class="nav-number">3.6.2.2.</span> <span class="nav-text">ZRANGE命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ZRANGEBYSCORE%E5%91%BD%E4%BB%A4"><span class="nav-number">3.6.2.3.</span> <span class="nav-text">ZRANGEBYSCORE命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ZINCRBY%E5%91%BD%E4%BB%A4"><span class="nav-number">3.6.2.4.</span> <span class="nav-text">ZINCRBY命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ZREM%E5%91%BD%E4%BB%A4"><span class="nav-number">3.6.2.5.</span> <span class="nav-text">ZREM命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ZCOUNT%E5%91%BD%E4%BB%A4"><span class="nav-number">3.6.2.6.</span> <span class="nav-text">ZCOUNT命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ZRANK%E5%91%BD%E4%BB%A4"><span class="nav-number">3.6.2.7.</span> <span class="nav-text">ZRANK命令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-4"><span class="nav-number">3.6.3.</span> <span class="nav-text">数据结构</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis6%E6%96%B0%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">4.</span> <span class="nav-text">Redis6新数据类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Bitmaps"><span class="nav-number">4.1.</span> <span class="nav-text">Bitmaps</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D"><span class="nav-number">4.1.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-5"><span class="nav-number">4.1.2.</span> <span class="nav-text">常用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SETBIT%E5%91%BD%E4%BB%A4"><span class="nav-number">4.1.2.1.</span> <span class="nav-text">SETBIT命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#GETBIT%E5%91%BD%E4%BB%A4"><span class="nav-number">4.1.2.2.</span> <span class="nav-text">GETBIT命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#BITCOUNT%E5%91%BD%E4%BB%A4"><span class="nav-number">4.1.2.3.</span> <span class="nav-text">BITCOUNT命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#BITOP%E5%91%BD%E4%BB%A4"><span class="nav-number">4.1.2.4.</span> <span class="nav-text">BITOP命令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-5"><span class="nav-number">4.1.3.</span> <span class="nav-text">数据结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HyperLogLog"><span class="nav-number">4.2.</span> <span class="nav-text">HyperLogLog</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D-1"><span class="nav-number">4.2.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-6"><span class="nav-number">4.2.2.</span> <span class="nav-text">常用命令</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#PFADD%E5%91%BD%E4%BB%A4"><span class="nav-number">4.2.2.1.</span> <span class="nav-text">PFADD命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PFCOUNT%E5%91%BD%E4%BB%A4"><span class="nav-number">4.2.2.2.</span> <span class="nav-text">PFCOUNT命令</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#PFMERGE%E5%91%BD%E4%BB%A4"><span class="nav-number">4.2.2.3.</span> <span class="nav-text">PFMERGE命令</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84-6"><span class="nav-number">4.2.3.</span> <span class="nav-text">数据结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Geospatial"><span class="nav-number">4.3.</span> <span class="nav-text">Geospatial</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D-2"><span class="nav-number">4.3.1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4-7"><span class="nav-number">4.3.2.</span> <span class="nav-text">常用命令</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3"><span class="nav-number">5.</span> <span class="nav-text">Redis配置文件详解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85"><span class="nav-number">6.</span> <span class="nav-text">Redis发布与订阅</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85%E4%BB%8B%E7%BB%8D"><span class="nav-number">6.1.</span> <span class="nav-text">发布与订阅介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%91%E5%B8%83%E4%B8%8E%E8%AE%A2%E9%98%85%E7%AE%80%E6%98%93%E6%B5%81%E7%A8%8B"><span class="nav-number">6.2.</span> <span class="nav-text">发布与订阅简易流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Jedis%E6%93%8D%E4%BD%9CRedis"><span class="nav-number">7.</span> <span class="nav-text">Jedis操作Redis</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95Redis%E8%BF%9E%E6%8E%A5"><span class="nav-number">7.1.</span> <span class="nav-text">测试Redis连接</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AF%BC%E5%85%A5Jedis%E6%89%80%E9%9C%80%E7%9A%84%E5%8C%85"><span class="nav-number">7.1.1.</span> <span class="nav-text">导入Jedis所需的包</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%96%E5%86%99%E5%A6%82%E4%B8%8B%E6%89%80%E7%A4%BA%E4%BB%A3%E7%A0%81%E6%B5%8B%E8%AF%95%E8%BF%9E%E6%8E%A5"><span class="nav-number">7.1.2.</span> <span class="nav-text">编写如下所示代码测试连接</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Jedis%E7%9A%84%E5%B8%B8%E7%94%A8%E6%93%8D%E4%BD%9C"><span class="nav-number">7.2.</span> <span class="nav-text">Jedis的常用操作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#API%EF%BC%9AKey"><span class="nav-number">7.2.1.</span> <span class="nav-text">API：Key</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#API%EF%BC%9AString"><span class="nav-number">7.2.2.</span> <span class="nav-text">API：String</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#API%EF%BC%9AList"><span class="nav-number">7.2.3.</span> <span class="nav-text">API：List</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#API%EF%BC%9ASet"><span class="nav-number">7.2.4.</span> <span class="nav-text">API：Set</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#API%EF%BC%9AHash"><span class="nav-number">7.2.5.</span> <span class="nav-text">API：Hash</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#API%EF%BC%9AZSet"><span class="nav-number">7.2.6.</span> <span class="nav-text">API：ZSet</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SpringBoot%E6%95%B4%E5%90%88Redis%E5%AE%9E%E4%BE%8B"><span class="nav-number">8.</span> <span class="nav-text">SpringBoot整合Redis实例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E5%8F%91%E9%80%81%E6%A0%A1%E9%AA%8C%E6%89%8B%E6%9C%BA%E9%AA%8C%E8%AF%81%E7%A0%81%E5%8A%9F%E8%83%BD%E6%80%A7%E9%9C%80%E6%B1%82"><span class="nav-number">8.1.</span> <span class="nav-text">实现发送校验手机验证码功能性需求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0%E5%8F%8A%E7%BB%93%E6%9E%9C"><span class="nav-number">8.2.</span> <span class="nav-text">代码实现及结果</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#SpringBoot%E6%95%B4%E5%90%88"><span class="nav-number">8.3.</span> <span class="nav-text">SpringBoot整合</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E4%BA%8B%E5%8A%A1"><span class="nav-number">9.</span> <span class="nav-text">Redis事务</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="nav-number">9.1.</span> <span class="nav-text">事务的定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Multi%E3%80%81Exec%E3%80%81Discard"><span class="nav-number">9.2.</span> <span class="nav-text">Multi、Exec、Discard</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="nav-number">9.3.</span> <span class="nav-text">事务的错误处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E5%86%B2%E7%AA%81%E9%97%AE%E9%A2%98"><span class="nav-number">9.4.</span> <span class="nav-text">事务冲突问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%82%B2%E8%A7%82%E9%94%81"><span class="nav-number">9.4.1.</span> <span class="nav-text">悲观锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B9%90%E8%A7%82%E9%94%81"><span class="nav-number">9.4.2.</span> <span class="nav-text">乐观锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#WATCH-key-key-%E2%80%A6"><span class="nav-number">9.4.3.</span> <span class="nav-text">WATCH key [key … ]</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UNWATCH-key-key-%E2%80%A6"><span class="nav-number">9.4.4.</span> <span class="nav-text">UNWATCH key [key … ]</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8B%E5%8A%A1%E7%9A%84%E4%B8%89%E7%89%B9%E6%80%A7"><span class="nav-number">9.5.</span> <span class="nav-text">事务的三特性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E7%A7%92%E6%9D%80%E6%A1%88%E4%BE%8B"><span class="nav-number">10.</span> <span class="nav-text">Redis秒杀案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A7%92%E6%9D%80%E4%B8%AD%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">10.1.</span> <span class="nav-text">秒杀中存在的问题</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">10.2.</span> <span class="nav-text">问题解决方案</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%8F%8A%E8%BF%90%E8%A1%8C%E6%95%88%E6%9E%9C"><span class="nav-number">10.3.</span> <span class="nav-text">代码及运行效果</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">11.</span> <span class="nav-text">Redis持久化</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RDB%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">11.1.</span> <span class="nav-text">RDB持久化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#RDB%E6%8C%81%E4%B9%85%E5%8C%96%E7%AE%80%E4%BB%8B"><span class="nav-number">11.1.1.</span> <span class="nav-text">RDB持久化简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RDB%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-number">11.1.2.</span> <span class="nav-text">RDB使用方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RDB%E7%9A%84%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D%E6%B5%81%E7%A8%8B"><span class="nav-number">11.1.3.</span> <span class="nav-text">RDB的备份恢复流程</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#RDB%E7%9A%84%E4%BC%98%E5%8A%A3%E5%8A%BF"><span class="nav-number">11.1.4.</span> <span class="nav-text">RDB的优劣势</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AOF%E6%8C%81%E4%B9%85%E5%8C%96"><span class="nav-number">11.2.</span> <span class="nav-text">AOF持久化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AOF%E6%8C%81%E4%B9%85%E5%8C%96%E7%AE%80%E4%BB%8B"><span class="nav-number">11.2.1.</span> <span class="nav-text">AOF持久化简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BC%82%E5%B8%B8%E6%81%A2%E5%A4%8D"><span class="nav-number">11.2.2.</span> <span class="nav-text">异常恢复</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E9%85%8D%E7%BD%AE"><span class="nav-number">11.2.3.</span> <span class="nav-text">相关配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AOF%E7%9A%84%E4%BC%98%E5%8A%A3%E5%8A%BF"><span class="nav-number">11.2.4.</span> <span class="nav-text">AOF的优劣势</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">11.3.</span> <span class="nav-text">总结</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="nav-number">12.</span> <span class="nav-text">Redis主从复制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="nav-number">12.1.</span> <span class="nav-text">什么是主从复制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%90%AD%E5%BB%BA%E4%B8%BB%E4%BB%8E%E7%8E%AF%E5%A2%83"><span class="nav-number">12.2.</span> <span class="nav-text">搭建主从环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%86"><span class="nav-number">12.3.</span> <span class="nav-text">一主二仆</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%96%AA%E7%81%AB%E7%9B%B8%E4%BC%A0"><span class="nav-number">12.4.</span> <span class="nav-text">薪火相传</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%8D%E5%AE%A2%E4%B8%BA%E4%B8%BB"><span class="nav-number">12.5.</span> <span class="nav-text">反客为主</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6%E5%8E%9F%E7%90%86"><span class="nav-number">12.6.</span> <span class="nav-text">主从复制原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F"><span class="nav-number">12.7.</span> <span class="nav-text">哨兵模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%AE%80%E4%BB%8B-5"><span class="nav-number">12.7.1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F%E5%AE%9E%E7%8E%B0"><span class="nav-number">12.7.2.</span> <span class="nav-text">哨兵模式实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Java%E8%BF%9E%E6%8E%A5%E6%B1%A0%E4%BF%AE%E6%94%B9"><span class="nav-number">12.7.3.</span> <span class="nav-text">Java连接池修改</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis%E9%9B%86%E7%BE%A4"><span class="nav-number">13.</span> <span class="nav-text">Redis集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%AE%80%E4%BB%8B"><span class="nav-number">13.1.</span> <span class="nav-text">集群简介</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="nav-number">13.2.</span> <span class="nav-text">集群搭建</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%93%8D%E4%BD%9C"><span class="nav-number">13.3.</span> <span class="nav-text">集群操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E6%95%85%E9%9A%9C%E6%81%A2%E5%A4%8D"><span class="nav-number">13.4.</span> <span class="nav-text">集群故障恢复</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%9A%84Jedis%E5%BC%80%E5%8F%91"><span class="nav-number">13.5.</span> <span class="nav-text">集群的Jedis开发</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9B%86%E7%BE%A4%E7%9A%84%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-number">13.6.</span> <span class="nav-text">集群的优缺点</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BC%98%E7%82%B9"><span class="nav-number">13.6.1.</span> <span class="nav-text">优点</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%BA%E7%82%B9"><span class="nav-number">13.6.2.</span> <span class="nav-text">缺点</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BA%94%E7%94%A8%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3"><span class="nav-number">14.</span> <span class="nav-text">应用问题解决</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E9%97%AE%E9%A2%98"><span class="nav-number">14.1.</span> <span class="nav-text">缓存穿透问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0"><span class="nav-number">14.1.1.</span> <span class="nav-text">问题描述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">14.1.2.</span> <span class="nav-text">解决方案</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF"><span class="nav-number">14.2.</span> <span class="nav-text">缓存击穿</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0-1"><span class="nav-number">14.2.1.</span> <span class="nav-text">问题描述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-1"><span class="nav-number">14.2.2.</span> <span class="nav-text">解决方案</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="nav-number">14.3.</span> <span class="nav-text">缓存雪崩</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0-2"><span class="nav-number">14.3.1.</span> <span class="nav-text">问题描述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-2"><span class="nav-number">14.3.2.</span> <span class="nav-text">解决方案</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81"><span class="nav-number">14.4.</span> <span class="nav-text">分布式锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E6%8F%8F%E8%BF%B0-3"><span class="nav-number">14.4.1.</span> <span class="nav-text">问题描述</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88-3"><span class="nav-number">14.4.2.</span> <span class="nav-text">解决方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%A3%E7%A0%81"><span class="nav-number">14.4.3.</span> <span class="nav-text">实现代码</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">15.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="喵式重战"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">喵式重战</p>
  <div class="site-description" itemprop="description">人的一切痛苦，本质上都是对自己无能的愤怒。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">22</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/HeavyTiger" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;HeavyTiger" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=o8fGzcTAy8bNxM7KwszjxczbzsLKz43AzM4" title="E-Mail → http:&#x2F;&#x2F;mail.qq.com&#x2F;cgi-bin&#x2F;qm_share?t&#x3D;qm_mailme&amp;email&#x3D;o8fGzcTAy8bNxM7KwszjxczbzsLKz43AzM4" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://tzhiy.github.io/" title="https:&#x2F;&#x2F;tzhiy.github.io&#x2F;" rel="noopener" target="_blank">tzhiy's Blog</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://anthonycj.github.io/" title="https:&#x2F;&#x2F;anthonycj.github.io&#x2F;" rel="noopener" target="_blank">AnthonyCJ's Blogs</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>
    

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2021 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fas fa-star fa-spin"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">喵式重战</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">676k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">10:15</span>
</div>

<!--
--><!--
<a href="https://icp.gov.moe/?keyword=20180708" rel="external nofollow noreferrer" target="_blank" data-pjax-state="" style="
    border-bottom-width: 0px;
">萌 ICP 备 20180708 号</a>
//-->

<!-- 网站运行时间的设置 -->
<span id="timeDate">载入天数...</span>
<span id="times">载入时分秒...</span>
<script>
    var now = new Date();
    function createtime() {
        var grt= new Date("6/8/2021 0:0:0");       //此处修改你的建站时间，注意格式
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "已经存活 "+dnum+" 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒了，地球太危险了，我好害怕，想回家呜呜呜( >﹏<。)";
    }
setInterval("createtime()",250);
</script>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  

  
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/assets/z16.model.json"},"display":{"position":"right","hOffset":0,"vOffset":-20,"width":200,"height":400},"mobile":{"show":true,"scale":0.7},"react":{"opacity":0.85},"log":false});</script></body>
</html>
