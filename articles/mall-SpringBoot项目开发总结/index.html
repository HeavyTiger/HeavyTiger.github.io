<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="sBEHKTtAGOsW8CzuLFLKzJIeSgj5S3G_6Jhlltsm76k">
  <meta name="baidu-site-verification" content="code-2EuuuTEL7g">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"heavytiger.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":18,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="之前使用SSM框架搭建过一个商城项目，但是该项目的全部技术栈都局限在了增删改查操作，虽然涉及到了数据库表的各种设计以及各种交互，但是仍然不能满足当下流行技术栈练手的能力，因此尝试将SSM项目转为SpringBoot项目，并且在其原有的基础上增加Redis，RabbitMQ中间件，增加秒杀商品的功能，现记录如下。">
<meta property="og:type" content="article">
<meta property="og:title" content="mall_SpringBoot项目开发总结">
<meta property="og:url" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="HeavyTiger&#39;s Blogs">
<meta property="og:description" content="之前使用SSM框架搭建过一个商城项目，但是该项目的全部技术栈都局限在了增删改查操作，虽然涉及到了数据库表的各种设计以及各种交互，但是仍然不能满足当下流行技术栈练手的能力，因此尝试将SSM项目转为SpringBoot项目，并且在其原有的基础上增加Redis，RabbitMQ中间件，增加秒杀商品的功能，现记录如下。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220211211657587.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220211214308908.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220211221041301.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220219141106992.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220220095508459.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220218195919400.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227164150457.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227164215253.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227164240828.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227164342405.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227164453186.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227164624889.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227164742233.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227164829449.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227164841464.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227164918514.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227165453713.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227223105990.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227223405920.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227223321782.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302090027111.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302090051415.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302090551454.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302093227630.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302093437091.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302093727229.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302093816365.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302093927977.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302094053172.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302094241264.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302110659354.png">
<meta property="og:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302112214600.png">
<meta property="article:published_time" content="2022-02-11T08:28:09.000Z">
<meta property="article:modified_time" content="2022-03-02T06:20:23.542Z">
<meta property="article:author" content="喵式重战">
<meta property="article:tag" content="喵式重战,HeavyTiger,heavytiger,Blog,博客,java后端,后端,Linux,Spring,Java">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220211211657587.png">

<link rel="canonical" href="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>mall_SpringBoot项目开发总结 | HeavyTiger's Blogs</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
   <!--动态线条背景-->
    <script type="text/javascript"color="220,220,220" opacity='0.7' zIndex="-2" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>
   
   <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">HeavyTiger's Blogs</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">逆水行舟</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-commonweal">

    <a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>公益 404</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/HeavyTiger" class="github-corner" title="喵喵喵~~~" aria-label="喵喵喵~~~" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

    
    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.png">
      <meta itemprop="name" content="喵式重战">
      <meta itemprop="description" content="人的一切痛苦，本质上都是对自己无能的愤怒。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="HeavyTiger's Blogs">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          mall_SpringBoot项目开发总结
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-02-11 16:28:09" itemprop="dateCreated datePublished" datetime="2022-02-11T16:28:09+08:00">2022-02-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-03-02 14:20:23" itemprop="dateModified" datetime="2022-03-02T14:20:23+08:00">2022-03-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" itemprop="url" rel="index"><span itemprop="name">项目实战</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>60k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>54 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>之前使用SSM框架搭建过一个商城项目，但是该项目的全部技术栈都局限在了增删改查操作，虽然涉及到了数据库表的各种设计以及各种交互，但是仍然不能满足当下流行技术栈练手的能力，因此尝试将<code>SSM</code>项目转为<code>SpringBoot</code>项目，并且在其原有的基础上增加<code>Redis</code>，<code>RabbitMQ</code>中间件，<strong>增加秒杀商品的功能</strong>，现记录如下。</p>
<!--此处为希望博客在首页显示的内容-->

<span id="more"></span>
<!-- markdownlint-disable MD041 MD002-->

<h2 id="SSM项目转为SpringBoot项目"><a href="#SSM项目转为SpringBoot项目" class="headerlink" title="SSM项目转为SpringBoot项目"></a>SSM项目转为SpringBoot项目</h2><p>原来的SSM项目可以见<a href="https://heavytiger.github.io/articles/SSM%E6%95%B4%E5%90%88%E5%BC%80%E5%8F%91/#more">SSM整合开发 | HeavyTiger’s Blogs</a>项目总结。该项目以增强自己对<code>Spring、SpringMVC、MyBatis</code>的掌握为目的进行开发，项目地址如下：<a target="_blank" rel="noopener" href="https://github.com/HeavyTiger/mall">HeavyTiger/mall: 使用ssm+vue框架实现的商城系统 (github.com)</a>，前端项目为室友使用<code>Vue.js</code>框架开发，项目地址如下：<a target="_blank" rel="noopener" href="https://github.com/tzhiy/mall_FE">tzhiy/mall_FE: 商城系统的前端部分 (github.com)</a></p>
<p>现在，为了更便捷地进行迭代，添加更多功能模块，将项目转为<code>SpringBoot</code>进行开发(称以下所有原<code>mall</code>项目为<code>mall_SSM</code>，称迭代的<code>SpringBoot</code>项目为<code>mall_SpringBoot</code>)。</p>
<p>在<code>mall_SSM</code>项目中，项目的各种类如图所示：</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220211211657587.png" alt="image-20220211211657587"></p>
<p>其中<code>controller</code>，<code>interceptor</code>，<code>mapper</code>，<code>pojo</code>，<code>service</code>，<code>util</code>为项目的相关业务逻辑，不过多介绍，<code>resources/com/mall/mapper/*.xml</code>为<code>mybatis</code>的相关<code>SQL</code>语句，也不再赘述，这些内容都是可以直接添加到<code>mall_SpringBoot</code>项目中的，之后在修改完包路径后，即可全部添加到新的项目中。</p>
<p><strong>故只用对<code>resources/conf</code>的相关内容进行迁移修改，在<code>SpringBoot</code>中使用<code>application.yml / application.properties</code>以及<code>config</code>配置类进行替代即可</strong></p>
<h3 id="配置log4j2实现日志模块"><a href="#配置log4j2实现日志模块" class="headerlink" title="配置log4j2实现日志模块"></a>配置log4j2实现日志模块</h3><p>首先我们使用<code>log4j2</code>作为日志的实现，由于之前出现了<code>log4j2</code>漏洞，因此要求将该依赖<code>spring-boot-starter-log4j2</code>的版本修改为：<code>2.6.2</code>，该版本使用了<code>2.17.1</code>版本的<code>log4j</code>，修复了存在的漏洞。</p>
<p>由于<code>SpringBoot</code>使用<code>logback</code>作为日志实现，因此需要排除该依赖，由于该项目使用<code>Spring Initializr</code>进行构建，其将<code>spring-boot-starter-parent</code>作为<code>parent maven</code>项目，在其中无法使用<code>&lt;exclusion&gt;...&lt;/exclusion&gt;</code>来排除依赖，因此我们在下方的依赖导入<code>spring-boot-starter-logging</code>后全局排除所有内容即可。</p>
<p><strong>最后的pom.xml如下所示：</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--全局排除spring-boot-starter-logging内的所有依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-logging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>*<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>*<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--引入 log4j2--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-log4j2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>导入后新建<code>application.yml</code>以后使用该文件做自动配置，在文件中填入以下内容</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 日志配置</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">config:</span> <span class="string">classpath:config/log4j2.xml</span></span><br><span class="line"><span class="comment"># 服务配置</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="comment"># 端口号配置</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">  <span class="comment"># 访问项目路径配置</span></span><br><span class="line">  <span class="attr">servlet:</span></span><br><span class="line">    <span class="attr">context-path:</span> <span class="string">/mall</span></span><br></pre></td></tr></table></figure>

<p>首先服务配置和以往一样，我们使用<code>8080</code>端口，项目访问路径设置为<code>/mall</code>，日志配置则放在<code>classpath:config/log4j2.xml</code>中</p>
<p>新建日志配置<code>resources/config/log4j2.xml</code>：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Configuration后面的status，这个用于设置log4j2自身内部的信息输出，可以不设置，当设置成trace时，</span></span><br><span class="line"><span class="comment"> 你会看到log4j2内部各种详细输出。可以设置成OFF(关闭)或Error(只输出错误信息)</span></span><br><span class="line"><span class="comment">--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Configuration</span> <span class="attr">status</span>=<span class="string">&quot;WARN&quot;</span> <span class="attr">monitorInterval</span>=<span class="string">&quot;30&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">&quot;App&quot;</span>&gt;</span>mall<span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">&quot;logDir&quot;</span>&gt;</span>logs<span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Property</span> <span class="attr">name</span>=<span class="string">&quot;splitSize&quot;</span>&gt;</span>30 MB<span class="tag">&lt;/<span class="name">Property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Appenders</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 输出控制台日志的配置 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Console</span> <span class="attr">name</span>=<span class="string">&quot;console&quot;</span> <span class="attr">target</span>=<span class="string">&quot;SYSTEM_OUT&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--控制台只输出level及以上级别的信息（onMatch），其他的直接拒绝（onMismatch）--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">&quot;info&quot;</span> <span class="attr">onMatch</span>=<span class="string">&quot;ACCEPT&quot;</span> <span class="attr">onMismatch</span>=<span class="string">&quot;DENY&quot;</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 输出日志的格式 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">&quot;%d&#123;HH:mm:ss.SSS&#125; [%t] %-5level %logger&#123;36&#125; - %msg%n&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Console</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 打印出所有的信息，每次大小超过size，则这size大小的日志会自动存入按年份-月份建立的文件夹下面并进行压缩，作为存档 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">RollingRandomAccessFile</span> <span class="attr">name</span>=<span class="string">&quot;infoLog&quot;</span> <span class="attr">fileName</span>=<span class="string">&quot;$&#123;logDir&#125;/$&#123;App&#125;-info.log&quot;</span> <span class="attr">immediateFlush</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">                                 <span class="attr">filePattern</span>=<span class="string">&quot;$&#123;logDir&#125;/$$&#123;date:yyyy-MM&#125;/$&#123;App&#125;-info-%d&#123;MM-dd-yyyy&#125;-%i.log.gz&quot;</span></span></span><br><span class="line"><span class="tag">                                 <span class="attr">append</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">&quot;%d&#123;yyyy-MM-dd &#x27;at&#x27; HH:mm:ss z&#125; [%t] %-5level %logger&#123;36&#125; %L %M - %msg%xEx%n&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Policies</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">TimeBasedTriggeringPolicy</span> <span class="attr">interval</span>=<span class="string">&quot;6&quot;</span> <span class="attr">modulate</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">SizeBasedTriggeringPolicy</span> <span class="attr">size</span>=<span class="string">&quot;$&#123;splitSize&#125;&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Policies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Filters</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 只记录info和warn级别信息 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">&quot;error&quot;</span> <span class="attr">onMatch</span>=<span class="string">&quot;DENY&quot;</span> <span class="attr">onMismatch</span>=<span class="string">&quot;NEUTRAL&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">&quot;info&quot;</span> <span class="attr">onMatch</span>=<span class="string">&quot;ACCEPT&quot;</span> <span class="attr">onMismatch</span>=<span class="string">&quot;DENY&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Filters</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 指定每天的最大压缩包个数，默认7个，超过了会覆盖之前的 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">DefaultRolloverStrategy</span> <span class="attr">max</span>=<span class="string">&quot;50&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">RollingRandomAccessFile</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- 存储所有error信息 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">RollingRandomAccessFile</span> <span class="attr">name</span>=<span class="string">&quot;errorLog&quot;</span> <span class="attr">fileName</span>=<span class="string">&quot;$&#123;logDir&#125;/$&#123;App&#125;-error.log&quot;</span> <span class="attr">immediateFlush</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">                                 <span class="attr">filePattern</span>=<span class="string">&quot;$&#123;logDir&#125;/$$&#123;date:yyyy-MM&#125;/$&#123;App&#125;-error-%d&#123;MM-dd-yyyy&#125;-%i.log.gz&quot;</span></span></span><br><span class="line"><span class="tag">                                 <span class="attr">append</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">PatternLayout</span> <span class="attr">pattern</span>=<span class="string">&quot;%d&#123;yyyy-MM-dd &#x27;at&#x27; HH:mm:ss z&#125; [%t] %-5level %logger&#123;36&#125; %L %M - %msg%xEx%n&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Policies</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">TimeBasedTriggeringPolicy</span> <span class="attr">interval</span>=<span class="string">&quot;6&quot;</span> <span class="attr">modulate</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">SizeBasedTriggeringPolicy</span> <span class="attr">size</span>=<span class="string">&quot;$&#123;splitSize&#125;&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Policies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Filters</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 只记录error级别信息 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ThresholdFilter</span> <span class="attr">level</span>=<span class="string">&quot;error&quot;</span> <span class="attr">onMatch</span>=<span class="string">&quot;ACCEPT&quot;</span> <span class="attr">onMismatch</span>=<span class="string">&quot;DENY&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">Filters</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 指定每天的最大压缩包个数，默认7个，超过了会覆盖之前的 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">DefaultRolloverStrategy</span> <span class="attr">max</span>=<span class="string">&quot;50&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">RollingRandomAccessFile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Appenders</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">Loggers</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- root logger 配置,全局配置，默认所有的Logger都继承此配置 --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- AsyncRoot - 异步记录日志 - 需要LMAX Disruptor的支持 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Root</span> <span class="attr">includeLocation</span>=<span class="string">&quot;true&quot;</span> <span class="attr">additivity</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;infoLog&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;errorLog&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;console&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Root</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!--第三方的软件日志级别 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;org.springframework&quot;</span> <span class="attr">level</span>=<span class="string">&quot;info&quot;</span> <span class="attr">additivity</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;infoLog&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;errorLog&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;console&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;com.heavytiger.mall.controller&quot;</span> <span class="attr">level</span>=<span class="string">&quot;info&quot;</span> <span class="attr">additivity</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;infoLog&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;errorLog&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;console&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;org.springframework.amqp&quot;</span> <span class="attr">level</span>=<span class="string">&quot;info&quot;</span> <span class="attr">additivity</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;infoLog&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">AppenderRef</span> <span class="attr">ref</span>=<span class="string">&quot;errorLog&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">logger</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Loggers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>若不进行配置，则会使用默认配置，仍能直接使用。</p>
<p>配置完成后，<code>log4j2</code>的日志模块测试无误：</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220211214308908.png" alt="image-20220211214308908"></p>
<h3 id="配置数据源、连接池、MyBatis"><a href="#配置数据源、连接池、MyBatis" class="headerlink" title="配置数据源、连接池、MyBatis"></a>配置数据源、连接池、MyBatis</h3><p><strong>1. 导入相关依赖</strong></p>
<p>由于实现分页功能时我使用了<code>pagehelper</code>，因此需要导入依赖，但是若<code>SpringBoot</code>的版本高于<code>2.6.X</code>，使用低于<code>1.4.1</code>的版本会报错出现循环依赖，由于选择<code>Spring Boot 2.6.3</code>版本，因此导入<code>1.4.1</code>版本。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--MyBatis依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--MySQL驱动依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.28<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Druid数据源--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- pagehelper分页依赖，使用低版本会出现循环依赖问题，至少为1.4.1--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.pagehelper<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pagehelper-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们使用<code>Druid</code>来作为数据库连接池，数据库的相关配置如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># 数据源配置</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/mall?serverTimezone=Asia/Shanghai&amp;useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">mall</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="comment"># Druid连接池配置</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">initialSize:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">minIdle:</span> <span class="number">5</span></span><br><span class="line">    <span class="attr">maxActive:</span> <span class="number">20</span></span><br><span class="line">    <span class="attr">maxWait:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">timeBetweenEvictionRunsMillis:</span> <span class="number">60000</span></span><br><span class="line">    <span class="attr">minEvictableIdleTimeMillis:</span> <span class="number">300000</span></span><br><span class="line"><span class="comment"># MyBatis配置</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.heavytiger.mall.pojo</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*.xml</span></span><br></pre></td></tr></table></figure>

<p>在<code>MyBatis</code>配置中配置了实体类使用别名以及<code>mapper</code>的包所在位置，但是要记得在<code>mapper</code>接口上标记<code>@Mapper</code>注解，否则会报错找不到<code>bean</code></p>
<p><strong>在<code>com.heavytiger.mall.config</code>包下编写<code>druid</code>连接池配置类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> heavytiger</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 配置数据源</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/2/11 11:37</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DruidConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ConfigurationProperties(prefix = &quot;spring.datasource&quot;)</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSource <span class="title">druidDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意前缀最好同一写成<code>spring.datasource</code>而不是部分在<code>spring.datasource.druid</code>中，会导致没有注入进实体类的构造中。</p>
<h3 id="配置鉴权拦截器"><a href="#配置鉴权拦截器" class="headerlink" title="配置鉴权拦截器"></a>配置鉴权拦截器</h3><p>还是和之前的<code>SSM</code>项目一样，使用<code>JWT</code>技术进行鉴权(原因还是买不起贵的阿里云服务器，之后尝试高并发秒杀的时候若将<code>session</code>全部存在服务器中，会导致只有2G内存的服务器崩溃，因此最好使用<code>JWT</code>技术由客户端进行存储(但是好像<code>1Mbps</code>的带宽限制又很大了…))</p>
<p><strong>导入JWT依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--JWT依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.auth0<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>java-jwt<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>拦截器编写如下所示</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> heavytiger</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 实现验证用户的headers中是否存在Authorization</span></span><br><span class="line"><span class="comment"> *              中的token，若不存在，返回状态码要求登录，存在放行</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2021/12/23 19:42</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String token = request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(JwtUtil.verify(token)) &#123;</span><br><span class="line">            <span class="comment">// 说明验证成功，允许访问资源</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">            response.setContentType(<span class="string">&quot;application/json; charset=utf-8&quot;</span>);</span><br><span class="line">            response.getWriter().write(JsonUtil.objToJson(<span class="keyword">new</span> ResultBean&lt;&gt;(EnumResult.TOKEN_ERROR)));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>拦截器配置类编写如下所示</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> heavytiger</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> Web应用配置类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/2/11 14:10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 添加鉴权拦截器，拦截所有请求，排除登录和注册相关的API调用</span></span><br><span class="line">        registry.addInterceptor(<span class="keyword">new</span> CheckInterceptor())</span><br><span class="line">                .addPathPatterns(<span class="string">&quot;/**&quot;</span>)</span><br><span class="line">                .excludePathPatterns(<span class="string">&quot;/login&quot;</span>, <span class="string">&quot;/register&quot;</span>, <span class="string">&quot;/userExist&quot;</span>);</span><br><span class="line">        WebMvcConfigurer.<span class="keyword">super</span>.addInterceptors(registry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="配置Redis集群"><a href="#配置Redis集群" class="headerlink" title="配置Redis集群"></a>配置Redis集群</h3><p>配置为Redis集群的原因是之前学习Redis的时候使用过单机和主从复制模式，但是没有用java和集群交互过，因此想尝试使用Redis集群，至少使用了主从读写分离或多或少能提高秒杀的高并发下的读效率。</p>
<p><strong>导入依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Spring Data Redis依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--commons-pool2依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>配置连接及连接池</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># Redis相关配置</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">6o.......................orO</span></span><br><span class="line">    <span class="attr">timeout:</span> <span class="string">6000ms</span></span><br><span class="line">    <span class="attr">cluster:</span></span><br><span class="line">      <span class="comment"># 失败重连次数</span></span><br><span class="line">      <span class="attr">max-redirects:</span> <span class="number">2</span></span><br><span class="line">      <span class="comment"># 集群配置，三组一主一从，--cluster-replicas 1模式</span></span><br><span class="line">      <span class="attr">nodes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">121.</span><span class="string">xxx.xxx.31:6379</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">121.</span><span class="string">xxx.xxx.31:6380</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">121.</span><span class="string">xxx.xxx.31:6381</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">121.</span><span class="string">xxx.xxx.31:6389</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">121.</span><span class="string">xxx.xxx.31:6390</span></span><br><span class="line">        <span class="bullet">-</span> <span class="number">121.</span><span class="string">xxx.xxx.31:6391</span></span><br><span class="line">    <span class="comment"># Redis连接池设置</span></span><br><span class="line">    <span class="attr">lettuce:</span></span><br><span class="line">      <span class="attr">pool:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># 连接池最大连接数（使用负值表示没有限制）</span></span><br><span class="line">        <span class="attr">max-active:</span> <span class="number">1000</span></span><br><span class="line">        <span class="comment"># 连接池中的最大空闲连接</span></span><br><span class="line">        <span class="attr">max-idle:</span> <span class="number">10</span></span><br><span class="line">        <span class="comment"># 连接池中的最小空闲连接</span></span><br><span class="line">        <span class="attr">min-idle:</span> <span class="number">5</span></span><br><span class="line">        <span class="comment"># 连接池最大阻塞等待时间（使用负值表示没有限制）</span></span><br><span class="line">        <span class="attr">max-wait:</span> <span class="number">-1</span></span><br></pre></td></tr></table></figure>

<p><strong>编写获取连接的配置类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> heavytiger</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 配置Redis连接池</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/2/11 15:06</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCaching</span>  <span class="comment">// 开启缓存支持</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Resource</span></span><br><span class="line">    <span class="keyword">private</span> LettuceConnectionFactory lettuceConnectionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> KeyGenerator <span class="title">keyGenerator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> KeyGenerator() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Object <span class="title">generate</span><span class="params">(Object target, Method method, Object... params)</span> </span>&#123;</span><br><span class="line">                StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">                sb.append(target.getClass().getName());</span><br><span class="line">                sb.append(method.getName());</span><br><span class="line">                <span class="keyword">for</span> (Object obj : params) &#123;</span><br><span class="line">                    sb.append(obj.toString());</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> sb.toString();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 缓存管理器</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        RedisCacheManager.RedisCacheManagerBuilder builder = RedisCacheManager.RedisCacheManagerBuilder</span><br><span class="line">                .fromConnectionFactory(lettuceConnectionFactory);</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line">        Set&lt;String&gt; cacheNames = <span class="keyword">new</span> HashSet&lt;String&gt;() &#123;</span><br><span class="line">            &#123;</span><br><span class="line">                add(<span class="string">&quot;codeNameCache&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        builder.initialCacheNames(cacheNames);</span><br><span class="line">        <span class="keyword">return</span> builder.build();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * RedisTemplate配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="title">redisTemplate</span><span class="params">(LettuceConnectionFactory lettuceConnectionFactory)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 设置序列化</span></span><br><span class="line">        Jackson2JsonRedisSerializer&lt;Object&gt; jackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer&lt;Object&gt;(</span><br><span class="line">                Object.class);</span><br><span class="line">        ObjectMapper om = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);</span><br><span class="line">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class="line">        <span class="comment">// 配置redisTemplate</span></span><br><span class="line">        RedisTemplate&lt;String, Object&gt; redisTemplate = <span class="keyword">new</span> RedisTemplate&lt;String, Object&gt;();</span><br><span class="line">        redisTemplate.setConnectionFactory(lettuceConnectionFactory);</span><br><span class="line">        RedisSerializer&lt;?&gt; stringSerializer = <span class="keyword">new</span> StringRedisSerializer();</span><br><span class="line">        <span class="comment">// key序列化</span></span><br><span class="line">        redisTemplate.setKeySerializer(stringSerializer);</span><br><span class="line">        <span class="comment">// value序列化</span></span><br><span class="line">        redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        <span class="comment">// Hash key序列化</span></span><br><span class="line">        redisTemplate.setHashKeySerializer(stringSerializer);</span><br><span class="line">        <span class="comment">// Hash value序列化</span></span><br><span class="line">        redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        redisTemplate.afterPropertiesSet();</span><br><span class="line">        <span class="keyword">return</span> redisTemplate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>编写测试类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.heavytiger.mall;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.redis.core.RedisTemplate;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> heavytiger</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 测试redis的功能是否正常</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/2/11 15:17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisTemplateTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">redisTemplateTest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Object&gt; temp, map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;hash1&quot;</span>, <span class="string">&quot;value1&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;hash2&quot;</span>, <span class="string">&quot;123&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;hash3&quot;</span>, Arrays.asList(<span class="string">&quot;1&quot;</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="string">&quot;abc&quot;</span>));</span><br><span class="line">        redisTemplate.opsForValue().set(<span class="string">&quot;key_hash&quot;</span>, map);</span><br><span class="line">        temp = (Map&lt;String, Object&gt;) redisTemplate.opsForValue().get(<span class="string">&quot;key_hash&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;if value set == get&quot;</span> + map.equals(temp));</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : temp.entrySet()) &#123;</span><br><span class="line">            System.out.println(entry.getKey() + <span class="string">&quot; : &quot;</span> + entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>测试结果如下所示：</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if value set == get true</span><br><span class="line">hash3 : [1, 2, 3, abc]</span><br><span class="line">hash2 : 123</span><br><span class="line">hash1 : value1</span><br></pre></td></tr></table></figure>

<p>redis中数据如下：</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220211221041301.png" alt="image-20220211221041301"></p>
<p>可以看到，集群中的数据能被正常获取到。</p>
<blockquote>
<p><strong>注意事项：</strong></p>
<p>在使用<code>springboot</code>连接集群时会出现超时的情况，且多次连接仍然无法解决，经查询，是因为在创建集群时使用<code>127.0.0.1</code>，没有走<code>TCP</code>连接，若要允许外网访问，应该设置为<code>真实IP地址</code>，完成后外网即可访问。</p>
<p><code>redis-cli --cluster create --cluster-replicas 1 -a 6o5FLS9bSJmdTGlyqJWxiEGf56vE1orO 121.xxx.xxx.31:6379 121.xxx.xxx.31:6380 121.xxx.xxx.31:6381 121.xxx.xxx.31:6389 121.xxx.xxx.31:6390 121.xxx.xxx.31:6391</code></p>
<p>需要重新停止服务后，删除所有<code>rdb</code>以及<code>node</code>文件，此外，由于开放了外网连接，需要在防火墙中进行相关的配置。若出现<code>Waiting for the cluster to join</code>提示，且之后一直无响应，原因是每个 <code>Redis</code> 集群节点都需要打开两个 <code>TCP</code> 连接。服务客户端的普通<code>Redis TCP</code>端口，比如<code>6379</code>，加上数据端口加上<code>10000</code>得到的端口，所以也要开放是<code>16379</code>。</p>
<p>在开放完所有端口后，即可正常使用。</p>
<p>详见<code>stackoverflow</code>如下题问：</p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/39568561/how-to-solve-redis-cluster-waiting-for-the-cluster-to-join-issue">How to solve redis cluster “Waiting for the cluster to join” issue? - Stack Overflow</a></p>
</blockquote>
<h3 id="修改-将集群部署到虚拟机的docker中"><a href="#修改-将集群部署到虚拟机的docker中" class="headerlink" title="[修改]将集群部署到虚拟机的docker中"></a>[修改]将集群部署到虚拟机的docker中</h3><p>在1.4节部署到服务器上时没有考虑到服务器的带宽，”青春版”阿里云服务器带宽只有<code>1Mbps</code>，外网访问会担心因为带宽过小产生瓶颈使得<code>QPS</code>不高，(其实也可以直接在服务器内网跑压测，但是服务器上还挂了别的服务，所以还是用虚拟机加<code>docker</code>部署更得我心)</p>
<p><strong>1. 首先准备集群的conf文件</strong></p>
<p>和之间一样，组建3主3从Redis集群，一样使用之前的文件进行创建，这样的缺点是，不太方便指定主从结点，我们在虚拟机中同样的路径下创建redis相关的配置文件夹。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis]# pwd</span><br><span class="line">/usr/local/dbBackup/redis</span><br><span class="line">[root@localhost redis]# ll</span><br><span class="line">总用量 116</span><br><span class="line">-rw-r--r--. 1 root root   345 2月   9 17:11 redis6379.conf</span><br><span class="line">-rw-r--r--. 1 root root   345 2月   9 17:11 redis6380.conf</span><br><span class="line">-rw-r--r--. 1 root root   345 2月   9 17:11 redis6381.conf</span><br><span class="line">-rw-r--r--. 1 root root   345 2月   9 17:11 redis6389.conf</span><br><span class="line">-rw-r--r--. 1 root root   345 2月   9 17:11 redis6390.conf</span><br><span class="line">-rw-r--r--. 1 root root   345 2月   9 17:11 redis6391.conf</span><br><span class="line">-rw-r--r--. 1 root root 93748 2月   9 17:11 redis.conf</span><br><span class="line">[root@localhost dbBackup]# pwd</span><br><span class="line">/usr/local/dbBackup</span><br><span class="line">[root@localhost dbBackup]# ll</span><br><span class="line">总用量 0</span><br><span class="line">drwxr-xr-x. 2 root root 156 2月   9 17:14 redis</span><br><span class="line">drwxr-xr-x. 2 root root   6 2月   9 17:08 redis_cluster</span><br></pre></td></tr></table></figure>

<p>以<code>redis6379.conf</code>为例说明：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">include /usr/local/dbBackup/redis/redis.conf</span><br><span class="line">port 6379</span><br><span class="line">pidfile &quot;/var/run/redis_6379.pid&quot;</span><br><span class="line">dbfilename &quot;dump6379.rdb&quot;</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes-6379.conf</span><br><span class="line">cluster-node-timeout 15000</span><br><span class="line">masterauth 6o5..........................orO</span><br></pre></td></tr></table></figure>

<p><strong>2. 安装<code>docker-compose</code>以支持对容器集群的快速编排</strong></p>
<p>使用如下命令下载<code>docker-compose</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> curl -L https://get.daocloud.io/docker/compose/releases/download/1.29.2/docker-compose-`uname -s`-`uname -m` &gt; /usr/<span class="built_in">local</span>/bin/docker-compose</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用如下命令赋予可执行权限</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sudo chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span></span><br></pre></td></tr></table></figure>

<p><strong>3. 创建<code>docker-compose.yml</code>文件，其中完成镜像，网络，容器中内容的相关声明配置</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3.8&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">x-images:</span></span><br><span class="line">  <span class="string">&amp;default-image</span></span><br><span class="line">  <span class="string">redis</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis6379:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">*default-image</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis6379</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/dbBackup/redis/redis6379.conf&quot;</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis6379.conf:/usr/local/dbBackup/redis/redis6379.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis.conf:/usr/local/dbBackup/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/local/dbBackup/redis_cluster:/usr/local/dbBackup/redis_cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/6379:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6379</span><span class="string">:6379</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">16379</span><span class="string">:16379</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">redis6380:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">*default-image</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis6380</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/dbBackup/redis/redis6380.conf&quot;</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis6380.conf:/usr/local/dbBackup/redis/redis6380.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis.conf:/usr/local/dbBackup/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/local/dbBackup/redis_cluster:/usr/local/dbBackup/redis_cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/6380:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6380</span><span class="string">:6380</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">16380</span><span class="string">:16380</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">redis6381:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">*default-image</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis6381</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/dbBackup/redis/redis6381.conf&quot;</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis6381.conf:/usr/local/dbBackup/redis/redis6381.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis.conf:/usr/local/dbBackup/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/local/dbBackup/redis_cluster:/usr/local/dbBackup/redis_cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/6381:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6381</span><span class="string">:6381</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">16381</span><span class="string">:16381</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">redis6389:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">*default-image</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis6389</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/dbBackup/redis/redis6389.conf&quot;</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis6389.conf:/usr/local/dbBackup/redis/redis6389.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis.conf:/usr/local/dbBackup/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/local/dbBackup/redis_cluster:/usr/local/dbBackup/redis_cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/6389:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6389</span><span class="string">:6389</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">16389</span><span class="string">:16389</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">redis6390:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">*default-image</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis6390</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/dbBackup/redis/redis6390.conf&quot;</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis6390.conf:/usr/local/dbBackup/redis/redis6390.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis.conf:/usr/local/dbBackup/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/local/dbBackup/redis_cluster:/usr/local/dbBackup/redis_cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/6390:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6390</span><span class="string">:6390</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">16390</span><span class="string">:16390</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">redis6391:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">*default-image</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">redis6391</span></span><br><span class="line">    <span class="attr">command:</span></span><br><span class="line">      [<span class="string">&quot;redis-server&quot;</span>, <span class="string">&quot;/usr/local/dbBackup/redis/redis6391.conf&quot;</span>]</span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis6391.conf:/usr/local/dbBackup/redis/redis6391.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./redis.conf:/usr/local/dbBackup/redis/redis.conf</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/usr/local/dbBackup/redis_cluster:/usr/local/dbBackup/redis_cluster</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./data/6391:/data</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">6391</span><span class="string">:6391</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">16391</span><span class="string">:16391</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>使用<code>docker-compose ps</code>可以显示启动的容器，使用<code>docker-compose down</code>将停止并删除所有的容器</p>
</blockquote>
<p><strong>4. 使用<code>docker-compose up -d</code>命令启动容器集群</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis]# docker-compose up -d</span><br><span class="line">Creating network &quot;redis_default&quot; with the default driver</span><br><span class="line">Creating redis6389 ... done</span><br><span class="line">Creating redis6379 ... done</span><br><span class="line">Creating redis6381 ... done</span><br><span class="line">Creating redis6390 ... done</span><br><span class="line">Creating redis6380 ... done</span><br><span class="line">Creating redis6391 ... done</span><br><span class="line">[root@localhost redis]# docker-compose ps</span><br><span class="line">  Name                 Command               State                      Ports                   </span><br><span class="line">------------------------------------------------------------------------------------------------</span><br><span class="line">redis6379   docker-entrypoint.sh redis ...   Up      0.0.0.0:16379-&gt;16379/tcp,:::16379-&gt;16379/tc</span><br><span class="line">                                                     p, 0.0.0.0:6379-&gt;6379/tcp,:::6379-&gt;6379/tcp</span><br><span class="line">redis6380   docker-entrypoint.sh redis ...   Up      0.0.0.0:16380-&gt;16380/tcp,:::16380-&gt;16380/tc</span><br><span class="line">                                                     p, 6379/tcp,                               </span><br><span class="line">                                                     0.0.0.0:6380-&gt;6380/tcp,:::6380-&gt;6380/tcp   </span><br><span class="line">redis6381   docker-entrypoint.sh redis ...   Up      0.0.0.0:16381-&gt;16381/tcp,:::16381-&gt;16381/tc</span><br><span class="line">                                                     p, 6379/tcp,                               </span><br><span class="line">                                                     0.0.0.0:6381-&gt;6381/tcp,:::6381-&gt;6381/tcp   </span><br><span class="line">redis6389   docker-entrypoint.sh redis ...   Up      0.0.0.0:16389-&gt;16389/tcp,:::16389-&gt;16389/tc</span><br><span class="line">                                                     p, 6379/tcp,                               </span><br><span class="line">                                                     0.0.0.0:6389-&gt;6389/tcp,:::6389-&gt;6389/tcp   </span><br><span class="line">redis6390   docker-entrypoint.sh redis ...   Up      0.0.0.0:16390-&gt;16390/tcp,:::16390-&gt;16390/tc</span><br><span class="line">                                                     p, 6379/tcp,                               </span><br><span class="line">                                                     0.0.0.0:6390-&gt;6390/tcp,:::6390-&gt;6390/tcp   </span><br><span class="line">redis6391   docker-entrypoint.sh redis ...   Up      0.0.0.0:16391-&gt;16391/tcp,:::16391-&gt;16391/tc</span><br><span class="line">                                                     p, 6379/tcp,                               </span><br><span class="line">                                                     0.0.0.0:6391-&gt;6391/tcp,:::6391-&gt;6391/tcp   </span><br></pre></td></tr></table></figure>

<p><strong>5. 随便进入任意主节点，执行命令分配<code>slots</code>以及主从关系</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis]# docker exec -it redis6379 /bin/bash</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 输入以下命令</span></span><br><span class="line">redis-cli --cluster create --cluster-replicas 1 -a 6o5.......................E1orO 192.168.205.200:6379 192.168.205.200:6380 192.168.205.200:6381 192.168.205.200:6389 192.168.205.200:6390 192.168.205.200:6391</span><br></pre></td></tr></table></figure>

<p>连接<code>redis</code>结点查看<code>cluster</code>信息</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Performing Cluster Check (using node 192.168.205.200:6379)</span></span><br><span class="line">M: c6412d958f8f4900940d6adb3cc693437bd0193c 192.168.205.200:6379</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 2566111fdd7f42592720294ce9a6feb56de307d8 172.21.0.1:6380</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">M: 5db0a9aabe5627a3803d9debda7661fdafab6bfa 172.21.0.1:6381</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: e9469f171253da669f773fe220c822872084460e 172.21.0.1:6389</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 2566111fdd7f42592720294ce9a6feb56de307d8</span><br><span class="line">S: b7658d5ea3c357892471658a45a2ce6deaf3a7a4 172.21.0.1:6390</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 5db0a9aabe5627a3803d9debda7661fdafab6bfa</span><br><span class="line">S: 012ab8349ee18675dfcba192ce179571d6ce8f31 172.21.0.1:6391</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates c6412d958f8f4900940d6adb3cc693437bd0193c</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check <span class="keyword">for</span> open slots...</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; Check slots coverage...</span></span><br><span class="line">[OK] All 16384 slots covered.</span><br><span class="line"></span><br><span class="line">root@77a5bddfd6ab:/data# redis-cli -a 6o5F.........................1orO -c -p 6379</span><br><span class="line">Warning: Using a password with &#x27;-a&#x27; or &#x27;-u&#x27; option on the command line interface may not be safe.</span><br><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br><span class="line">127.0.0.1:6379&gt; CLUSTER INFO</span><br><span class="line">cluster_state:ok</span><br><span class="line">cluster_slots_assigned:16384</span><br><span class="line">cluster_slots_ok:16384</span><br><span class="line">cluster_slots_pfail:0</span><br><span class="line">cluster_slots_fail:0</span><br><span class="line">cluster_known_nodes:6</span><br><span class="line">cluster_size:3</span><br><span class="line">cluster_current_epoch:6</span><br><span class="line">cluster_my_epoch:1</span><br><span class="line">cluster_stats_messages_ping_sent:54</span><br><span class="line">cluster_stats_messages_pong_sent:60</span><br><span class="line">cluster_stats_messages_sent:114</span><br><span class="line">cluster_stats_messages_ping_received:55</span><br><span class="line">cluster_stats_messages_pong_received:54</span><br><span class="line">cluster_stats_messages_meet_received:5</span><br><span class="line">cluster_stats_messages_received:114</span><br></pre></td></tr></table></figure>

<p>可以看到，集群创建成功</p>
<p>测试可以内网访问，外网无法<code>ping</code>通</p>
<p>在<code>6379</code>创建一个键<code>keyTest</code>，转到了<code>6381</code>服务，在其对应的从机<code>6390</code>可以读到该键</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set keyTest helloworld</span><br><span class="line"><span class="meta">-&gt;</span><span class="bash"> Redirected to slot [15774] located at 172.21.0.1:6381</span></span><br><span class="line">OK</span><br><span class="line">172.21.0.1:6381&gt; KEYS *</span><br><span class="line">1) &quot;keyTest&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在其他的服务中无法找到，因为slot据哈希机制分配槽位</span></span><br><span class="line">127.0.0.1:6380&gt; KEYS *</span><br><span class="line">(empty array)</span><br><span class="line"></span><br><span class="line">127.0.0.1:6391&gt; CLUSTER NODES</span><br><span class="line">2566111fdd7f42592720294ce9a6feb56de307d8 172.21.0.1:6380@16380 master - 0 1644420185000 2 connected 5461-10922</span><br><span class="line">012ab8349ee18675dfcba192ce179571d6ce8f31 172.21.0.3:6391@16391 myself,slave c6412d958f8f4900940d6adb3cc693437bd0193c 0 1644420183000 1 connected</span><br><span class="line">c6412d958f8f4900940d6adb3cc693437bd0193c 172.21.0.1:6379@16379 master - 0 1644420186353 1 connected 0-5460</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到，6390从机对应6381主机，因此设置的数据可以被查到</span></span><br><span class="line">b7658d5ea3c357892471658a45a2ce6deaf3a7a4 172.21.0.1:6390@16390 slave 5db0a9aabe5627a3803d9debda7661fdafab6bfa 0 1644420185000 3 connected</span><br><span class="line">e9469f171253da669f773fe220c822872084460e 172.21.0.1:6389@16389 slave 2566111fdd7f42592720294ce9a6feb56de307d8 0 1644420185345 2 connected</span><br><span class="line">5db0a9aabe5627a3803d9debda7661fdafab6bfa 172.21.0.1:6381@16381 master - 0 1644420184338 3 connected 10923-16383</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看到，对应的从机可以读到主机的数据</span></span><br><span class="line">127.0.0.1:6390&gt; keys *</span><br><span class="line">1) &quot;keyTest&quot;</span><br><span class="line">127.0.0.1:6391&gt; keys *</span><br><span class="line">(empty array)</span><br></pre></td></tr></table></figure>

<p>安装<code>nmap</code>测试工具，查看端口开放情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装nmap</span></span><br><span class="line">[root@localhost redis]# yum install nmap</span><br></pre></td></tr></table></figure>

<p>查看端口开放情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis]# nmap 127.0.0.1</span><br><span class="line"></span><br><span class="line">Starting Nmap 6.40 ( http://nmap.org ) at 2022-02-09 23:28 CST</span><br><span class="line">Nmap scan report for localhost (127.0.0.1)</span><br><span class="line">Host is up (0.0000060s latency).</span><br><span class="line">Not shown: 996 closed ports</span><br><span class="line">PORT     STATE SERVICE</span><br><span class="line">22/tcp   open  ssh</span><br><span class="line">25/tcp   open  smtp</span><br><span class="line">3306/tcp open  mysql</span><br><span class="line">6389/tcp open  clariion-evr01</span><br><span class="line"></span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 1.59 seconds</span><br></pre></td></tr></table></figure>

<p>也可以查看端口开放情况</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis]# firewall-cmd --query-port=6379/tcp</span><br><span class="line">no</span><br></pre></td></tr></table></figure>

<p>因此，需要开放其他使用到的端口</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost redis]# firewall-cmd --zone=public --add-port=6379/tcp --permanent</span><br><span class="line">success</span><br><span class="line">[root@localhost redis]# firewall-cmd --zone=public --add-port=6380/tcp --permanent</span><br><span class="line">success</span><br><span class="line">[root@localhost redis]# firewall-cmd --zone=public --add-port=6381/tcp --permanent</span><br><span class="line">success</span><br><span class="line">[root@localhost redis]# firewall-cmd --zone=public --add-port=6389/tcp --permanent</span><br><span class="line">success</span><br><span class="line">[root@localhost redis]# firewall-cmd --zone=public --add-port=6390/tcp --permanent</span><br><span class="line">success</span><br><span class="line">[root@localhost redis]# firewall-cmd --zone=public --add-port=6391/tcp --permanent</span><br><span class="line">success</span><br><span class="line">[root@localhost redis]# firewall-cmd --zone=public --add-port=16379/tcp --permanent</span><br><span class="line">success</span><br><span class="line">[root@localhost redis]# firewall-cmd --zone=public --add-port=16380/tcp --permanent</span><br><span class="line">success</span><br><span class="line">[root@localhost redis]# firewall-cmd --zone=public --add-port=16381/tcp --permanent</span><br><span class="line">success</span><br><span class="line">[root@localhost redis]# firewall-cmd --zone=public --add-port=16389/tcp --permanent</span><br><span class="line">success</span><br><span class="line">[root@localhost redis]# firewall-cmd --zone=public --add-port=16390/tcp --permanent</span><br><span class="line">success</span><br><span class="line">[root@localhost redis]# firewall-cmd --zone=public --add-port=16391/tcp --permanent</span><br><span class="line">success</span><br><span class="line">[root@localhost redis]# firewall-cmd --zone=public --list-ports</span><br><span class="line">6379/tcp 6380/tcp 6381/tcp 6389/tcp 6390/tcp 6391/tcp 16391/tcp 16379/tcp 16380/tcp 16381/tcp 16389/tcp 16390/tcp</span><br><span class="line">[root@localhost redis]# firewall-cmd --reload</span><br><span class="line">success</span><br></pre></td></tr></table></figure>

<p>再次测试，即可在外网正常访问</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220219141106992.png" alt="image-20220219141106992"></p>
<p><strong>6. 测试是否可以正常连接到<code>redis</code>集群</strong></p>
<p>多次尝试，并检查端口，发现所有涉及的端口均可以访问，但是在SpringBoot中尝试了一整天仍然无法连接到redis数据库，但是阿里云服务器上同样方式部署的服务就可以正常连接，无果。最后考虑到lua脚本无法自动切换连接的端口，因此更换方式采用连接docker中部署的单redis</p>
<blockquote>
<p><strong>流程如下：</strong></p>
<p>使用如下命令启动容器：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker run --name redis \</span><br><span class="line">-v /usr/local/dbBackup/redis/data:/data \</span><br><span class="line">-v /usr/local/dbBackup/redis/redis_single.conf:/etc/redis/redis.conf \</span><br><span class="line">-p 6379:6379 \</span><br><span class="line">-d redis redis-server /etc/redis/redis.conf</span><br></pre></td></tr></table></figure>

<p>启动后，测试是否可以正常访问：</p>
<p>修改yml配置如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#  单机redis配置</span></span><br><span class="line"><span class="attr">redis:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.205</span><span class="number">.200</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">database:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">6o5FLS9bSJmdTGlyqJWxiEGf56vE1orO</span></span><br><span class="line">  <span class="comment"># Redis连接池设置</span></span><br><span class="line">  <span class="attr">lettuce:</span></span><br><span class="line">    <span class="attr">pool:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment"># 连接池最大连接数（使用负值表示没有限制）</span></span><br><span class="line">      <span class="attr">max-active:</span> <span class="number">1000</span></span><br><span class="line">      <span class="comment"># 连接池中的最大空闲连接</span></span><br><span class="line">      <span class="attr">max-idle:</span> <span class="number">10</span></span><br><span class="line">      <span class="comment"># 连接池中的最小空闲连接</span></span><br><span class="line">      <span class="attr">min-idle:</span> <span class="number">5</span></span><br><span class="line">      <span class="comment"># 连接池最大阻塞等待时间（使用负值表示没有限制）</span></span><br><span class="line">      <span class="attr">max-wait:</span> <span class="number">-1</span></span><br></pre></td></tr></table></figure>

<p>测试如下：</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220220095508459.png" alt="image-20220220095508459"></p>
<p>这次测试终于没有问题了，之后就采用该模式连接。</p>
</blockquote>
<h3 id="Docker中部署RabbitMQ"><a href="#Docker中部署RabbitMQ" class="headerlink" title="Docker中部署RabbitMQ"></a>Docker中部署RabbitMQ</h3><p><strong>1. 首先在线拉取RabbitMQ镜像</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull rabbitmq:3-management</span><br></pre></td></tr></table></figure>

<p><strong>2. 安装RabbitMQ，即执行容器</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">docker run \</span><br><span class="line"> -e RABBITMQ_DEFAULT_USER=heavytiger \</span><br><span class="line"> -e RABBITMQ_DEFAULT_PASS=a.........m \</span><br><span class="line"> --name mq \</span><br><span class="line"> --hostname mq1 \</span><br><span class="line"> -p 15672:15672 \</span><br><span class="line"> -p 5672:5672 \</span><br><span class="line"> -d \</span><br><span class="line"> rabbitmq:3-management</span><br><span class="line"> </span><br><span class="line"> [root@localhost /]# docker ps</span><br><span class="line">CONTAINER ID   IMAGE                   COMMAND                  CREATED          STATUS          PORTS                                                                                                                                                 NAMES</span><br><span class="line">8a7012d4a213   rabbitmq:3-management   &quot;docker-entrypoint.s…&quot;   10 seconds ago   Up 10 seconds   4369/tcp, 5671/tcp, 0.0.0.0:5672-&gt;5672/tcp, :::5672-&gt;5672/tcp, 15671/tcp, 15691-15692/tcp, 25672/tcp, 0.0.0.0:15672-&gt;15672/tcp, :::15672-&gt;15672/tcp   mq</span><br><span class="line">4ba1eea6fba3   redis                   &quot;docker-entrypoint.s…&quot;   42 hours ago     Up 42 hours     0.0.0.0:6379-&gt;6379/tcp, :::6379-&gt;6379/tcp                                                                                                             redis</span><br><span class="line">757d2d305710   mysql:8.0.28            &quot;docker-entrypoint.s…&quot;   43 hours ago     Up 43 hours     0.0.0.0:3306-&gt;3306/tcp, :::3306-&gt;3306/tcp, 33060/tcp                                                                                                  mysql</span><br></pre></td></tr></table></figure>

<p><strong>3. 访问RabbitMQ Management</strong></p>
<p>在浏览器中访问地址：<code>your virtual machine ip:15672</code></p>
<p>在输入启动容器时配置的帐号密码，即可正常访问：<code> -e RABBITMQ_DEFAULT_USER=heavytiger</code>和<code>-e RABBITMQ_DEFAULT_PASS=a.........m</code></p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220218195919400.png" alt="image-20220218195919400"></p>
<p><strong>4. 在<code>SpringBoot</code>中配置<code>RabbitMQ</code></strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="comment"># RabbitMQ配置，消息队列</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">192.168</span><span class="number">.205</span><span class="number">.200</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">heavytiger</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">37628981mm</span></span><br><span class="line">    <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="comment"># 消费者最小数量</span></span><br><span class="line">        <span class="attr">concurrency:</span> <span class="number">10</span></span><br><span class="line">        <span class="comment"># 消费者最大数量</span></span><br><span class="line">        <span class="attr">max-concurrency:</span> <span class="number">10</span></span><br><span class="line">        <span class="comment"># 限制一次处理一条消息，不要预取，默认预取250条</span></span><br><span class="line">        <span class="attr">prefetch:</span> <span class="number">1</span></span><br><span class="line">        <span class="comment"># 启动时是否默认启动容器</span></span><br><span class="line">        <span class="attr">auto-startup:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># 被拒绝时选择重新入队</span></span><br><span class="line">        <span class="attr">default-requeue-rejected:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="comment"># 如果被拒绝了，进行重试</span></span><br><span class="line">      <span class="attr">retry:</span></span><br><span class="line">        <span class="comment"># 开启重试</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">        <span class="comment"># 重试时间</span></span><br><span class="line">        <span class="attr">initial-interval:</span> <span class="string">1000ms</span></span><br><span class="line">        <span class="comment"># 默认重试次数</span></span><br><span class="line">        <span class="attr">max-attempts:</span> <span class="number">3</span></span><br><span class="line">        <span class="comment"># 重试最大间隔时间</span></span><br><span class="line">        <span class="attr">max-interval:</span> <span class="string">10000ms</span></span><br><span class="line">        <span class="comment"># 重试的间隔乘数，例如2.0，第一次等10s，第二次20s，第三次40s</span></span><br><span class="line">        <span class="attr">multiplier:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="秒杀模块的实现"><a href="#秒杀模块的实现" class="headerlink" title="秒杀模块的实现"></a>秒杀模块的实现</h2><h3 id="数据库表的设计"><a href="#数据库表的设计" class="headerlink" title="数据库表的设计"></a>数据库表的设计</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> seckill_order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> seckill_products;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `seckill_order` (</span><br><span class="line">	`id` <span class="type">INT</span> UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;秒杀订单ID&#x27;</span>,</span><br><span class="line">	`customer_id` <span class="type">INT</span> UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;用户ID&#x27;</span>,</span><br><span class="line">	`order_id` <span class="type">INT</span> UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;订单ID&#x27;</span>,</span><br><span class="line">	`product_id` <span class="type">INT</span> UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品ID&#x27;</span>,</span><br><span class="line">	<span class="keyword">PRIMARY</span> KEY ( `id` ) </span><br><span class="line">) ENGINE <span class="operator">=</span> INNODB AUTO_INCREMENT <span class="operator">=</span> <span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `seckill_products` (</span><br><span class="line">	`id` <span class="type">INT</span> UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT COMMENT <span class="string">&#x27;秒杀商品ID&#x27;</span>,</span><br><span class="line">	`product_id` <span class="type">INT</span> UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;商品ID&#x27;</span>,</span><br><span class="line">	`seckill_price` <span class="type">DECIMAL</span> ( <span class="number">10</span>, <span class="number">2</span> ) <span class="keyword">DEFAULT</span> ( <span class="number">0.01</span> ) <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;秒杀价格&#x27;</span>,</span><br><span class="line">	`stock` <span class="type">INT</span> UNSIGNED <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;库存数量&#x27;</span>,</span><br><span class="line">	`start_date` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;秒杀开始时间&#x27;</span>,</span><br><span class="line">	`end_date` datetime <span class="keyword">NOT</span> <span class="keyword">NULL</span> COMMENT <span class="string">&#x27;秒杀结束时间&#x27;</span>,</span><br><span class="line"><span class="keyword">PRIMARY</span> KEY ( `id` ) </span><br><span class="line">) ENGINE <span class="operator">=</span> INNODB AUTO_INCREMENT <span class="operator">=</span> <span class="number">1</span> <span class="keyword">DEFAULT</span> CHARSET <span class="operator">=</span> utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `mall`.`seckill_products` (`id`, `product_id`, `seckill_price`, `stock`, `start_date`, `end_date`) <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">99.00</span>, <span class="number">10</span>, <span class="string">&#x27;2022-02-11 14:00:00&#x27;</span>, <span class="string">&#x27;2022-02-11 14:10:00&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="编写pojo和mapper层"><a href="#编写pojo和mapper层" class="headerlink" title="编写pojo和mapper层"></a>编写pojo和mapper层</h3><p><strong>秒杀商品表以及秒杀订单表要实现增删改查等功能</strong></p>
<p>比较简单，和之前SSM框架搭建的操作步骤一样即可，不再赘述</p>
<p>只展示<code>SeckillOrderMapper.xml</code>和<code>SeckillProductMapper.xml</code>文件的代码</p>
<p><strong>SeckillOrderMapper.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.heavytiger.mall.mapper.SeckillOrderMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;addSeckillOrder&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span> <span class="attr">keyColumn</span>=<span class="string">&quot;id&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">parameterType</span>=<span class="string">&quot;SeckillOrder&quot;</span>&gt;</span></span><br><span class="line">        INSERT INTO mall.seckill_order (id, customer_id, order_id, product_id)</span><br><span class="line">        VALUES (#&#123;id&#125;, #&#123;customerId&#125;, #&#123;orderId&#125;, #&#123;productId&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteSeckillOrder&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">        DELETE</span><br><span class="line">        FROM mall.seckill_order</span><br><span class="line">        WHERE id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateSeckillOrder&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;SeckillOrder&quot;</span>&gt;</span></span><br><span class="line">        UPDATE mall.seckill_order</span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;customerId != null&quot;</span>&gt;</span>customer_id=#&#123;customerId&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;OrderId != null&quot;</span>&gt;</span>order_id=#&#123;orderId&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;ProductId != null&quot;</span>&gt;</span>product_id=#&#123;productId&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        WHERE id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;SeckillOrderMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;SeckillOrder&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;customer_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;customerId&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;order_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;orderId&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;product_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;productId&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;querySeckillOrderById&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;int&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;SeckillOrderMap&quot;</span>&gt;</span></span><br><span class="line">        SELECT *</span><br><span class="line">        FROM mall.seckill_order</span><br><span class="line">        WHERE id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;querySeckillOrders&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;SeckillOrderMap&quot;</span>&gt;</span></span><br><span class="line">        SELECT *</span><br><span class="line">        FROM mall.seckill_order</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;querySeckillOrdersByCustomerId&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;int&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;SeckillOrderMap&quot;</span>&gt;</span></span><br><span class="line">        SELECT *</span><br><span class="line">        FROM mall.seckill_order</span><br><span class="line">        WHERE customer_id = #&#123;customerId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>SeckillProductMapper.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="meta-string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.heavytiger.mall.mapper.SeckillProductMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;addSeckillProduct&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span> <span class="attr">keyColumn</span>=<span class="string">&quot;id&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">parameterType</span>=<span class="string">&quot;SeckillProduct&quot;</span>&gt;</span></span><br><span class="line">        INSERT INTO mall.seckill_products(id, product_id, seckill_price, stock, start_date, end_date)</span><br><span class="line">        VALUES (#&#123;id&#125;, #&#123;productId&#125;, #&#123;seckillPrice&#125;, #&#123;stock&#125;, #&#123;startDate&#125;, #&#123;endDate&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">&quot;deleteSeckillProduct&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">        DELETE</span><br><span class="line">        FROM mall.seckill_products</span><br><span class="line">        WHERE id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updateSeckillProduct&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;SeckillProduct&quot;</span>&gt;</span></span><br><span class="line">        UPDATE mall.seckill_products</span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;productId != null&quot;</span>&gt;</span>product_id=#&#123;productId&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;seckillPrice != null&quot;</span>&gt;</span>seckill_price=#&#123;seckillPrice&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;stock != null&quot;</span>&gt;</span>stock=#&#123;stock&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;startDate != null&quot;</span>&gt;</span>start_date=#&#123;startDate&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">&quot;endDate != null&quot;</span>&gt;</span>end_date=#&#123;endDate&#125;<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">        WHERE id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;SeckillProductMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;SeckillProduct&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;product_id&quot;</span> <span class="attr">property</span>=<span class="string">&quot;productId&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;seckill_price&quot;</span> <span class="attr">property</span>=<span class="string">&quot;seckillPrice&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;stock&quot;</span> <span class="attr">property</span>=<span class="string">&quot;stock&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;start_date&quot;</span> <span class="attr">property</span>=<span class="string">&quot;startDate&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;end_date&quot;</span> <span class="attr">property</span>=<span class="string">&quot;endDate&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;querySeckillProductById&quot;</span> <span class="attr">parameterType</span>=<span class="string">&quot;int&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;SeckillProductMap&quot;</span>&gt;</span></span><br><span class="line">        SELECT *</span><br><span class="line">        FROM mall.seckill_products</span><br><span class="line">        WHERE id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;querySeckillProducts&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;SeckillProductMap&quot;</span>&gt;</span></span><br><span class="line">        SELECT *</span><br><span class="line">        FROM mall.seckill_products</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;querySeckillProductByProductId&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;SeckillProductMap&quot;</span>&gt;</span></span><br><span class="line">        SELECT *</span><br><span class="line">        FROM mall.seckill_products</span><br><span class="line">        WHERE product_id = #&#123;productId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="编写Service层"><a href="#编写Service层" class="headerlink" title="编写Service层"></a>编写Service层</h3><p>之后会编写代码实现以下接口，有些接口可能没有使用过，有些为了不在<code>service</code>中返回<code>controller</code>层需要返回给前台的格式或者抛出异常，直接在<code>controller</code>层实现了，避免代码量比较大，<code>mapper</code>中的一些方法也没有使用过，仅作为参考</p>
<p><strong>SeckillProductService</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.heavytiger.mall.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.heavytiger.mall.dto.SeckillExposer;</span><br><span class="line"><span class="keyword">import</span> com.heavytiger.mall.pojo.SeckillProduct;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> heavytiger</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 秒杀商品的Service层接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/2/13 23:17</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SeckillProductService</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 通过商品的ID获取秒杀的物品信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 秒杀的商品信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 查询到的可以秒杀的商品</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillProduct <span class="title">querySeckillProductById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询秒杀商品表中的商品编号，在秒杀结束后删除秒杀商品表中的记录，因此商品编号有唯一性</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pid 需要查询的秒杀商品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 获得当前商品的秒杀信息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillProduct <span class="title">querySeckillProductByProductId</span><span class="params">(Integer pid)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 进行秒杀某个物品.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 秒杀的商品ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 顾客的ID</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pathMD5 校验秒杀接口地址，防止接口暴露</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 是否秒杀成功</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">doSeckill</span><span class="params">(Integer id, Integer userId, String pathMD5)</span></span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 查询全部秒杀商品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回查询到的所有秒杀商品</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;SeckillProduct&gt; <span class="title">querySeckillProducts</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取商品详情信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillExposer <span class="title">getDetail</span><span class="params">(Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 删除秒杀商品</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">deleteSeckillProduct</span><span class="params">(Integer id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建唯一的秒杀地址，防止地址提前暴露</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">createPath</span><span class="params">(Integer userId, Integer seckillId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 修改秒杀商品表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillProduct</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">updateSeckillProduct</span><span class="params">(SeckillProduct seckillProduct)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>SeckillOrderService</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.heavytiger.mall.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.heavytiger.mall.pojo.SeckillOrder;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> heavytiger</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 秒杀商品订单的Service层接口</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/2/13 23:18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SeckillOrderService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加秒杀订单</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userId 用户的id</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> seckillId 需要添加的秒杀订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回影响的行数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">addSeckillOrder</span><span class="params">(Integer seckillId, Integer userId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据订单号查询订单</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> id 需要查询的订单号</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 返回根据订单号查询到的订单</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SeckillOrder <span class="title">querySeckillOrderById</span><span class="params">(Integer id)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="秒杀模块实现的思路"><a href="#秒杀模块实现的思路" class="headerlink" title="秒杀模块实现的思路"></a>秒杀模块实现的思路</h2><h3 id="秒杀商品的预热"><a href="#秒杀商品的预热" class="headerlink" title="秒杀商品的预热"></a>秒杀商品的预热</h3><p>首先可以秒杀的商品相关信息应该存储在数据库中，可以使得数据持久化，后台管理也可以方便地添加秒杀商品的预热记录，但是如何将预热的数据导入到秒杀模块中呢？</p>
<blockquote>
<p>我使用了Spring提供的定时任务，将数据库中存储的秒杀商品数据导入到本地，使用Redis进行缓存，库存缓存一份，商品数据缓存一份，先在Redis中预减库存，并将成功秒杀到的商品生成用户订单 ，这将极大地提升QPS，并且降低数据源的压力</p>
<p>使用<code>Spring</code>的注解，每隔5分钟扫描一次数据库秒杀商品表，如果<code>Redis</code>中已经存在库存信息则不重复添加，否则将数据导入后再次更新数据</p>
<p>之后为了再次提高QPS，设置了一个<code>HashMap</code>类型的库存售罄的标志，在库存清空的时候，将该标记设置为<code>True</code>，之后用户访问API将访问标志后直接返回库存不足的信息，可以将QPS提高近一倍</p>
</blockquote>
<h3 id="瞬时高并发的处理"><a href="#瞬时高并发的处理" class="headerlink" title="瞬时高并发的处理"></a>瞬时高并发的处理</h3><p>一般在秒杀开始的瞬间，用户对接口请求的并发量急速增加，可能在一瞬间达到顶峰，例如本次测试时使用2000个用户同时进行秒杀，此时这种大部分用户会秒杀失败的场景，可能会在一瞬间将后台的数据库干掉，因此不能让这些流量在一瞬间全部进入后台进行磁盘IO，我们需要改进系统使其能应付该瞬时高并发场景</p>
<p>可以尝试以下的方式：</p>
<ol>
<li>页面静态化</li>
<li>CDN加速</li>
<li>缓存预减库存</li>
<li>异步消息处理订单</li>
<li>限流</li>
<li>分布式锁等</li>
</ol>
<p><strong>（由于本人不熟悉前端，因此没有做用户端的内容展示。使用前后端分离的方案，只用Jmeter压测了API请求）</strong></p>
<h3 id="缓存预减库存"><a href="#缓存预减库存" class="headerlink" title="缓存预减库存"></a>缓存预减库存</h3><p>在秒杀过程中，系统会检查库存是否充足，若充足则允许下单，写数据库，若不够，则直接返回该商品已经被抢购完，但是只有很少的人能够成功秒杀商品，因此这是很典型的<strong>读多写少</strong>型场景。假如数十万的请求查数据库库存是否充足，数据库会挂掉，因为连接资源有限无法支撑如此大的流量。</p>
<p>因此我们使用<code>Redis</code>进行库存的缓存，我的思路是首先在预热阶段将商品的库存和秒杀商品的信息(id，物品id，秒杀总数，开始时间，结束时间)加入<code>Redis</code>，在访问秒杀API接口时，通过Redis预减库存，之后通过RabbitMQ异步下订单，提高QPS。</p>
<h4 id="缓存击穿，缓存穿透问题"><a href="#缓存击穿，缓存穿透问题" class="headerlink" title="缓存击穿，缓存穿透问题"></a>缓存击穿，缓存穿透问题</h4><p>使用Redis时会存在缓存击穿以及缓存穿透等问题，由于我使用了定时任务，并且保证所有的秒杀活动设置都需要提前1h，因此能保证在秒杀开始时，Redis中一定存在相关商品的库存缓存，若不存在一定是因为没有该商品，这样考虑理论上可以避免缓存击穿穿透问题。</p>
<blockquote>
<p><strong>解决缓存击穿的方案</strong></p>
<p>但是，仍然会存一些bug，比如扫描表挂掉了，阻塞地情况，因此我们可以考虑使用分布式锁来解决缓存击穿的问题，每次访问时，如果没有查到缓存库存，让该线程尝试持有使用<code>Redis</code>实现的自旋锁，如果没有抢到锁则阻塞，抢到锁的将秒杀商品数据导入Redis缓存并释放锁，其他的线程自旋再次尝试获取缓存（由于已经设计了定时任务预热商品的步骤，因此没有实现分布式锁）也可以使用<code>redission</code>实现分布式锁</p>
<p><strong>解决缓存穿透的方案</strong></p>
<p>即使解决了缓存击穿，仍然可能因为秒杀商品表中没有商品而导致线程不停地重复获得锁，但是从数据库中又没有取到值，最后仍导致效率极低，可以使用布隆过滤器解决，我使用哈希表作为标志解决这个问题。</p>
</blockquote>
<h4 id="库存预减流程"><a href="#库存预减流程" class="headerlink" title="库存预减流程"></a>库存预减流程</h4><p>我使用<code>Redis</code>中的<code>lua</code>脚本实现伪事务的效果，保证操作的原子性，这样就不会导致提交覆盖的问题产生。</p>
<h3 id="RabbitMQ异步生成订单"><a href="#RabbitMQ异步生成订单" class="headerlink" title="RabbitMQ异步生成订单"></a>RabbitMQ异步生成订单</h3><p>秒杀场景中，并发量巨大的是秒杀功能，下单和支付功能实际的并发量很小，所以在设计秒杀模块时，应该将下单支付模块解耦出来，作为异步任务处理</p>
<p>在这里我们使用了<code>RabbitMQ</code>消息队列来实现异步生成订单的功能(主要是熟悉下RabbitMQ的使用)。</p>
<h4 id="消息队列信息丢失"><a href="#消息队列信息丢失" class="headerlink" title="消息队列信息丢失"></a>消息队列信息丢失</h4><p>若消息队列发送订单信息时出现了信息丢失，有三种可能：</p>
<ol>
<li>生产者往MQ写数据丢失了<br>可能因为网络原因数据传输丢失。</li>
<li>MQ本身数据丢失了<br>数据放在内存中，MQ机器宕机了，那么内存中的数据丢失了。</li>
<li>消费者消费的时候丢失了<br>消费者接受到消息，马上给MQ返回已经接受到消息的回复，消费者接着处理逻辑，在处理过程中，消费者宕机了；下次重启的时候消费者会获取到下一条数据消费，这样数据就丢失了。</li>
</ol>
<blockquote>
<p><strong>解决方案：</strong></p>
<ol>
<li>解决生产者丢失数据</li>
</ol>
<p>  生产者开启<code>confirm</code>模式，每个消息分配唯一<code>id</code>，生产者发送完消息之后就不用管了，<code>MQ</code>如果成功接收到消息，那么会调用生产者的<code>ack(String messageId)</code>方法；<code>MQ</code>如果接收失败，那么会调用生产者<code>nack(String messageId)</code>方法，生产者根据情况判断是否要重试；</p>
<ol start="2">
<li>解决<code>MQ</code>丢失数据</li>
</ol>
<p>  开启持久化，把内存中的数据写入磁盘，这样可以使得服务器宕机后重启时仍然能恢复消息数据</p>
<ol start="3">
<li><p>解决消费者丢失数据</p>
<p>消费者关闭<code>autoAck</code>，等自己全部处理完成后再发送<code>ack</code>给<code>RabbitMQ</code>，这样可以使得数据再消费者端不丢失</p>
</li>
</ol>
</blockquote>
<h4 id="消息队列重复消费"><a href="#消息队列重复消费" class="headerlink" title="消息队列重复消费"></a>消息队列重复消费</h4><p>再消费者消费消息时，若<code>ack</code>应答时出现了网络丢失等情况，可能会导致重复消费的情况，因为<code>MQ</code>有重试机制，会重新发送消息给消费者端，导致生成多条订单。</p>
<p>我的方案是在<code>Redis</code>中建立一个<code>set</code>保存秒杀成功的用户<code>id</code>，如果消费者端要生成该用户的订单，则先尝试删除<code>set</code>中的<code>id</code>值，若删除成功正常执行，若不成功则提示重复生成订单，若之后的操作存在问题，Spring事务会回滚。</p>
<h2 id="秒杀模块的相关实现"><a href="#秒杀模块的相关实现" class="headerlink" title="秒杀模块的相关实现"></a>秒杀模块的相关实现</h2><h3 id="秒杀商品的预热实现"><a href="#秒杀商品的预热实现" class="headerlink" title="秒杀商品的预热实现"></a>秒杀商品的预热实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> heavytiger</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 扫描数据库，将秒杀信息储存到Redis中</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/2/16 11:59</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DatabaseScanTask</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SeckillProductService seckillProductService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HashMap&lt;String, Boolean&gt; seckillOverMap;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Scheduled(cron = &quot;30 */5 * * * ?&quot;)</span></span><br><span class="line">    <span class="meta">@Transactional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">databaseScanTask</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 商品预热，每隔5分钟从将未添加的秒杀商品数据添加到Redis中，例如12:00:30, 12:05:30, 12:10:30</span></span><br><span class="line">        ValueOperations&lt;String, Object&gt; valueOperations = redisTemplate.opsForValue();</span><br><span class="line">        List&lt;SeckillProduct&gt; products = seckillProductService.querySeckillProducts();</span><br><span class="line">        <span class="keyword">for</span> (SeckillProduct product : products) &#123;</span><br><span class="line">            Integer curStock = (Integer) valueOperations.get(<span class="string">&quot;seckillStock:&quot;</span> + product.getId());</span><br><span class="line">            <span class="keyword">if</span> (curStock == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 表示redis中的该秒杀商品为空，应该将秒杀商品添加进去</span></span><br><span class="line">                <span class="keyword">long</span> curTimestamp = System.currentTimeMillis();         <span class="comment">// 当前时间</span></span><br><span class="line">                <span class="keyword">long</span> endTimestamp = product.getEndDate().getTime();     <span class="comment">// 结束时间</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// 如果当前时间大于秒杀时间，说明秒杀已经结束了，将秒杀商品表中的商品删除，商品售罄标记删除，直接返回</span></span><br><span class="line">                <span class="keyword">if</span> (endTimestamp &lt; curTimestamp) &#123;</span><br><span class="line">                    seckillProductService.deleteSeckillProduct(product.getId());</span><br><span class="line">                    seckillOverMap.remove(<span class="string">&quot;seckillProduct:&quot;</span> + product.getId());</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 设置秒杀商品的库存</span></span><br><span class="line">                valueOperations.setIfAbsent(<span class="string">&quot;seckillStock:&quot;</span> + product.getId(), product.getStock(),</span><br><span class="line">                        endTimestamp - curTimestamp, TimeUnit.MILLISECONDS);</span><br><span class="line">                <span class="comment">// 将秒杀商品信息缓存</span></span><br><span class="line">                valueOperations.setIfAbsent(<span class="string">&quot;seckillProduct:&quot;</span> + product.getId(), product,</span><br><span class="line">                        endTimestamp - curTimestamp, TimeUnit.MILLISECONDS);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 设置秒杀商品的售罄状态为False，表示未售罄</span></span><br><span class="line">            seckillOverMap.putIfAbsent(<span class="string">&quot;seckillProduct:&quot;</span> + product.getId(), Boolean.FALSE);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 在项目启动初始化所有的Bean时进行初始化系统，加载所有的秒杀商品</span></span><br><span class="line">        databaseScanTask();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用语句：<code>@Scheduled(cron = &quot;30 */5 * * * ?&quot;)</code>创建定时任务，每5分钟的第30s执行定时任务，因为秒杀一般会选在整点开启，因此，特意错开到30s的时候执行，且每隔5min执行一次，在设置秒杀活动时，对开始时间设置要求，这样就不会出现秒杀时无法找到商品的情况。</p>
<p><strong>注意此时在<code>Redis</code>中设置的库存键的名称以及商品键的名称</strong></p>
<p>注意，库存售罄标志使用<code>@Bean</code>单例模式注入，方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.heavytiger.mall.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> heavytiger</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 标记秒杀结束</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/2/21 16:31</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillOverConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 获得全局标记hashmap，标记商品是否卖完</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HashMap&lt;String, Boolean&gt; <span class="title">seckillOverMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="秒杀的相关设计实现"><a href="#秒杀的相关设计实现" class="headerlink" title="秒杀的相关设计实现"></a>秒杀的相关设计实现</h3><h4 id="获取秒杀的信息"><a href="#获取秒杀的信息" class="headerlink" title="获取秒杀的信息"></a>获取秒杀的信息</h4><p>前端会需要与后端同步信息，获取服务器的时间，秒杀开始的时间，结束的时间等信息，因此编写如下dto类和接口：</p>
<p><strong>dto类<code>SeckillExposer</code>:</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> heavytiger</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 秒杀商品的详情页面获取服务器的时间，秒杀的相关状态及秒杀的请求地址</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/2/16 17:11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SeckillExposer</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 当前是否允许秒杀 true允许，false不允许</span></span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line">    <span class="comment">// 开始秒杀时间</span></span><br><span class="line">    <span class="keyword">private</span> Long start;</span><br><span class="line">    <span class="comment">// 秒杀结束时间</span></span><br><span class="line">    <span class="keyword">private</span> Long end;</span><br><span class="line">    <span class="comment">// 当前服务器时间</span></span><br><span class="line">    <span class="keyword">private</span> Long now;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>获取秒杀信息接口：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/getSeckillDetail/&#123;seckillId&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultBean&lt;Object&gt; <span class="title">getSeckillDetail</span><span class="params">(<span class="meta">@PathVariable</span> Integer seckillId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取当前的产品秒杀状态</span></span><br><span class="line">    <span class="comment">// 修改，因为可能被很多人请求，不应该请求数据库，防止业务崩溃，故将该数据缓存到redis中</span></span><br><span class="line">    SeckillProduct seckillProduct =</span><br><span class="line">            (SeckillProduct) redisTemplate.opsForValue().get(<span class="string">&quot;seckillProduct:&quot;</span> + seckillId);</span><br><span class="line">    SeckillExposer seckillExposer = <span class="keyword">new</span> SeckillExposer();</span><br><span class="line">    <span class="keyword">if</span> (seckillProduct == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 说明该商品无法被秒杀</span></span><br><span class="line">        seckillExposer.setStatus(<span class="number">2</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 获取当前服务器时间</span></span><br><span class="line">        seckillExposer.setNow(System.currentTimeMillis());</span><br><span class="line">        <span class="comment">// 获取秒杀商品开始时间</span></span><br><span class="line">        seckillExposer.setStart(seckillProduct.getStartDate().getTime());</span><br><span class="line">        <span class="comment">// 获取秒杀商品借书时间</span></span><br><span class="line">        seckillExposer.setEnd(seckillProduct.getEndDate().getTime());</span><br><span class="line">        <span class="keyword">if</span> (seckillExposer.getNow() &lt; seckillExposer.getStart()) &#123;</span><br><span class="line">            <span class="comment">// 表示秒杀未开始</span></span><br><span class="line">            seckillExposer.setStatus(<span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 表示秒杀开始</span></span><br><span class="line">            seckillExposer.setStatus(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ResultBean&lt;&gt;(EnumResult.SUCCESS, seckillExposer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实为了展示秒杀商品的剩余数量，可以给在秒杀商品表中设置预设库存和实际库存两个参数，我设计系统时没有考虑到，只在秒杀成功后减了商品表中的库存，加入此时服务器宕机，理论上没有办法恢复之前的状态，即订单已经生成，但是重启后又会读出预设库存作为可以秒杀的库存数，这样会造成数据不一致。</p>
<h4 id="获取秒杀地址"><a href="#获取秒杀地址" class="headerlink" title="获取秒杀地址"></a>获取秒杀地址</h4><p>为了避免提前暴露秒杀的接口，要求对地址API进行访问，在访问后如果一切正常（秒杀商品存在，用户的权限正常，商品仍有库存可以秒杀等），即可随机生成一段编码，将这段编码存储在Redis中，设置过期时间，在编码过期之前，可以将编码作为秒杀接口的请求体发送请求，若检测正常，即可以进行秒杀操作。</p>
<p><strong>获取秒杀地址的接口：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/getSeckillPath/&#123;seckillId&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultBean&lt;Object&gt; <span class="title">getSeckillPath</span><span class="params">(HttpServletRequest request, <span class="meta">@PathVariable</span> Integer seckillId)</span> </span>&#123;</span><br><span class="line">    Boolean seckillOver = seckillOverMap.get(<span class="string">&quot;seckillProduct:&quot;</span> + seckillId);</span><br><span class="line">    <span class="keyword">if</span>(seckillOver == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 迭代为先进行内存访问，用于提升QPS，避免不必要的Redis访问</span></span><br><span class="line">        <span class="comment">// 如果没有获取到值，直接返回不存在商品</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultBean&lt;&gt;(EnumResult.SECKILL_NO_PRODUCT);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (seckillOver) &#123;</span><br><span class="line">        <span class="comment">// 若售罄标记为真，表示已经售罄</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultBean&lt;&gt;(EnumResult.SECKILL_STOCK_EMPTY);</span><br><span class="line">    &#125;</span><br><span class="line">    String token = request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">    Integer userId = JwtUtil.getUserId(token);</span><br><span class="line">    <span class="comment">// 判断是否存在该商品的秒杀信息</span></span><br><span class="line">    SeckillProduct seckillProduct =</span><br><span class="line">            (SeckillProduct) redisTemplate.opsForValue().get(<span class="string">&quot;seckillProduct:&quot;</span> + seckillId);</span><br><span class="line">    <span class="keyword">if</span> (seckillProduct == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 说明该商品不存在</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultBean&lt;&gt;(EnumResult.SECKILL_NO_PRODUCT);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (System.currentTimeMillis() &lt; seckillProduct.getStartDate().getTime()) &#123;</span><br><span class="line">        <span class="comment">// 说明还没有到抢购时间，不允许进行抢购，不暴露秒杀地址</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultBean&lt;&gt;(EnumResult.SECKILL_NO_START);</span><br><span class="line">    &#125;</span><br><span class="line">    String path = seckillProductService.createPath(userId, seckillId);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ResultBean&lt;&gt;(EnumResult.SUCCESS, path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后来迭代时加入了秒杀商品售罄的标志，如果商品售罄，将直接返回售罄的信息，不会再进行相关业务的判断，这样可以提高该接口的QPS，同时前端也可以通过返回的售罄消息禁用用户的秒杀接口，降低秒杀接口的负载，实际测试后，QPS可以提高一倍。</p>
<p><strong>获取秒杀地址的接口的Service层代码：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">createPath</span><span class="params">(Integer userId, Integer seckillId)</span> </span>&#123;</span><br><span class="line">    String pathMD5 = UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="comment">// 设置30s内允许访问路径进行秒杀</span></span><br><span class="line">    redisTemplate.opsForValue().set(<span class="string">&quot;seckillPath:&quot;</span> + seckillId + <span class="string">&quot;:&quot;</span> + userId, pathMD5,</span><br><span class="line">            <span class="number">30</span>, TimeUnit.SECONDS);</span><br><span class="line">    <span class="keyword">return</span> pathMD5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>设置<code>30s</code>后键过期，保证<code>Redis</code>不至于内存开销过大。</p>
<h4 id="获取当前用户是否秒杀成功"><a href="#获取当前用户是否秒杀成功" class="headerlink" title="获取当前用户是否秒杀成功"></a>获取当前用户是否秒杀成功</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/getSeckillResult/&#123;seckillId&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultBean&lt;Object&gt; <span class="title">getSeckillResult</span><span class="params">(HttpServletRequest request, <span class="meta">@PathVariable</span> Integer seckillId)</span> </span>&#123;</span><br><span class="line">    String token = request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">    Integer userId = JwtUtil.getUserId(token);</span><br><span class="line">    <span class="comment">// 从Redis中查找当前的顾客是否存在记录</span></span><br><span class="line">    Boolean hasKey = redisTemplate.opsForSet().isMember(<span class="string">&quot;seckillOrder:&quot;</span> + seckillId, userId);</span><br><span class="line">    <span class="keyword">if</span> (hasKey != <span class="keyword">null</span> &amp;&amp; hasKey) &#123;</span><br><span class="line">        <span class="comment">// 表示存在当前用户的秒杀记录</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultBean&lt;&gt;(EnumResult.SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ResultBean&lt;&gt;(EnumResult.SECKILL_NO_ORDER);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实这个接口后来就没有使用过了，因为Redis中储存的秒杀用户记录都在消息队列接受到消息后被清空了，以避免重复创建订单的情况发生。</p>
<p>其实可以去掉这个API接口，使用<code>websocket</code>技术实现秒杀后的信息回传通知，这样可也提高用户体验，缺点是需要存放用户的<code>session</code>，会占用服务器资源，与我使用<code>jwt</code>的理念不相符。</p>
<h4 id="秒杀功能的实现"><a href="#秒杀功能的实现" class="headerlink" title="秒杀功能的实现"></a>秒杀功能的实现</h4><p>这个接口为重中之重，本来不应该在<code>controller</code>层实现<code>Service</code>层应该实现的内容，但是由于我偷懒没有去制定<code>controller</code>层和<code>Service</code>层之间的返回值规范，因此就直接在<code>controller</code>层中返回<code>ResultBean</code>封装对象了。</p>
<p><strong>Controller层的代码如下：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 秒杀业务.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request   获取userid</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> pathMD5   秒杀地址，防止接口提前暴露</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> seckillId 秒杀id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 返回秒杀状态</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/doSeckill/&#123;seckillId&#125;&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ResultBean&lt;Object&gt; <span class="title">doSeckill</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="meta">@RequestBody(required = false)</span> String pathMD5,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    <span class="meta">@PathVariable</span> Integer seckillId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 用于判断库存是否已经卖完</span></span><br><span class="line">    Boolean seckillOver = seckillOverMap.get(<span class="string">&quot;seckillProduct:&quot;</span> + seckillId);</span><br><span class="line">    <span class="keyword">if</span> (seckillOver == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 迭代为先进行内存访问，用于提升QPS，避免不必要的Redis访问</span></span><br><span class="line">        <span class="comment">// 如果没有获取到值，直接返回不存在商品</span></span><br><span class="line">        <span class="comment">// 迭代后，获取秒杀地址的QPS提升到1394，执行秒杀的QPS提升到1292</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultBean&lt;&gt;(EnumResult.SECKILL_NO_PRODUCT);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (seckillOver) &#123;</span><br><span class="line">        <span class="comment">// 若售罄标记为真，表示已经售罄</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultBean&lt;&gt;(EnumResult.SECKILL_STOCK_EMPTY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取userId</span></span><br><span class="line">    String token = request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line">    Integer userId = JwtUtil.getUserId(token);</span><br><span class="line">    <span class="comment">// 判断抢购地址是否一致</span></span><br><span class="line">    String pathInRedis = (String) redisTemplate.opsForValue().get(<span class="string">&quot;seckillPath:&quot;</span> + seckillId + <span class="string">&quot;:&quot;</span> + userId);</span><br><span class="line">    <span class="keyword">if</span> (!pathMD5.equals(pathInRedis)) &#123;</span><br><span class="line">        <span class="comment">// 说明抢购的地址不一致，不允许继续抢购</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultBean&lt;&gt;(EnumResult.SECKILL_PATH_ERROR);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 判断是否重复抢购</span></span><br><span class="line">    Boolean hasKey = redisTemplate.opsForSet().isMember(<span class="string">&quot;seckillOrder:&quot;</span> + seckillId, userId);</span><br><span class="line">    <span class="keyword">if</span> (hasKey != <span class="keyword">null</span> &amp;&amp; hasKey) &#123;</span><br><span class="line">        <span class="comment">// 说明该用户存在重复秒杀</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultBean&lt;&gt;(EnumResult.SECKILL_ORDER_REPEAT);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 使用lua脚本进行减库存以及存入订单的操作，必须使用Long，Integer会产生报错</span></span><br><span class="line">    Long execute = redisTemplate.execute(seckillScript, Collections.emptyList(), userId, seckillId);</span><br><span class="line">    <span class="keyword">if</span> (execute == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 避免提示空指针</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultBean&lt;&gt;(EnumResult.INTERNAL_SERVER_ERROR);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (execute == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// 说明此时库存为空</span></span><br><span class="line">        <span class="comment">// 此时测试秒杀服务的QPS为740，获取MD5秒杀路径的QPS为686</span></span><br><span class="line">        <span class="comment">// 之后可以再次改进，在内存中设置库存清零标记，当标记后，访问秒杀及路径接口直接返回库存为空，可以提高QPS</span></span><br><span class="line">        seckillOverMap.replace(<span class="string">&quot;seckillProduct:&quot;</span> + seckillId, Boolean.TRUE);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultBean&lt;&gt;(EnumResult.SECKILL_STOCK_EMPTY);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (execute == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// 说明此时秒杀成功，使用消息队列异步下订单</span></span><br><span class="line">        mqSender.sendSeckillMessage(userId, seckillId);</span><br><span class="line">        <span class="comment">// System.out.println(userId + &quot;：创建订单成功！&quot;);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultBean&lt;&gt;(EnumResult.SUCCESS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 说明已经秒杀成功，提示禁止重复秒杀</span></span><br><span class="line">        <span class="comment">// System.out.println(&quot;禁止重复秒杀！&quot;);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResultBean&lt;&gt;(EnumResult.SECKILL_ORDER_REPEAT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>已经在其中写了比较详尽的注释，就不再解释了，<code>Redis</code>预减库存需要使操作具有原子性，因此我使用了<code>Redis</code>支持的<code>lua</code>脚本的方式，<code>lua</code>脚本在使用时会阻塞别的线程访问<code>Redis</code>，因此不会出现并发的各种问题。</p>
<p><strong>lua脚本如下所示：</strong></p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> userId = ARGV[<span class="number">1</span>];</span><br><span class="line"><span class="keyword">local</span> seckillId = ARGV[<span class="number">2</span>];</span><br><span class="line"><span class="keyword">local</span> stockKey = <span class="string">&quot;seckillStock:&quot;</span> .. seckillId;</span><br><span class="line"><span class="keyword">local</span> usersKey = <span class="string">&quot;seckillOrder:&quot;</span> .. seckillId;</span><br><span class="line"><span class="keyword">local</span> userExists = redis.call(<span class="string">&quot;sIsMember&quot;</span>, usersKey, userId);</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">tonumber</span>(userExists) == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">local</span> num = redis.call(<span class="string">&quot;get&quot;</span>, stockKey);</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">tonumber</span>(num) &lt;= <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    redis.call(<span class="string">&quot;decr&quot;</span>, stockKey);</span><br><span class="line">    redis.call(<span class="string">&quot;sAdd&quot;</span>, usersKey, userId);</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<h3 id="消息队列处理订单业务"><a href="#消息队列处理订单业务" class="headerlink" title="消息队列处理订单业务"></a>消息队列处理订单业务</h3><p>我使用了<code>RabbitMQ</code>的<code>topic</code>模式实现消息队列，原因是因为该模式用处比较广，如果之后还要添加其他的模块，也可以方便地进行添加，使用通配符匹配即可。</p>
<p>在<code>SeckillController</code>的<code>doSeckill</code>业务执行预减库存操作时，如果<code>lua</code>脚本的返回值表示秒杀成功，则会向生产者<code>RabbitMQ</code>发送使用哈希表封装的消息，<code>Exchange</code>接受到消息后，则会根据<code>topic</code>模式定义的规则发送给相应的队列，这些队列再将消息发送给消费者进行处理，生成订单。</p>
<p><strong>首先定义Bean，进行<code>QUEUE</code>和<code>EXCHANGE</code>的绑定</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> heavytiger</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> RabbitMQ配置类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/2/21 20:10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitMQConfig</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 配置队列名，使用Topic模式</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String QUEUE = <span class="string">&quot;seckillQueue&quot;</span>;</span><br><span class="line">    <span class="comment">// 配置交换器名</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EXCHANGE = <span class="string">&quot;seckillExchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Queue <span class="title">queue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Queue(QUEUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TopicExchange <span class="title">topicExchange</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> TopicExchange(EXCHANGE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Binding <span class="title">binding</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 匹配路径为seckill.#的队列</span></span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue()).to(topicExchange()).with(<span class="string">&quot;seckill.#&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>生产者代码如下所示：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> heavytiger</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 发送消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/2/21 20:30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MQSender</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发送消息</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendSeckillMessage</span><span class="params">(Integer userId, Integer seckillId)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, Integer&gt; message = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        message.put(<span class="string">&quot;userId&quot;</span>, userId);</span><br><span class="line">        message.put(<span class="string">&quot;seckillId&quot;</span>, seckillId);</span><br><span class="line">        rabbitTemplate.convertAndSend(RabbitMQConfig.EXCHANGE, <span class="string">&quot;seckill.message&quot;</span>, JsonUtil.objToJson(message));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>消费者的代码如下所示：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> heavytiger</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> 1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span> 接收消息</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022/2/21 20:30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MQReceiver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger logger = LoggerFactory.getLogger(MQReceiver.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SeckillOrderService seckillOrderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RedisTemplate&lt;String, Object&gt; redisTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RabbitListener(queues = RabbitMQConfig.QUEUE)</span></span><br><span class="line">    <span class="meta">@Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">receiveSeckillMessage</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        HashMap&lt;String, Integer&gt; map = JsonUtil.jsonToObj(message, HashMap.class);</span><br><span class="line">        Integer userId = map.get(<span class="string">&quot;userId&quot;</span>);</span><br><span class="line">        Integer seckillId = map.get(<span class="string">&quot;seckillId&quot;</span>);</span><br><span class="line">        <span class="comment">// 将秒杀成功的订单与Redis中的记录进行比较，如果存在说明该记录正确，并将Redis中的订单数据删除</span></span><br><span class="line">        Long result = redisTemplate.opsForSet().remove(<span class="string">&quot;seckillOrder:&quot;</span> + seckillId, userId);</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 说明此时集合不存在，其中的元素已经全被删除</span></span><br><span class="line">            logger.info(<span class="string">&quot;Redis中秒杀商品&#123;&#125;的订单集合已被全部删除！&quot;</span>, seckillId);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Redis中&quot;</span> + seckillId + <span class="string">&quot;商品的订单集合已被全部删除！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (result == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 说明只删除了一个，进行记录</span></span><br><span class="line">            logger.info(<span class="string">&quot;用户&#123;&#125;秒杀商品&#123;&#125;成功!&quot;</span>, userId, seckillId);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 说明没有删除，没有删除则证明订单已经被创建了，直接返回以免出现重复消费的情况</span></span><br><span class="line">            logger.warn(<span class="string">&quot;用户&#123;&#125;已经秒杀商品&#123;&#125;！请勿重复创建订单！&quot;</span>, userId, seckillId);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 添加秒杀订单，此操作会先将商品加入购物车，再将购物车中的商品结算，结算完成后生成订单，再将订单数据回填到秒杀订单中</span></span><br><span class="line">        <span class="keyword">if</span>(seckillOrderService.addSeckillOrder(seckillId, userId) == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 说明订单创建成功</span></span><br><span class="line">            logger.info(<span class="string">&quot;用户&#123;&#125;秒杀商品&#123;&#125;号的订单被成功创建!&quot;</span>, userId, seckillId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>消费者和之前描述的设计思路一致，使用<code>Redis</code>中键名为<code>&quot;seckillOrder:&quot; + seckillId</code>集合的<code>value</code>标记秒杀成功的用户，如果能正常地删除数据，则说明是第一次生成订单，可以正常生成。</p>
<p>之后调用<code>SeckillOrderServiceImpl</code>中的<code>addSeckillOrder</code>方法，添加秒杀订单，<strong>注意此处出现了一个比较严重的bug，严重影响程序运行效率</strong>，此处我使用了注解式事务，以确保<code>ACID</code>，但是出现了死锁的问题，之后我会在第六章进行解释。</p>
<p><strong><code>addSeckillOrder</code>代码如下所示：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加秒杀订单</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> userId 用户的id</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> seckillId 需要添加的秒杀订单</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 返回影响的行数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Integer <span class="title">addSeckillOrder</span><span class="params">(Integer seckillId, Integer userId)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 1. 首先需要将商品添加到购物车中</span></span><br><span class="line">    <span class="comment">// 获取Redis中存储的商品的秒杀价格</span></span><br><span class="line">    SeckillProduct seckillProduct =</span><br><span class="line">            (SeckillProduct) redisTemplate.opsForValue().get(<span class="string">&quot;seckillProduct:&quot;</span> + seckillId);</span><br><span class="line">    <span class="keyword">if</span>(seckillProduct == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Redis中不存在相关商品!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    OrderCart tempOrderCart = <span class="keyword">new</span> OrderCart(<span class="keyword">null</span>, userId,</span><br><span class="line">            seckillProduct.getProductId(), <span class="number">1</span>, seckillProduct.getSeckillPrice(), <span class="number">1</span>,</span><br><span class="line">            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    orderCartService.addOrderCart(tempOrderCart);</span><br><span class="line">    <span class="comment">// 2. 将购物车中的商品进行结算</span></span><br><span class="line">    Order tempOrder =  <span class="keyword">new</span> Order(<span class="keyword">null</span>, <span class="keyword">null</span>, userId, <span class="keyword">null</span>,</span><br><span class="line">            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    orderService.addOrder(tempOrder);</span><br><span class="line">    <span class="comment">// 3. 将数据回写到秒杀订单表</span></span><br><span class="line">    SeckillOrder seckillOrder = <span class="keyword">new</span> SeckillOrder(<span class="keyword">null</span>, userId, tempOrder.getOrderId(),</span><br><span class="line">            seckillProduct.getProductId());</span><br><span class="line">    seckillOrder.setOrderId(tempOrder.getOrderId());</span><br><span class="line">    <span class="keyword">return</span> seckillOrderMapper.addSeckillOrder(seckillOrder);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于这是我之前学习<code>SSM</code>框架时自己写的系统，可能数据库的设计不是那么好，我处理订单的逻辑是：</p>
<ol>
<li>将用户选择的商品添加到购物车(即，将商品的id、价格、数量、用户的信息等作为一条记录加入到数据库<code>order_cart</code>表中)</li>
<li>对该用户的购物车中的所有物品进行结算，结算之后生成订单，之后将订单的id回填至购物车表中，之后即可查看该用户的某一次订单的具体内容。(实际上也存在设计不合理的地方，譬如用户在进行秒杀结算时只想结算秒杀的商品，购物车中的其他商品用户不一定考虑结算，不过毕竟系统设计时就没有考虑做成很大型的平台，只作为学习练手使用)</li>
<li>之后将订单表的数据(id)获取后，填入秒杀订单表，生成秒杀订单</li>
</ol>
<p>之中的所有操作，都用了<code>read_committed</code>的隔离级别以及<code>required</code>的传播级别，这也导致了之后的<code>bug</code>，详见之后的说明</p>
<p><strong>添加购物车<code>addOrderCart</code>的业务代码：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加购物车</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> orderCart 封装添加购物车</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> 返回影响的行数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRES_NEW)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Integer <span class="title">addOrderCart</span><span class="params">(OrderCart orderCart)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (customerMapper.queryCustomerById(orderCart.getCustomerId()) != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">        productMapper.queryProductById(orderCart.getProductId()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// 默认加入购物车时标识为1，即下单时购买该商品</span></span><br><span class="line">        orderCart.setStatus(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> orderCartMapper.addOrderCart(orderCart);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意思考这里的传播级别为什么是<code>Propagation.REQUIRES_NEW</code>，之前不是才说了全设置的<code>REQUIRED</code>吗？</strong></p>
<p><strong>添加订单<code>addOrder</code>的业务代码：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加订单，若需要回滚会抛出运行时异常，需要在Controller层捕获运行时异常</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> order 需要增加的订单</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addOrder</span><span class="params">(Order order)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 开启事务支持，隔离级别可重复读，若被调用方法中存在事务则加入事务，否则创建新事务</span></span><br><span class="line">    <span class="comment">// 生成订单SN码</span></span><br><span class="line">    order.setOrderSn(UUID.randomUUID().toString().replace(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>));</span><br><span class="line">    <span class="comment">// 查询当前用户购物车内的所有未购买商品</span></span><br><span class="line">    List&lt;OrderCart&gt; orderCartList = orderCartMapper.queryNewOrderCartsByCustomerId(order.getCustomerId());</span><br><span class="line">    <span class="keyword">if</span> (orderCartList == <span class="keyword">null</span> || orderCartList.isEmpty()) &#123;</span><br><span class="line">        <span class="comment">// 抛出异常，@Transactional捕获异常后自动回滚，Controller层需要捕获异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;购物车中没有商品！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 计算总金额</span></span><br><span class="line">    <span class="keyword">double</span> orderTotalMoney = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (OrderCart item : orderCartList) &#123;</span><br><span class="line">        Double curPrice = item.getProductPrice();</span><br><span class="line">        Integer curAmount = item.getProductAmount();</span><br><span class="line">        orderTotalMoney += (curPrice == <span class="keyword">null</span> || curAmount == <span class="keyword">null</span>) ? <span class="number">0</span> : curPrice * curAmount;</span><br><span class="line">    &#125;</span><br><span class="line">    order.setOrderMoney(orderTotalMoney);</span><br><span class="line">    <span class="comment">// 新建一条订单，该方法将回填主键(即orderId)</span></span><br><span class="line">    orderMapper.addOrder(order);</span><br><span class="line">    Integer curOrderId = order.getOrderId();</span><br><span class="line">    <span class="comment">// 更新order_carts购物车表</span></span><br><span class="line">    <span class="keyword">for</span> (OrderCart item : orderCartList) &#123;</span><br><span class="line">        <span class="comment">// 将购物车表中的status状态标记为0，即已经生成订单，状态为删除</span></span><br><span class="line">        item.setStatus(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// 将库存中的数量进行更改，若数量过多，则直接抛出运行时异常</span></span><br><span class="line">        Product curProduct = productMapper.queryProductDetailForUpdate(item.getProductId());</span><br><span class="line">        <span class="comment">// System.out.println(curProduct);</span></span><br><span class="line">        Integer curStock = curProduct.getStock();</span><br><span class="line">        Integer curAmount = item.getProductAmount() == <span class="keyword">null</span> ? <span class="number">0</span> : item.getProductAmount();</span><br><span class="line">        <span class="keyword">if</span> (curStock &lt; curAmount) &#123;</span><br><span class="line">            <span class="comment">// 抛出异常，@Transactional捕获异常后自动回滚，Controller层需要捕获异常</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;库存数量不够，请检查购物车中添加的商品数量！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            item.setOrderId(curOrderId);</span><br><span class="line">            <span class="comment">// 回写购物车内的OrderId数据</span></span><br><span class="line">            orderCartMapper.updateOrderCart(item);</span><br><span class="line">            <span class="comment">// 更新产品中的库存stock</span></span><br><span class="line">            curProduct.setStock(curStock - curAmount);</span><br><span class="line">            productMapper.updateProduct(curProduct);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>业务比较复杂，不再过多阐述实现的思路了，代码中的注释很齐全</p>
<p>这里有个并发减商品库存的操作，我使用悲观锁实现<code>SELECT FOR UPDATE</code>语句加<code>X lock</code>，保证了并发减库存不至于库存与订单数量对不上</p>
<p>最后添加秒杀订单的代码省略，因为是<code>Mapper</code>层的方法，很简单。</p>
<h2 id="秒杀相关接口压力测试"><a href="#秒杀相关接口压力测试" class="headerlink" title="秒杀相关接口压力测试"></a>秒杀相关接口压力测试</h2><h3 id="简易接口测试"><a href="#简易接口测试" class="headerlink" title="简易接口测试"></a>简易接口测试</h3><p>使用<code>ApiFox</code>对接口进行简易的测试，主要用于测试接口功能是否正常，大致截图如下，可以参考以下文章将接口A返回值用于接口B参数：</p>
<p><a target="_blank" rel="noopener" href="https://www.apifox.cn/help/app/best-practices/api-relations/">接口之间如何传递数据 | Apifox 使用文档</a></p>
<p><a target="_blank" rel="noopener" href="https://www.apifox.cn/help/app/best-practices/auth/">登录态（Auth）如何处理 | Apifox 使用文档</a></p>
<p>测试秒杀的流程是否正常：</p>
<blockquote>
<p>秒杀的流程如下：</p>
<ol>
<li>登录账户，获得自己的<code>Token</code>，之后每次访问接口都需要在<code>Authorization</code>中附上<code>Token</code>值鉴权</li>
<li>获得秒杀物品的秒杀信息</li>
<li>获得秒杀物品的秒杀地址，之后通过秒杀地址参与秒杀</li>
<li>发送秒杀的请求，调用秒杀<code>API</code></li>
</ol>
</blockquote>
<p>因此，使用ApiFox对这些流程进行简易的测试，验证接口是否正常</p>
<p>获取秒杀信息的接口：</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227164150457.png" alt="image-20220227164150457"></p>
<p>获取秒杀地址的接口：</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227164215253.png" alt="image-20220227164215253"></p>
<p>执行秒杀操作的接口：</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227164240828.png" alt="image-20220227164240828"></p>
<p>创建完成后，创建自动化测试：</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227164342405.png" alt="image-20220227164342405"></p>
<p>将其中下一操作所需的信息设置为环境变量，方便获取值进行接下来的测试，如下所示：</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227164453186.png" alt="image-20220227164453186"></p>
<p>之后将其集成为秒杀套件，进行联合测试：</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227164624889.png" alt="image-20220227164624889"></p>
<p>举例说明，接口测试后，可以看到执行的结果：</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227164742233.png" alt="image-20220227164742233"></p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227164829449.png" alt="image-20220227164829449"></p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227164841464.png" alt="image-20220227164841464"></p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227164918514.png" alt="image-20220227164918514"></p>
<h3 id="JMeter进行压力测试"><a href="#JMeter进行压力测试" class="headerlink" title="JMeter进行压力测试"></a>JMeter进行压力测试</h3><p>由于本项目使用<code>JWT</code>鉴权，因此直接使用测试类注册<code>10000</code>个帐号，供测试使用，将这些帐号密码调用接口生成<code>Token</code>存储到<code>user_tokens.txt</code>文件中，之后进行测试时，使用该文件验证身份</p>
<p><strong>测试代码：</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 添加10000个秒杀用户，用于测试秒杀效果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addSeckillCustomer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">        Customer temp = <span class="keyword">new</span> Customer(<span class="keyword">null</span>, <span class="string">&quot;seckill&quot;</span> + i, <span class="string">&quot;123456&quot;</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                <span class="keyword">null</span>, <span class="string">&quot;秒杀模块测试用户&quot;</span> + i);</span><br><span class="line">        customerService.addCustomer(temp);</span><br><span class="line">        System.out.println(<span class="string">&quot;插入的customer主键id为：&quot;</span> + temp.getUserId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 登录秒杀测试用户并获得用户的token</span></span><br><span class="line"><span class="comment"> * 将测试的10000个用户的token值放入txt文件中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createTokens</span><span class="params">()</span></span>&#123;</span><br><span class="line">    File file = <span class="keyword">new</span> File(<span class="string">&quot;C:\\Users\\DCM\\Desktop\\user_tokens.txt&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(file.exists()) &#123;</span><br><span class="line">        <span class="comment">// 如果文件存在则直接删除</span></span><br><span class="line">        file.delete();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span>(FileWriter fileWriter = <span class="keyword">new</span> FileWriter(file)) &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; i++) &#123;</span><br><span class="line">            Customer customer = customerService.customerLogin(<span class="string">&quot;seckill&quot;</span> + i, <span class="string">&quot;123456&quot;</span>);</span><br><span class="line">            String token = JwtUtil.sign(customer.getUserId(), customer.getUsername());</span><br><span class="line">            fileWriter.write(token + <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            fileWriter.flush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创建的包含<code>Token</code>信息的文件：</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227165453713.png" alt="image-20220227165453713"></p>
<p><strong>秒杀测试套件的创建：</strong></p>
<p>由于直接生成了<code>token</code>，可以直接使用，就不需要再调用登录接口了</p>
<p>设置用户登录信息的<code>csv</code>数据文件，选择文件所在的位置，以及提取为什么变量名，此时我将变量名设置为<code>token</code>，之后可以使用<code>$&#123;token&#125;</code>进行变量的调用</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227223105990.png" alt="image-20220227223105990"></p>
<p>秒杀的商品设置为全局变量存储，方便进行修改</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227223405920.png" alt="image-20220227223405920"></p>
<p>创建信息头管理器，在<code>Authorization</code>中使用<code>$&#123;token&#125;</code>获取<code>token</code>值并附在<code>header</code>中一并发送，用于鉴权</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220227223321782.png" alt="image-20220227223321782"></p>
<p>之后使用<code>JSON提取器</code>获取返回值<code>json</code>中的<code>MD5秒杀地址</code>，获取地址后，将其添加到秒杀商品操作的请求体中，即可完成请求</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302090027111.png" alt="image-20220302090027111"></p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302090051415.png" alt="image-20220302090051415"></p>
<h4 id="压力测试一："><a href="#压力测试一：" class="headerlink" title="压力测试一："></a>压力测试一：</h4><p>对秒杀编号3的50个商品进行测试，测试使用<code>2000</code>个线程，在<code>1s</code>内发起请求，<code>一共循环5次</code>，测试出系统的QPS</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302090551454.png" alt="image-20220302090551454"></p>
<p><strong>测试结果如下：</strong></p>
<p><strong>可以看到此时秒杀操作的<code>QPS</code>为<code>1514</code>，比较合理</strong></p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302093227630.png" alt="image-20220302093227630"></p>
<p><strong>检查数据库的结果：</strong></p>
<p>此时Redis中的数据正常，50个商品全部被秒杀完成</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302093437091.png" alt="image-20220302093437091"></p>
<p>数据库中的库存原来是500，在秒杀操作完成后，减库存至450</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302093727229.png" alt="image-20220302093727229"></p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302093816365.png" alt="image-20220302093816365"></p>
<p>查看购物车表、订单表、秒杀订单表中的详情：</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302093927977.png" alt="image-20220302093927977"></p>
<p>可以看到，有50行被选中，证明有50个顾客秒杀了商品</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302094053172.png" alt="image-20220302094053172"></p>
<p>有50行被选中，说明共生成了50条订单，正确</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302094241264.png" alt="image-20220302094241264"></p>
<p>此时秒杀商品表中有50条记录，且order_id，customer_id，均与订单表购物车表中的信息一致，正确</p>
<p>且此时的order_id生成是连续的，说明没有产生回滚(由于之前提到的产生死锁的操作，会导致出现很多回滚，虽然id是自增的，id每次却跨越5-6增加，说明基本5-6次回滚才成功插入一行数据，效率极低，QPS也特别低)</p>
<h4 id="压力测试二"><a href="#压力测试二" class="headerlink" title="压力测试二"></a>压力测试二</h4><p>秒杀商品5，一共100件，测试使用3000线程在1s发起请求，共请求4次，实际测得的秒杀接口的QPS在1484左右</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302110659354.png" alt="image-20220302110659354"></p>
<h4 id="压力测试三"><a href="#压力测试三" class="headerlink" title="压力测试三"></a>压力测试三</h4><p>秒杀商品6，一共10件，测试使用4000线程在1s发起请求，共请求3次，实际测得的秒杀接口的QPS在1364左右</p>
<p><img src="mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/image-20220302112214600.png" alt="image-20220302112214600"></p>
<p>测试二和测试三就不演示数据库中的内容了，可以和旁边的异常率对照，加了过滤器，只把秒杀成功的视作正常</p>
<h2 id="记录出现的问题"><a href="#记录出现的问题" class="headerlink" title="记录出现的问题"></a>记录出现的问题</h2><h3 id="使用SELECT-FOR-UPDATE时出现死锁"><a href="#使用SELECT-FOR-UPDATE时出现死锁" class="headerlink" title="使用SELECT FOR UPDATE时出现死锁"></a>使用<code>SELECT FOR UPDATE</code>时出现死锁</h3><p>为了解决mysql中，商品表的库存在并发减的情况下会出现覆盖提交的问题，如果使用乐观锁会增加重试的成本，并且需要手写重试的代码，因此考虑使用悲观锁解决问题，使用<code>SELECT FOR UPDATE</code>实现悲观锁，但是在并发的情况下出现了大量的死锁情况，甚至每一个事务都要回滚五六次才能成功的修改数据，因此我尝试解决该问题</p>
<p>使用sql语句，打开死锁日志，可以记录最后一次发生的死锁：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">GLOBAL</span> innodb_print_all_deadlocks<span class="operator">=</span><span class="keyword">ON</span>;</span><br><span class="line"># 查询innodb日志</span><br><span class="line"><span class="keyword">show</span> engine innodb status;</span><br></pre></td></tr></table></figure>

<p>日志相关情况（仅截取了死锁部分的日志）：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">------------------------</span><br><span class="line">LATEST DETECTED DEADLOCK</span><br><span class="line">------------------------</span><br><span class="line">2022-02-22 21:12:03 139829317871360</span><br><span class="line">*** (1) TRANSACTION:</span><br><span class="line">TRANSACTION 29602, ACTIVE 0 sec starting index read</span><br><span class="line">mysql tables in use 3, locked 3</span><br><span class="line">LOCK WAIT 8 lock struct(s), heap size 1128, 3 row lock(s), undo log entries 2</span><br><span class="line">MySQL thread id 26, OS thread handle 139828862592768, query id 14275 192.168.205.1 mall statistics</span><br><span class="line">SELECT *</span><br><span class="line">        FROM mall.product_detail</span><br><span class="line">        WHERE product_id = 2</span><br><span class="line">        FOR UPDATE</span><br><span class="line"></span><br><span class="line">*** (1) HOLDS THE LOCK(S):</span><br><span class="line">RECORD LOCKS space id 90 page no 4 n bits 88 index PRIMARY of table `mall`.`products` trx id 29602 lock mode S locks rec but not gap</span><br><span class="line"></span><br><span class="line">*** (1) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 90 page no 4 n bits 88 index PRIMARY of table `mall`.`products` trx id 29602 lock_mode X locks rec but not gap waiting</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">*** (2) TRANSACTION:</span><br><span class="line">TRANSACTION 29603, ACTIVE 0 sec starting index read</span><br><span class="line">mysql tables in use 3, locked 3</span><br><span class="line">LOCK WAIT 8 lock struct(s), heap size 1128, 3 row lock(s), undo log entries 2</span><br><span class="line">MySQL thread id 23, OS thread handle 139828865763072, query id 14278 192.168.205.1 mall statistics</span><br><span class="line">SELECT *</span><br><span class="line">        FROM mall.product_detail</span><br><span class="line">        WHERE product_id = 2</span><br><span class="line">        FOR UPDATE</span><br><span class="line"></span><br><span class="line">*** (2) HOLDS THE LOCK(S):</span><br><span class="line">RECORD LOCKS space id 90 page no 4 n bits 88 index PRIMARY of table `mall`.`products` trx id 29603 lock mode S locks rec but not gap</span><br><span class="line"></span><br><span class="line">*** (2) WAITING FOR THIS LOCK TO BE GRANTED:</span><br><span class="line">RECORD LOCKS space id 90 page no 4 n bits 88 index PRIMARY of table `mall`.`products` trx id 29603 lock_mode X locks rec but not gap waiting</span><br><span class="line"></span><br><span class="line">*** WE ROLL BACK TRANSACTION (2)</span><br></pre></td></tr></table></figure>

<p><strong>查看死锁日志：</strong></p>
<p><code>TRANSACTION</code>表示两个事务，分别为<code>(1)</code> 和 <code>(2)</code>，简单的英文翻译，可以知道出现死锁的原因是，有两个事务都已经持有<code>mall.products</code>数据库的<code>s锁</code>，s锁是共享锁，允许当前持有该锁的事务读取行，如果事务<code>(1)</code>持有<code>s锁</code>其他的事务也可以对改行上<code>s锁</code>，但是使用<code>SELECT FOR UPDATE</code>语句时，当准确命中索引的时候(即此时使用主键进行索引查找，加行级排他锁)，会锁行，对该行加<code>x锁</code>，即：</p>
<ul>
<li><p>如果事务<code>(1)</code>持有了行上的<code>s锁</code>，则其他任何事务也可以持有该行的<code>s锁</code>，但是想加<code>x锁</code>必须等其他事务的<code>S锁</code>释放。</p>
</li>
<li><p>如果事务<code>(1)</code>持有了行上的<code>X锁</code>，则其他任何事务不能持有该行的<code>X锁</code>，必须等待<code>(1)</code>在该行上的<code>X锁</code>释放。</p>
</li>
</ul>
<p>因此，此时两个事务都持有了<code>S锁</code>，但是同时又都在尝试<code>X锁</code>，互相不释放<code>S锁</code>，导致了死锁的产生，<code>MySQL</code>检测到后就自动回滚了。</p>
<p><strong>解决方案：</strong></p>
<p>查看之前在什么地方使用了<code>SELECT</code>语句导致上了<code>S锁</code>，经过检查，是在添加购物车时，使用了<code>SELECT</code>语句查询商品保证商品不为空，此时如果要修改该行的<code>Stock</code>库存，则需要再加上<code>X锁</code>，并发下多事务会导致死锁。</p>
<p>我将事务的传播级别由<code>REQUIRED</code>修改为了<code>REQUIRED_NEW</code>，自己新建立一个事务即可，这样可以保证两个操作不使用同一个事务，这样就不会出现死锁的情况，解决了出现的问题。</p>
<h3 id="docker中时间与服务器时间不一致的问题"><a href="#docker中时间与服务器时间不一致的问题" class="headerlink" title="docker中时间与服务器时间不一致的问题"></a>docker中时间与服务器时间不一致的问题</h3><p>部署在docker中的服务器时间与服务器外的时间不一致，解决方案如下:</p>
<p>首先同步服务器的时间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 安装ntp服务</span></span><br><span class="line">yum install -y ntp</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改配置</span></span><br><span class="line">vi /etc/ntp.conf</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改如下，截选部分</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Permit all access over the loopback interface.  This could</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> be tightened as well, but to <span class="keyword">do</span> so would effect some of</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> the administrative <span class="built_in">functions</span>.</span></span><br><span class="line">restrict 127.0.0.1</span><br><span class="line">restrict ::1</span><br><span class="line"><span class="meta">#</span><span class="bash"> Hosts on <span class="built_in">local</span> network are less restricted.</span></span><br><span class="line">restrict 192.168.205.0 mask 255.255.255.0 nomodify notrap</span><br><span class="line">restrict 192.168.1.0 mask 255.255.255.0 nomodify notrap</span><br><span class="line">restrict 192.168.0.0 mask 255.255.0.0 nomodify notrap</span><br><span class="line">restrict cn.pool.ntp.org</span><br><span class="line"><span class="meta">#</span><span class="bash"> Use public servers from the pool.ntp.org project.</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Please consider joining the pool (http://www.pool.ntp.org/join.html).</span></span><br><span class="line">server cn.pool.ntp.org prefer   # 以这台主机为优先</span><br><span class="line">server ntp.sjtu.edu.cn</span><br><span class="line">server 0.centos.pool.ntp.org iburst</span><br><span class="line">server 1.centos.pool.ntp.org iburst</span><br><span class="line">server 2.centos.pool.ntp.org iburst</span><br><span class="line">server 3.centos.pool.ntp.org iburst</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动服务</span></span><br><span class="line">[root@localhost ~]# ntpdate cn.pool.ntp.org</span><br><span class="line"> 2 Mar 13:53:11 ntpdate[103109]: step time server 84.16.67.12 offset 468657.069197 sec</span><br><span class="line">[root@localhost ~]# date</span><br><span class="line">2022年 03月 02日 星期三 13:53:14 CST</span><br></pre></td></tr></table></figure>

<p>之后同步虚拟机中的时间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 方法1：启动时添加时间参数</span></span><br><span class="line">docker run -p 3306:3306 --name mysql -v /etc/localtime:/etc/localtime</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 方法2：直接在宿主机操作</span></span><br><span class="line">docker cp /etc/localtime 【容器ID或者NAME】:/etc/localtime</span><br><span class="line">docker cp -L /usr/share/zoneinfo/Asia/Shanghai 【容器ID或者NAME】:/etc/localtime</span><br></pre></td></tr></table></figure>

<p>修改之后，即可正常同步时间</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# docker exec -it mysql /bin/bash</span><br><span class="line">root@757d2d305710:/# date</span><br><span class="line">Wed Mar  2 13:57:52 +08 2022</span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><blockquote>
<p>[1] <a href="https://heavytiger.github.io/articles/SSM%E6%95%B4%E5%90%88%E5%BC%80%E5%8F%91/#more">SSM整合开发 | HeavyTiger’s Blogs</a></p>
</blockquote>

    </div>

    
    
    

    <div>
    
        <div>
    
        <hr>
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文到此结束 <i class="fas fa-book-open"></i> 感谢您的阅读-------------</div>
    
</div>
    
    </div>
        <div class="reward-container">
  <div>谢谢你请我喝肥宅快乐水(๑＞ڡ＜) ☆☆☆</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatimg.jpg" alt="喵式重战 微信支付">
        <p>微信支付</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipayimg.jpg" alt="喵式重战 支付宝">
        <p>支付宝</p>
      </div>

  </div>
</div>

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>喵式重战
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://heavytiger.github.io/articles/mall-SpringBoot%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/" title="mall_SpringBoot项目开发总结">https://heavytiger.github.io/articles/mall-SpringBoot项目开发总结/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/articles/%E5%96%B5%E5%96%B5%E5%95%86%E5%9F%8E%E9%A1%B9%E7%9B%AE-%E5%89%8D%E7%AB%AF%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/" rel="prev" title="喵喵商城项目_前端基础学习">
      <i class="fa fa-chevron-left"></i> 喵喵商城项目_前端基础学习
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#SSM%E9%A1%B9%E7%9B%AE%E8%BD%AC%E4%B8%BASpringBoot%E9%A1%B9%E7%9B%AE"><span class="nav-number">1.</span> <span class="nav-text">SSM项目转为SpringBoot项目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AElog4j2%E5%AE%9E%E7%8E%B0%E6%97%A5%E5%BF%97%E6%A8%A1%E5%9D%97"><span class="nav-number">1.1.</span> <span class="nav-text">配置log4j2实现日志模块</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E6%BA%90%E3%80%81%E8%BF%9E%E6%8E%A5%E6%B1%A0%E3%80%81MyBatis"><span class="nav-number">1.2.</span> <span class="nav-text">配置数据源、连接池、MyBatis</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E9%89%B4%E6%9D%83%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="nav-number">1.3.</span> <span class="nav-text">配置鉴权拦截器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AERedis%E9%9B%86%E7%BE%A4"><span class="nav-number">1.4.</span> <span class="nav-text">配置Redis集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BF%AE%E6%94%B9-%E5%B0%86%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E5%88%B0%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%9A%84docker%E4%B8%AD"><span class="nav-number">1.5.</span> <span class="nav-text">[修改]将集群部署到虚拟机的docker中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Docker%E4%B8%AD%E9%83%A8%E7%BD%B2RabbitMQ"><span class="nav-number">1.6.</span> <span class="nav-text">Docker中部署RabbitMQ</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A7%92%E6%9D%80%E6%A8%A1%E5%9D%97%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">2.</span> <span class="nav-text">秒杀模块的实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E8%A1%A8%E7%9A%84%E8%AE%BE%E8%AE%A1"><span class="nav-number">2.1.</span> <span class="nav-text">数据库表的设计</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E5%86%99pojo%E5%92%8Cmapper%E5%B1%82"><span class="nav-number">2.2.</span> <span class="nav-text">编写pojo和mapper层</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%96%E5%86%99Service%E5%B1%82"><span class="nav-number">2.3.</span> <span class="nav-text">编写Service层</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A7%92%E6%9D%80%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%80%9D%E8%B7%AF"><span class="nav-number">3.</span> <span class="nav-text">秒杀模块实现的思路</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E7%9A%84%E9%A2%84%E7%83%AD"><span class="nav-number">3.1.</span> <span class="nav-text">秒杀商品的预热</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9E%AC%E6%97%B6%E9%AB%98%E5%B9%B6%E5%8F%91%E7%9A%84%E5%A4%84%E7%90%86"><span class="nav-number">3.2.</span> <span class="nav-text">瞬时高并发的处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E9%A2%84%E5%87%8F%E5%BA%93%E5%AD%98"><span class="nav-number">3.3.</span> <span class="nav-text">缓存预减库存</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%EF%BC%8C%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E9%97%AE%E9%A2%98"><span class="nav-number">3.3.1.</span> <span class="nav-text">缓存击穿，缓存穿透问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%BA%93%E5%AD%98%E9%A2%84%E5%87%8F%E6%B5%81%E7%A8%8B"><span class="nav-number">3.3.2.</span> <span class="nav-text">库存预减流程</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RabbitMQ%E5%BC%82%E6%AD%A5%E7%94%9F%E6%88%90%E8%AE%A2%E5%8D%95"><span class="nav-number">3.4.</span> <span class="nav-text">RabbitMQ异步生成订单</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E4%BF%A1%E6%81%AF%E4%B8%A2%E5%A4%B1"><span class="nav-number">3.4.1.</span> <span class="nav-text">消息队列信息丢失</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E9%87%8D%E5%A4%8D%E6%B6%88%E8%B4%B9"><span class="nav-number">3.4.2.</span> <span class="nav-text">消息队列重复消费</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A7%92%E6%9D%80%E6%A8%A1%E5%9D%97%E7%9A%84%E7%9B%B8%E5%85%B3%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.</span> <span class="nav-text">秒杀模块的相关实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A7%92%E6%9D%80%E5%95%86%E5%93%81%E7%9A%84%E9%A2%84%E7%83%AD%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.1.</span> <span class="nav-text">秒杀商品的预热实现</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A7%92%E6%9D%80%E7%9A%84%E7%9B%B8%E5%85%B3%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.2.</span> <span class="nav-text">秒杀的相关设计实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E7%A7%92%E6%9D%80%E7%9A%84%E4%BF%A1%E6%81%AF"><span class="nav-number">4.2.1.</span> <span class="nav-text">获取秒杀的信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E7%A7%92%E6%9D%80%E5%9C%B0%E5%9D%80"><span class="nav-number">4.2.2.</span> <span class="nav-text">获取秒杀地址</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E5%BD%93%E5%89%8D%E7%94%A8%E6%88%B7%E6%98%AF%E5%90%A6%E7%A7%92%E6%9D%80%E6%88%90%E5%8A%9F"><span class="nav-number">4.2.3.</span> <span class="nav-text">获取当前用户是否秒杀成功</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%A7%92%E6%9D%80%E5%8A%9F%E8%83%BD%E7%9A%84%E5%AE%9E%E7%8E%B0"><span class="nav-number">4.2.4.</span> <span class="nav-text">秒杀功能的实现</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%A4%84%E7%90%86%E8%AE%A2%E5%8D%95%E4%B8%9A%E5%8A%A1"><span class="nav-number">4.3.</span> <span class="nav-text">消息队列处理订单业务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A7%92%E6%9D%80%E7%9B%B8%E5%85%B3%E6%8E%A5%E5%8F%A3%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95"><span class="nav-number">5.</span> <span class="nav-text">秒杀相关接口压力测试</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%AE%80%E6%98%93%E6%8E%A5%E5%8F%A3%E6%B5%8B%E8%AF%95"><span class="nav-number">5.1.</span> <span class="nav-text">简易接口测试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JMeter%E8%BF%9B%E8%A1%8C%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95"><span class="nav-number">5.2.</span> <span class="nav-text">JMeter进行压力测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%E4%B8%80%EF%BC%9A"><span class="nav-number">5.2.1.</span> <span class="nav-text">压力测试一：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%E4%BA%8C"><span class="nav-number">5.2.2.</span> <span class="nav-text">压力测试二</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8E%8B%E5%8A%9B%E6%B5%8B%E8%AF%95%E4%B8%89"><span class="nav-number">5.2.3.</span> <span class="nav-text">压力测试三</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AE%B0%E5%BD%95%E5%87%BA%E7%8E%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">6.</span> <span class="nav-text">记录出现的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8SELECT-FOR-UPDATE%E6%97%B6%E5%87%BA%E7%8E%B0%E6%AD%BB%E9%94%81"><span class="nav-number">6.1.</span> <span class="nav-text">使用SELECT FOR UPDATE时出现死锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#docker%E4%B8%AD%E6%97%B6%E9%97%B4%E4%B8%8E%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%97%B6%E9%97%B4%E4%B8%8D%E4%B8%80%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">6.2.</span> <span class="nav-text">docker中时间与服务器时间不一致的问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">7.</span> <span class="nav-text">参考资料</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="喵式重战"
      src="/images/avatar.png">
  <p class="site-author-name" itemprop="name">喵式重战</p>
  <div class="site-description" itemprop="description">人的一切痛苦，本质上都是对自己无能的愤怒。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">22</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">33</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/HeavyTiger" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;HeavyTiger" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=o8fGzcTAy8bNxM7KwszjxczbzsLKz43AzM4" title="E-Mail → http:&#x2F;&#x2F;mail.qq.com&#x2F;cgi-bin&#x2F;qm_share?t&#x3D;qm_mailme&amp;email&#x3D;o8fGzcTAy8bNxM7KwszjxczbzsLKz43AzM4" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://tzhiy.github.io/" title="https:&#x2F;&#x2F;tzhiy.github.io&#x2F;" rel="noopener" target="_blank">tzhiy's Blog</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://anthonycj.github.io/" title="https:&#x2F;&#x2F;anthonycj.github.io&#x2F;" rel="noopener" target="_blank">AnthonyCJ's Blogs</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>
    

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2021 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fas fa-star fa-spin"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">喵式重战</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">676k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">10:15</span>
</div>

<!--
--><!--
<a href="https://icp.gov.moe/?keyword=20180708" rel="external nofollow noreferrer" target="_blank" data-pjax-state="" style="
    border-bottom-width: 0px;
">萌 ICP 备 20180708 号</a>
//-->

<!-- 网站运行时间的设置 -->
<span id="timeDate">载入天数...</span>
<span id="times">载入时分秒...</span>
<script>
    var now = new Date();
    function createtime() {
        var grt= new Date("6/8/2021 0:0:0");       //此处修改你的建站时间，注意格式
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "已经存活 "+dnum+" 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒了，地球太危险了，我好害怕，想回家呜呜呜( >﹏<。)";
    }
setInterval("createtime()",250);
</script>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  

  
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":false,"model":{"scale":1,"hHeadPos":0.5,"vHeadPos":0.618,"jsonPath":"/live2dw/assets/assets/z16.model.json"},"display":{"position":"right","hOffset":0,"vOffset":-20,"width":200,"height":400},"mobile":{"show":true,"scale":0.7},"react":{"opacity":0.85},"log":false});</script></body>
</html>
